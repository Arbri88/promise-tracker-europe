<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PromiseTracker</title>
    <meta name="description" content="Track political promises. See what governments actually deliver.">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-radial-gauge@1.0.0/build/Chart.RadialGauge.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', system-ui, sans-serif; }
        
        /* Dark mode styles */
        .dark { background-color: #111827; color: #f3f4f6; }
        .dark nav { background-color: #1f2937; border-color: #374151; }
        .dark footer { border-color: #374151; }
        .dark .bg-white { background-color: #0f172a !important; color: #e5e7eb !important; }
        .dark .section-card { background-color: #111827; border-color: #1f2937; }
        .dark .text-surface { color: #e5e7eb; }
        .dark .bg-gray-50 { background-color: #0b1220 !important; color: #e5e7eb !important; }
        .dark .bg-gray-100 { background-color: #111827 !important; color: #e5e7eb !important; }
        .dark .border-gray-100, .dark .border-gray-200 { border-color: #1f2937 !important; }
        .dark .text-gray-900 { color: #f9fafb !important; }
        .dark .text-gray-700 { color: #d1d5db !important; }
        .dark .text-gray-600 { color: #9ca3af !important; }
        .dark .text-gray-500 { color: #9ca3af !important; }
        .dark .text-gray-400 { color: #6b7280 !important; }
        /* Dark mode cards & surfaces */
        .dark .bg-white { background-color: #0f172a !important; color: #e5e7eb !important; }
        .dark .bg-gray-50\/60 { background-color: rgba(24,31,44,0.6) !important; }
        .dark .sentiment-card, .dark .sentiment-card-positive, .dark .sentiment-card-negative, .dark .sentiment-card-neutral { background: #111827 !important; border-color: #1f2937 !important; }
        .dark .sentiment-chip { background: #0f172a; border-color: #1e293b; color: #e2e8f0; }
        .dark .sentiment-chip .dot { opacity: 1; }
        .dark .hover\:bg-gray-50:hover { background-color: #1f2937 !important; }
        .dark .hover\:bg-gray-100:hover { background-color: #243046 !important; }
        .dark .spotlight-card { background: linear-gradient(135deg, #0f172a 0%, #1f2937 100%) !important; }
        .dark .sentiment-card, .dark .sentiment-card-positive, .dark .sentiment-card-negative, .dark .sentiment-card-neutral { background: #111827 !important; border-color: #1f2937 !important; }
        .dark input, .dark select { background-color: #1f2937 !important; border-color: #374151 !important; color: #f3f4f6 !important; }
        .dark .modal-content { background-color: #0f172a !important; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        .dark .mobile-nav-item { color: #9ca3af; }
        .dark nav.fixed.bottom-0 { background-color: #0f172a; border-color: #1f2937; }
        
        /* Mobile bottom nav safe area */
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom, 0); }
        
        /* Active mobile nav item */
        .mobile-nav-item.active { color: #111827; }
        .dark .mobile-nav-item.active { color: #f9fafb; }
        
        /* Print styles */
        @media print {
            nav, footer, .mobile-nav-item, #toast-container { display: none !important; }
            .bg-white { background: white !important; }
            body { background: white !important; color: black !Important; }
        }

        /* Print-mode toggle (manual) */
        .print-mode nav, .print-mode footer, .print-mode .mobile-nav-item, .print-mode #toast-container { display: none !important; }
        .print-mode body { background: #fff !important; color: #000 !important; }
        .print-mode .bg-white { background: #fff !important; color: #000 !important; box-shadow: none !important; border-color: #e5e7eb !important; }
        .print-mode .section-card { box-shadow: none !important; border-color: #e5e7eb !important; }
        .print-mode .chart-container, .print-mode .radar-container { display: none !important; }
        .print-mode .mobile-nav-item { display: none !important; }        
        /* Minimal scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 3px; }
        
        /* Accessible focus states */
        :focus-visible { outline: 2px solid #111827; outline-offset: 2px; border-radius: 6px; }
        .dark :focus-visible { outline-color: #fbbf24; }

        /* Lean sentiment gauge */
        .sentiment-gauge { height: 6px; border: 1px solid #e5e7eb; box-shadow: none; }
        .dark .sentiment-gauge { border-color: #374151; }
        .sentiment-needle { width: 10px; height: 10px; border-width: 2px; box-shadow: none; }

        /* Emoji buttons - lean */
        .emoji-btn { padding: 0.35rem 0.45rem; border-width: 1px; box-shadow: none; }
        .dark .emoji-btn { background: transparent; border-color: #4b5563; }

        /* Mini progress for promise cards */
        .mini-progress { height: 6px; background: #e5e7eb; border-radius: 9999px; position: relative; overflow: hidden; }
        .mini-progress-fill { position: absolute; left: 0; top: 0; bottom: 0; border-radius: 9999px; transition: width 0.2s ease; }
        .dark .mini-progress { background: #1f2937; }

        /* Sticky filters on mobile */
        @media (max-width: 640px) {
            #filters { position: sticky; top: 58px; z-index: 30; padding: 8px 0; background: #f9fafb; }
            .dark #filters { background: #0f172a; }
            .filter-btn { padding: 0.35rem 0.7rem; font-size: 0.85rem; }
        }

        /* Print-friendly tweaks */
        @media print {
            nav, footer, .mobile-nav-item, #toast-container, .chart-container, .radar-container { display: none !important; }
            .promise-row, .section-card { page-break-inside: avoid; }
            body, .bg-white { background: white !important; color: black !important; }
        }
        
        /* Subtle transitions */
        .transition-base { transition: all 0.15s ease; }
        
        /* Chart container */
        .chart-container { position: relative; height: 240px; }
        
        /* Mobile menu */
        .mobile-menu { transition: max-height 0.2s ease; overflow: hidden; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fadeIn 0.3s ease; }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .pulse { animation: pulse 2s infinite; }
        
        /* Progress ring */
        .progress-ring { transform: rotate(-90deg); transform-origin: 50% 50%; }
        
        /* Toast */
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .toast { animation: slideIn 0.2s ease; }
        
        /* Country indicator - minimalist colored bar */
        .country-indicator { width: 4px; border-radius: 2px; }
        .country-al { background: linear-gradient(180deg, #E41E20 50%, #000 50%); }
        .country-no { background: linear-gradient(180deg, #BA0C2F 0%, #BA0C2F 33%, #fff 33%, #fff 40%, #00205B 40%, #00205B 60%, #fff 60%, #fff 67%, #BA0C2F 67%); }
        
        /* Timeline */
        .timeline-track { position: relative; height: 4px; background: #e5e7eb; border-radius: 2px; }
        .timeline-progress { position: absolute; left: 0; top: 0; height: 100%; background: linear-gradient(90deg, #10b981, #3b82f6); border-radius: 2px; }
        .timeline-marker { position: absolute; top: 50%; transform: translate(-50%, -50%); width: 12px; height: 12px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.15s; }
        .timeline-marker:hover { transform: translate(-50%, -50%) scale(1.3); z-index: 10; }
        .timeline-tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); margin-bottom: 8px; padding: 6px 10px; background: #1f2937; color: #fff; font-size: 11px; border-radius: 6px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.15s; }
        .timeline-marker:hover .timeline-tooltip { opacity: 1; }
        
        /* Priority voting */
        .vote-btn { transition: all 0.15s; }
        .vote-btn:hover { transform: scale(1.05); }
        .vote-btn.voted { background: #10b981 !important; color: #fff !important; }
        
        /* Radar chart container */
        .radar-container { position: relative; height: 280px; }
        
        /* Stats counter animation */
        @keyframes countUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .stat-animate { animation: countUp 0.5s ease forwards; }
        
        /* Animated number counter */
        .counter { display: inline-block; }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .counter-bounce { animation: bounce 0.3s ease; }
        
        /* Skeleton loading */
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; }
        .dark .skeleton { background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%); background-size: 200% 100%; }
        .chart-skeleton { position: absolute; inset: 0; border-radius: 0.75rem; }
        
        /* Confetti animation */
        @keyframes confetti-fall { 0% { transform: translateY(-100%) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        .confetti { position: fixed; top: 0; width: 10px; height: 10px; animation: confetti-fall 3s ease-out forwards; pointer-events: none; z-index: 1000; }
        
        /* Promise Progress Tracker */
        .progress-tracker { display: flex; justify-content: space-between; position: relative; }
        .progress-tracker::before { content: ''; position: absolute; top: 20px; left: 0; right: 0; height: 2px; background: #e5e7eb; z-index: 0; }
        .progress-step { display: flex; flex-direction: column; align-items: center; position: relative; z-index: 1; flex: 1; }
        .progress-step-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: #e5e7eb; color: #9ca3af; font-size: 14px; transition: all 0.3s; }
        .progress-step.completed .progress-step-icon { background: #10b981; color: white; }
        .progress-step.active .progress-step-icon { background: #3b82f6; color: white; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2); }
        .progress-step.failed .progress-step-icon { background: #ef4444; color: white; }
        .progress-step-label { margin-top: 8px; font-size: 11px; color: #6b7280; text-align: center; max-width: 80px; }
        .progress-step.completed .progress-step-label, .progress-step.active .progress-step-label { color: #111827; font-weight: 500; }
        .dark .progress-tracker::before { background: #374151; }
        .dark .progress-step-icon { background: #374151; }
        .dark .progress-step-label { color: #9ca3af; }
        .dark .progress-step.completed .progress-step-label, .dark .progress-step.active .progress-step-label { color: #f3f4f6; }
        
        /* Mini status timeline */
        .mini-timeline { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; height: 6px; margin-top: 6px; }
        .mini-timeline span { display: block; height: 100%; border-radius: 999px; background: #e5e7eb; }
        .mini-timeline span.active { background: linear-gradient(90deg, #3b82f6, #10b981); }
        .mini-timeline span.broken { background: #ef4444; }
        .dark .mini-timeline span { background: #1f2937; }
        .dark .mini-timeline span.active { background: linear-gradient(90deg, #60a5fa, #34d399); }
        .dark .mini-timeline span.broken { background: #f87171; }
        
        /* Spotlight card */
        .spotlight-card { background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); }
        
        /* Tab styles */
        .tab-btn { position: relative; }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: #111827; }
        
        /* Alert badge pulse */
        @keyframes alertPulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); } }
        .alert-badge { animation: alertPulse 2s infinite; }
        
        /* Share card */
        .share-card { background: linear-gradient(135deg, #1f2937 0%, #111827 100%); }
        .share-card-preview { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4); }
        
        /* Search modal */
        .search-modal { backdrop-filter: blur(4px); }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-content { animation: modalIn 0.15s ease; }
        
        /* Badge styles */
        .achievement-badge { transition: transform 0.2s; }
        .achievement-badge:hover { transform: scale(1.1); }
        
        /* Trend line */
        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }
        .trend-neutral { color: #6b7280; }
        
        /* Urgent indicator */
        @keyframes urgentPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .urgent { animation: urgentPulse 1.5s infinite; }
        
        /* Export button */
        .export-btn:hover svg { transform: translateY(2px); }
        .export-btn svg { transition: transform 0.15s; }
        
        /* Sentiment Barometer - lean, minimal line */
        .sentiment-gauge { position: relative; height: 6px; border-radius: 999px; background: linear-gradient(90deg, #f87171 0%, #facc15 50%, #22c55e 100%); border: 1px solid #e5e7eb; }
        .dark .sentiment-gauge { background: linear-gradient(90deg, #b91c1c 0%, #ca8a04 50%, #16a34a 100%); border-color: #374151; }
        .sentiment-needle { position: absolute; top: 50%; width: 10px; height: 10px; background: #fff; border: 2px solid #0f172a; border-radius: 999px; transform: translate(-50%, -50%); transition: left 0.25s ease; box-shadow: none; }
        .dark .sentiment-needle { background: #111827; border-color: #f3f4f6; }
        .sentiment-chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 10px; border: 1px solid #e5e7eb; background: #fff; box-shadow: none; }
        .sentiment-chip .dot { width: 8px; height: 8px; border-radius: 999px; }
        .dark .sentiment-chip { background: #0f172a; border-color: #1e293b; color: #e5e7eb; }
        
        /* Emoji voting - lean and transparent */
        .emoji-btn { font-size: 1.65rem; padding: 0.35rem 0.45rem; border-radius: 10px; transition: all 0.15s ease; cursor: pointer; background: transparent; border: 1px solid #e5e7eb; box-shadow: none; }
        .emoji-btn:hover { transform: translateY(-2px); background: #f9fafb; box-shadow: none; }
        .emoji-btn.selected { background: #111827; color: #fff; border-color: #111827; box-shadow: none; }
        .emoji-btn:active { transform: translateY(0); box-shadow: none; }
        /* Dark mode emoji buttons - transparent/minimal */
        .dark .emoji-btn { background: transparent; border-color: #4b5563; color: #e5e7eb; box-shadow: none; }
        .dark .emoji-btn:hover { background: #111827; box-shadow: none; }
        .dark .emoji-btn.selected { background: #fbbf24; color: #111827; border-color: #fbbf24; box-shadow: none; }
        .dark .emoji-btn:active { transform: translateY(0); box-shadow: none; }
        
        /* Pulse animation for voting prompt */
        @keyframes gentlePulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .gentle-pulse { animation: gentlePulse 2s ease-in-out infinite; }
        
        /* Sentiment history bars */
        .sentiment-bar { height: 32px; min-width: 4px; border-radius: 2px; transition: all 0.2s; cursor: pointer; }
        .sentiment-bar:hover { opacity: 0.8; transform: scaleY(1.1); }
        
        /* Category rating stars */
        .star-btn { color: #d1d5db; transition: all 0.15s; cursor: pointer; }
        .star-btn:hover { color: #fbbf24; transform: scale(1.1); }
        .star-btn.filled { color: #fbbf24; }
        
        /* Sentiment card glow effect */
        .sentiment-card { background: #fffbe6; border: 1px solid #facc15; }
        .sentiment-card-positive { background: #f7fdf9; border-color: #c7f9d4; }
        .sentiment-card-negative { background: #fef5f5; border-color: #fcd4d4; }
        .sentiment-card-neutral { background: #f8fafc; border-color: #e2e8f0; }
        .dark .sentiment-card, .dark .sentiment-card-neutral { background: #0f172a; border-color: #1f2937; }
        .dark .sentiment-card-positive { background: #0f1a2b; border-color: #1e293b; }
        .dark .sentiment-card-negative { background: #1a0f13; border-color: #2b1a1f; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col antialiased">
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-20 right-4 z-[100] space-y-2"></div>

    <!-- Global Search Modal -->
    <div id="search-modal" class="search-modal fixed inset-0 bg-black/50 z-[200] hidden items-center justify-center p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[70vh] overflow-hidden">
            <div class="p-4 border-b border-gray-100">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    <input type="text" id="global-search-input" placeholder="Search all promises..." aria-label="Global search" class="flex-1 text-lg outline-none" autofocus>
                    <button onclick="closeSearchModal()" class="p-2 text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
            </div>
            <div id="search-results" class="overflow-y-auto max-h-[50vh] p-2">
                <div class="text-center py-8 text-gray-400 text-sm">Type to search promises, categories, or countries...</div>
            </div>
            <div class="p-3 bg-gray-50 border-t border-gray-100 flex items-center justify-between text-xs text-gray-400">
                <span>Press <kbd class="px-1.5 py-0.5 bg-gray-200 rounded text-gray-600">ESC</kbd> to close</span>
                <span>Press <kbd class="px-1.5 py-0.5 bg-gray-200 rounded text-gray-600">Enter</kbd> to select</span>
            </div>
        </div>
    </div>

    <!-- Share Card Modal -->
    <div id="share-modal" class="search-modal fixed inset-0 bg-black/50 z-[200] hidden items-center justify-center p-4">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                <h3 class="font-semibold text-gray-900">Share Promise</h3>
                <button onclick="closeShareModal()" class="p-2 text-gray-400 hover:text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="p-6">
                <div id="share-card-preview" class="share-card-preview rounded-xl overflow-hidden mb-6"></div>
                <div class="grid grid-cols-4 gap-3">
                    <button onclick="shareToTwitter()" class="flex flex-col items-center gap-2 p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-base">
                        <svg class="w-5 h-5 text-gray-700" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                        <span class="text-xs text-gray-600">Twitter</span>
                    </button>
                    <button onclick="shareToFacebook()" class="flex flex-col items-center gap-2 p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-base">
                        <svg class="w-5 h-5 text-blue-600" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                        <span class="text-xs text-gray-600">Facebook</span>
                    </button>
                    <button onclick="shareToLinkedIn()" class="flex flex-col items-center gap-2 p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-base">
                        <svg class="w-5 h-5 text-blue-700" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                        <span class="text-xs text-gray-600">LinkedIn</span>
                    </button>
                    <button onclick="copyShareLink()" class="flex flex-col items-center gap-2 p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-base">
                        <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                        <span class="text-xs text-gray-600">Copy Link</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-100 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 sm:px-6">
            <div class="flex justify-between items-center h-14">
                <a href="#/" class="text-lg font-semibold text-gray-900 hover:text-gray-600 transition-base">
                    PromiseTracker
                </a>
                
                <div class="hidden md:flex items-center gap-1">
                    <a href="#/" class="nav-link px-3 py-2 text-sm text-gray-500 hover:text-gray-900 transition-base">Home</a>
                    <a href="#/governments" class="nav-link px-3 py-2 text-sm text-gray-500 hover:text-gray-900 transition-base">Governments</a>
                    <a href="#/compare" class="nav-link px-3 py-2 text-sm text-gray-500 hover:text-gray-900 transition-base">Compare</a>
                    <a href="#/timeline" class="nav-link px-3 py-2 text-sm text-gray-500 hover:text-gray-900 transition-base">Timeline</a>
                    <a href="#/insights" class="nav-link px-3 py-2 text-sm text-gray-500 hover:text-gray-900 transition-base">Insights</a>
                    <a href="#/pulse" class="nav-link px-3 py-2 text-sm text-gray-500 hover:text-gray-900 transition-base">Citizen Pulse</a>
                </div>

                <div class="flex items-center gap-3">
                    <button onclick="openSearchModal()" class="p-2 text-gray-400 hover:text-gray-600 transition-base" title="Search (Ctrl+K)">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    </button>
                    <button onclick="toggleDarkMode()" class="p-2 text-gray-400 hover:text-gray-600 transition-base" title="Toggle dark mode" id="dark-mode-btn">
                        <svg class="w-5 h-5 dark-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                        <svg class="w-5 h-5 light-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                    </button>
                    <span class="hidden sm:flex items-center gap-2 text-xs text-gray-400">
                        <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full pulse"></span>
                        Live
                    </span>
                    <button id="mobile-menu-btn" class="md:hidden p-2 text-gray-400 hover:text-gray-600 transition-base">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div id="mobile-menu" class="mobile-menu max-h-0 md:hidden">
                <div class="py-2 border-t border-gray-100">
                    <a href="#/" class="block px-3 py-2 text-sm text-gray-600 hover:text-gray-900">Home</a>
                    <a href="#/governments" class="block px-3 py-2 text-sm text-gray-600 hover:text-gray-900">Governments</a>
                    <a href="#/compare" class="block px-3 py-2 text-sm text-gray-600 hover:text-gray-900">Compare</a>
                    <a href="#/timeline" class="block px-3 py-2 text-sm text-gray-600 hover:text-gray-900">Timeline</a>
                    <a href="#/insights" class="block px-3 py-2 text-sm text-gray-600 hover:text-gray-900">Insights</a>
                    <a href="#/pulse" class="block px-3 py-2 text-sm text-gray-600 hover:text-gray-900">Citizen Pulse</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="app" class="flex-1"></main>

    <!-- Mobile Bottom Navigation -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50 safe-area-bottom">
        <div class="flex justify-around items-center h-16">
            <a href="#/" class="mobile-nav-item flex flex-col items-center gap-1 p-2 text-gray-400 hover:text-gray-900 transition-base">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                <span class="text-xs">Home</span>
            </a>
            <a href="#/governments" class="mobile-nav-item flex flex-col items-center gap-1 p-2 text-gray-400 hover:text-gray-900 transition-base">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                <span class="text-xs">Govs</span>
            </a>
            <a href="#/pulse" class="mobile-nav-item flex flex-col items-center gap-1 p-2 relative">
                <div class="w-12 h-12 -mt-6 bg-gradient-to-br from-yellow-600 to-amber-700 rounded-full flex items-center justify-center shadow-lg">
                    <span class="text-xl">üó≥Ô∏è</span>
                </div>
                <span class="text-xs text-gray-500 -mt-1">Pulse</span>
            </a>
            <a href="#/insights" class="mobile-nav-item flex flex-col items-center gap-1 p-2 text-gray-400 hover:text-gray-900 transition-base">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                <span class="text-xs">Insights</span>
            </a>
            <a href="#/compare" class="mobile-nav-item flex flex-col items-center gap-1 p-2 text-gray-400 hover:text-gray-900 transition-base">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7"/></svg>
                <span class="text-xs">Compare</span>
            </a>
        </div>
    </nav>

    <!-- Footer -->
    <footer class="border-t border-gray-100 mt-auto pb-20 md:pb-0">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 py-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <div class="font-semibold text-gray-900 mb-1">PromiseTracker</div>
                    <p class="text-sm text-gray-500">Tracking political promises with transparency.</p>
                </div>
                <div class="flex gap-6 text-sm text-gray-400">
                    <a href="#/about" class="hover:text-gray-600 transition-base">About</a>
                    <a href="#/methodology" class="hover:text-gray-600 transition-base">Methodology</a>
                    <a href="#/contact" class="hover:text-gray-600 transition-base">Contact</a>
                </div>
            </div>
            <div class="mt-6 pt-6 border-t border-gray-100 text-xs text-gray-400">
                ¬© 2024 PromiseTracker
            </div>
        </div>
    </footer>

    <script>
    // ============================================================================
    // DARK MODE
    // ============================================================================

    function toggleDarkMode() {
        const body = document.body;
        const isDark = body.classList.toggle('dark');
        localStorage.setItem('darkMode', isDark ? 'true' : 'false');
        updateDarkModeIcon();
    }

    function updateDarkModeIcon() {
        const isDark = document.body.classList.contains('dark');
        document.querySelectorAll('.dark-icon').forEach(el => el.classList.toggle('hidden', !isDark));
        document.querySelectorAll('.light-icon').forEach(el => el.classList.toggle('hidden', isDark));
    }

    function initDarkMode() {
        const savedMode = localStorage.getItem('darkMode');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedMode === 'true' || (savedMode === null && prefersDark)) {
            document.body.classList.add('dark');
        }
        updateDarkModeIcon();
    }

    // Initialize dark mode on load
    initDarkMode();

    // ============================================================================
    // ANIMATED COUNTERS
    // ============================================================================

    function animateCounter(element, target, duration = 1000) {
        const start = 0;
        const startTime = performance.now();
        
        function update(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const easeOut = 1 - Math.pow(1 - progress, 3);
            const current = Math.round(start + (target - start) * easeOut);
            
            element.textContent = current + (element.dataset.suffix || '');
            
            if (progress < 1) {
                requestAnimationFrame(update);
            } else {
                element.classList.add('counter-bounce');
                setTimeout(() => element.classList.remove('counter-bounce'), 300);
            }
        }
        
        requestAnimationFrame(update);
    }

    function initCounters() {
        const counters = document.querySelectorAll('[data-counter]');
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && !entry.target.dataset.animated) {
                    entry.target.dataset.animated = 'true';
                    const target = parseInt(entry.target.dataset.counter);
                    animateCounter(entry.target, target);
                }
            });
        }, { threshold: 0.5 });
        
        counters.forEach(counter => observer.observe(counter));
    }

    // ============================================================================
    // CONFETTI CELEBRATION
    // ============================================================================

    function showConfetti() {
        const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ec4899', '#8b5cf6'];
        const confettiCount = 50;
        
        for (let i = 0; i < confettiCount; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDelay = Math.random() * 2 + 's';
            confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
            document.body.appendChild(confetti);
            
            setTimeout(() => confetti.remove(), 5000);
        }
    }

    // Show confetti when a promise is marked as KEPT
    function celebrateKeptPromise() {
        showConfetti();
        showToast('üéâ Promise Kept! Celebrating government accountability!');
    }

    // ============================================================================
    // PROMISE PROGRESS TRACKER
    // ============================================================================

    function renderProgressTracker(status) {
        const steps = [
            { id: 'announced', label: 'Announced', icon: 'üì¢' },
            { id: 'started', label: 'Started', icon: 'üöÄ' },
            { id: 'progress', label: 'In Progress', icon: '‚öôÔ∏è' },
            { id: 'review', label: 'Under Review', icon: 'üîç' },
            { id: 'completed', label: 'Completed', icon: '‚úÖ' }
        ];
        
        // Map status to step
        const statusMap = {
            'NOT_STARTED': 0,
            'IN_THE_WORKS': 2,
            'STALLED': 2,
            'COMPROMISE': 4,
            'KEPT': 4,
            'BROKEN': -1
        };
        
        const currentStep = statusMap[status] ?? 0;
        const isBroken = status === 'BROKEN';
        
        return `
        <div class="progress-tracker mb-6">
            ${steps.map((step, i) => {
                let stepClass = '';
                if (isBroken && i === 4) {
                    stepClass = 'failed';
                } else if (i < currentStep) {
                    stepClass = 'completed';
                } else if (i === currentStep) {
                    stepClass = isBroken ? 'failed' : 'active';
                }
                return `
                <div class="progress-step ${stepClass}">
                    <div class="progress-step-icon">${isBroken && i === 4 ? '‚ùå' : step.icon}</div>
                    <div class="progress-step-label">${step.label}</div>
                </div>`;
            }).join('')}
        </div>`;
    }

    // ============================================================================
    // DATA
    // ============================================================================

    const ActorType = { GOVERNMENT: 'GOVERNMENT' };
    const PromiseStatus = { NOT_STARTED: 'NOT_STARTED', IN_THE_WORKS: 'IN_THE_WORKS', STALLED: 'STALLED', COMPROMISE: 'COMPROMISE', KEPT: 'KEPT', BROKEN: 'BROKEN' };
    const PromiseCategory = { ECONOMY: 'ECONOMY', HEALTH: 'HEALTH', EDUCATION: 'EDUCATION', INFRASTRUCTURE: 'INFRASTRUCTURE', ENVIRONMENT: 'ENVIRONMENT', GOVERNANCE: 'GOVERNANCE', SOCIAL: 'SOCIAL', OTHER: 'OTHER' };

    const actors = [
        // Albania - Current Term (2025-2029)
        {
            id: 'actor-albania-gov-2025',
            name: 'Government of Albania',
            slug: 'albania',
            termSlug: '2025-2029',
            type: ActorType.GOVERNMENT,
            country: 'Albania',
            countryCode: 'AL',
            description: 'Tracking promises from the 2025 parliamentary elections. The Socialist Party secured their fourth consecutive term.',
            termStart: new Date('2025-05-11'),
            termEnd: new Date('2029-05-11'),
            leader: 'Edi Rama',
            leaderTitle: 'Prime Minister',
            party: 'Socialist Party (PS)',
            seats: '74/140',
            coalitionType: 'Majority Government',
            electionDate: new Date('2025-05-11'),
            isCurrent: true,
            updatedAt: new Date()
        },
        // Albania - Previous Term (2021-2025)
        {
            id: 'actor-albania-gov-2021',
            name: 'Government of Albania',
            slug: 'albania',
            termSlug: '2021-2025',
            type: ActorType.GOVERNMENT,
            country: 'Albania',
            countryCode: 'AL',
            description: 'Third consecutive term for the Socialist Party. Focus on EU integration, infrastructure, and post-earthquake reconstruction.',
            termStart: new Date('2021-09-18'),
            termEnd: new Date('2025-05-11'),
            leader: 'Edi Rama',
            leaderTitle: 'Prime Minister',
            party: 'Socialist Party (PS)',
            seats: '74/140',
            coalitionType: 'Majority Government',
            electionDate: new Date('2021-04-25'),
            isCurrent: false,
            updatedAt: new Date()
        },
        // Norway - Current Term (2025-2029)
        {
            id: 'actor-norway-gov-2025',
            name: 'Government of Norway',
            slug: 'norway',
            termSlug: '2025-2029',
            type: ActorType.GOVERNMENT,
            country: 'Norway',
            countryCode: 'NO',
            description: 'Tracking promises from the 2025 parliamentary elections (Stortingsvalget). Coalition government based on the new government platform.',
            termStart: new Date('2025-10-01'),
            termEnd: new Date('2029-09-30'),
            leader: 'Jonas Gahr St√∏re',
            leaderTitle: 'Prime Minister',
            party: 'Labour Party (Ap)',
            seats: '48/169',
            coalitionType: 'Minority Coalition',
            coalitionPartners: ['Centre Party (Sp)'],
            electionDate: new Date('2025-09-08'),
            isCurrent: true,
            updatedAt: new Date()
        },
        // Norway - Previous Term (2021-2025)
        {
            id: 'actor-norway-gov-2021',
            name: 'Government of Norway',
            slug: 'norway',
            termSlug: '2021-2025',
            type: ActorType.GOVERNMENT,
            country: 'Norway',
            countryCode: 'NO',
            description: 'First St√∏re government. Minority coalition focusing on reducing inequality, climate action, and strengthening rural Norway.',
            termStart: new Date('2021-10-14'),
            termEnd: new Date('2025-10-01'),
            leader: 'Jonas Gahr St√∏re',
            leaderTitle: 'Prime Minister',
            party: 'Labour Party (Ap)',
            seats: '48/169',
            coalitionType: 'Minority Coalition',
            coalitionPartners: ['Centre Party (Sp)'],
            electionDate: new Date('2021-09-13'),
            isCurrent: false,
            updatedAt: new Date()
        }
    ];

    // Note: Additional countries can be added later. For now we keep only tracked terms (Albania & Norway).

    // Albania 2025-2029 Promises (Current Term)
    const albaniaPromises2025 = [
        { id: 'al25-1', title: 'Increase minimum wage to 50,000 ALL', fullText: 'Raise the minimum wage to 50,000 Albanian Lek per month within the first year of the mandate.', actorId: 'actor-albania-gov-2025', country: 'Albania', category: PromiseCategory.ECONOMY, timeline: 'By May 2026', status: PromiseStatus.NOT_STARTED, sourceType: 'Electoral Program 2025', importance: 'high', updatedAt: new Date('2025-05-15') },
        { id: 'al25-2', title: 'Build 5 new regional hospitals', fullText: 'Construction of 5 new modern regional hospitals in Kuk√´s, Dib√´r, P√´rmet, Has, and Tropoj√´.', actorId: 'actor-albania-gov-2025', country: 'Albania', category: PromiseCategory.HEALTH, timeline: 'By 2029', status: PromiseStatus.NOT_STARTED, sourceType: 'Electoral Program 2025', importance: 'high', updatedAt: new Date('2025-05-15') },
        { id: 'al25-3', title: 'Free laptops for all high school students', fullText: 'Provide free laptops to all public high school students to enhance digital education.', actorId: 'actor-albania-gov-2025', country: 'Albania', category: PromiseCategory.EDUCATION, timeline: 'By September 2026', status: PromiseStatus.NOT_STARTED, sourceType: 'Electoral Program 2025', importance: 'medium', updatedAt: new Date('2025-05-15') },
        { id: 'al25-4', title: 'Complete Tirana-Rinas-Durr√´s rail link', fullText: 'Complete the modern rail connection between Tirana, Rinas Airport, and Durr√´s port.', actorId: 'actor-albania-gov-2025', country: 'Albania', category: PromiseCategory.INFRASTRUCTURE, timeline: 'By 2028', status: PromiseStatus.NOT_STARTED, sourceType: 'Infrastructure Plan', importance: 'high', updatedAt: new Date('2025-05-15') },
        { id: 'al25-5', title: 'Achieve 100% renewable energy', fullText: 'Reach 100% renewable electricity generation, building on existing hydropower with new solar and wind capacity.', actorId: 'actor-albania-gov-2025', country: 'Albania', category: PromiseCategory.ENVIRONMENT, timeline: 'By 2029', status: PromiseStatus.NOT_STARTED, sourceType: 'Green Albania 2030', importance: 'high', updatedAt: new Date('2025-05-15') },
        { id: 'al25-6', title: 'Launch Digital ID for all citizens', fullText: 'Implement a unified Digital ID system for all Albanian citizens to access government services.', actorId: 'actor-albania-gov-2025', country: 'Albania', category: PromiseCategory.GOVERNANCE, timeline: 'By 2027', status: PromiseStatus.NOT_STARTED, sourceType: 'Digital Agenda 2025', importance: 'high', updatedAt: new Date('2025-05-15') },
        { id: 'al25-7', title: 'Create 150,000 new jobs', fullText: 'Create 150,000 new jobs through investment incentives, tourism growth, and IT sector development.', actorId: 'actor-albania-gov-2025', country: 'Albania', category: PromiseCategory.ECONOMY, timeline: 'By 2029', status: PromiseStatus.NOT_STARTED, sourceType: 'Electoral Program 2025', importance: 'high', updatedAt: new Date('2025-05-15') },
        { id: 'al25-8', title: 'Complete EU accession negotiations', fullText: 'Advance and aim to complete all EU accession negotiation chapters by end of term.', actorId: 'actor-albania-gov-2025', country: 'Albania', category: PromiseCategory.GOVERNANCE, timeline: 'By 2029', status: PromiseStatus.NOT_STARTED, sourceType: 'Government Program', importance: 'high', updatedAt: new Date('2025-05-15') },
        { id: 'al25-9', title: 'Universal health insurance coverage', fullText: 'Extend mandatory health insurance coverage to 100% of the population including informal workers.', actorId: 'actor-albania-gov-2025', country: 'Albania', category: PromiseCategory.HEALTH, timeline: 'By 2027', status: PromiseStatus.NOT_STARTED, sourceType: 'Health Reform Plan', importance: 'high', updatedAt: new Date('2025-05-15') },
        { id: 'al25-10', title: 'Double foreign direct investment', fullText: 'Double annual foreign direct investment from ‚Ç¨1.3B to ‚Ç¨2.6B through improved business climate.', actorId: 'actor-albania-gov-2025', country: 'Albania', category: PromiseCategory.ECONOMY, timeline: 'By 2029', status: PromiseStatus.NOT_STARTED, sourceType: 'Economic Strategy 2025-2029', importance: 'high', updatedAt: new Date('2025-05-15') },
    ];

    // Albania 2021-2025 Promises (Previous Term - Completed)
    const albaniaPromises2021 = [
        { id: 'al21-1', title: 'Rebuild 100% of earthquake-damaged homes', fullText: 'Complete reconstruction of all homes damaged by the November 2019 earthquake in affected areas.', actorId: 'actor-albania-gov-2021', country: 'Albania', category: PromiseCategory.INFRASTRUCTURE, timeline: 'By 2024', status: PromiseStatus.KEPT, sourceType: 'Government Program 2021', importance: 'high', updatedAt: new Date('2024-12-15') },
        { id: 'al21-2', title: 'Increase minimum wage to 40,000 ALL', fullText: 'Raise minimum wage from 30,000 to 40,000 Albanian Lek per month.', actorId: 'actor-albania-gov-2021', country: 'Albania', category: PromiseCategory.ECONOMY, timeline: 'By 2023', status: PromiseStatus.KEPT, sourceType: 'Electoral Program 2021', importance: 'high', updatedAt: new Date('2023-04-01') },
        { id: 'al21-3', title: 'Open EU accession negotiations', fullText: 'Begin formal EU membership negotiations during this term.', actorId: 'actor-albania-gov-2021', country: 'Albania', category: PromiseCategory.GOVERNANCE, timeline: 'By 2022', status: PromiseStatus.KEPT, sourceType: 'Government Program 2021', importance: 'high', updatedAt: new Date('2022-07-19') },
        { id: 'al21-4', title: 'Complete Arb√´r Highway', fullText: 'Finish construction of the Arb√´r Highway connecting Tirana to North Macedonia border.', actorId: 'actor-albania-gov-2021', country: 'Albania', category: PromiseCategory.INFRASTRUCTURE, timeline: 'By 2024', status: PromiseStatus.COMPROMISE, sourceType: 'Infrastructure Plan 2021', importance: 'high', updatedAt: new Date('2024-09-01') },
        { id: 'al21-5', title: 'Achieve 5% GDP growth annually', fullText: 'Maintain annual GDP growth of at least 5% throughout the term.', actorId: 'actor-albania-gov-2021', country: 'Albania', category: PromiseCategory.ECONOMY, timeline: 'Annual', status: PromiseStatus.COMPROMISE, sourceType: 'Economic Plan 2021', importance: 'high', updatedAt: new Date('2025-01-15') },
        { id: 'al21-6', title: 'Reduce corruption perception index', fullText: 'Improve Albania\'s Transparency International ranking by at least 10 positions.', actorId: 'actor-albania-gov-2021', country: 'Albania', category: PromiseCategory.GOVERNANCE, timeline: 'By 2025', status: PromiseStatus.BROKEN, sourceType: 'Anti-Corruption Strategy', importance: 'high', updatedAt: new Date('2025-01-20') },
        { id: 'al21-7', title: 'Build new Tirana airport terminal', fullText: 'Complete construction of new international terminal at Rinas Airport.', actorId: 'actor-albania-gov-2021', country: 'Albania', category: PromiseCategory.INFRASTRUCTURE, timeline: 'By 2024', status: PromiseStatus.IN_THE_WORKS, sourceType: 'Infrastructure Plan 2021', importance: 'medium', updatedAt: new Date('2024-11-01') },
        { id: 'al21-8', title: 'Free healthcare for children under 6', fullText: 'Provide completely free healthcare services for all children under 6 years old.', actorId: 'actor-albania-gov-2021', country: 'Albania', category: PromiseCategory.HEALTH, timeline: 'By 2023', status: PromiseStatus.KEPT, sourceType: 'Health Reform 2021', importance: 'high', updatedAt: new Date('2023-06-01') },
        { id: 'al21-9', title: 'Create 120,000 new jobs', fullText: 'Create at least 120,000 new jobs through economic development programs.', actorId: 'actor-albania-gov-2021', country: 'Albania', category: PromiseCategory.ECONOMY, timeline: 'By 2025', status: PromiseStatus.COMPROMISE, sourceType: 'Electoral Program 2021', importance: 'high', updatedAt: new Date('2025-03-01') },
        { id: 'al21-10', title: 'Digitize 95% of government services', fullText: 'Make 95% of government services available online through e-Albania platform.', actorId: 'actor-albania-gov-2021', country: 'Albania', category: PromiseCategory.GOVERNANCE, timeline: 'By 2025', status: PromiseStatus.KEPT, sourceType: 'Digital Agenda 2021', importance: 'high', updatedAt: new Date('2024-12-01') },
    ];

    // Norway 2025-2029 Promises (Current Term)
    const norwayPromises2025 = [
        { id: 'no25-1', title: 'Cut emissions by 55% by 2030', fullText: 'Reduce greenhouse gas emissions by at least 55% by 2030 compared to 1990 levels, as committed under the Paris Agreement.', actorId: 'actor-norway-gov-2025', country: 'Norway', category: PromiseCategory.ENVIRONMENT, timeline: 'By 2030', status: PromiseStatus.NOT_STARTED, sourceType: 'Government Platform 2025', importance: 'high', updatedAt: new Date('2025-10-01') },
        { id: 'no25-2', title: 'Reverse tax cuts for high incomes', fullText: 'Increase taxes on high incomes and wealth to fund welfare services and reduce inequality.', actorId: 'actor-norway-gov-2025', country: 'Norway', category: PromiseCategory.ECONOMY, timeline: 'Budget 2026', status: PromiseStatus.NOT_STARTED, sourceType: 'Government Platform 2025', importance: 'high', updatedAt: new Date('2025-10-01') },
        { id: 'no25-3', title: 'Hire 3,000 more healthcare workers', fullText: 'Recruit 3,000 additional nurses, doctors, and healthcare professionals to reduce waiting times.', actorId: 'actor-norway-gov-2025', country: 'Norway', category: PromiseCategory.HEALTH, timeline: 'By 2029', status: PromiseStatus.NOT_STARTED, sourceType: 'Government Platform 2025', importance: 'high', updatedAt: new Date('2025-10-01') },
        { id: 'no25-4', title: 'Expand rural broadband to 100%', fullText: 'Achieve 100% high-speed broadband coverage in all rural municipalities.', actorId: 'actor-norway-gov-2025', country: 'Norway', category: PromiseCategory.INFRASTRUCTURE, timeline: 'By 2027', status: PromiseStatus.NOT_STARTED, sourceType: 'Digital Norway 2025', importance: 'medium', updatedAt: new Date('2025-10-01') },
        { id: 'no25-5', title: 'Implement free school meals nationwide', fullText: 'Roll out free, healthy school meals to all primary and lower secondary students across Norway.', actorId: 'actor-norway-gov-2025', country: 'Norway', category: PromiseCategory.EDUCATION, timeline: 'By 2027', status: PromiseStatus.NOT_STARTED, sourceType: 'Government Platform 2025', importance: 'high', updatedAt: new Date('2025-10-01') },
        { id: 'no25-6', title: 'Reopen 20 local police stations', fullText: 'Reverse police reform by reopening at least 20 local police stations in rural areas.', actorId: 'actor-norway-gov-2025', country: 'Norway', category: PromiseCategory.GOVERNANCE, timeline: 'By 2028', status: PromiseStatus.NOT_STARTED, sourceType: 'Government Platform 2025', importance: 'medium', updatedAt: new Date('2025-10-01') },
        { id: 'no25-7', title: 'All ferries zero-emission by 2027', fullText: 'Require all public ferry contracts to mandate zero-emission vessels by 2027.', actorId: 'actor-norway-gov-2025', country: 'Norway', category: PromiseCategory.ENVIRONMENT, timeline: 'By 2027', status: PromiseStatus.NOT_STARTED, sourceType: 'Green Shipping Plan', importance: 'high', updatedAt: new Date('2025-10-01') },
        { id: 'no25-8', title: 'Convert 50% of student loans to grants', fullText: 'Increase the grant portion of student financial support from 40% to 50% of total support.', actorId: 'actor-norway-gov-2025', country: 'Norway', category: PromiseCategory.EDUCATION, timeline: 'By 2027', status: PromiseStatus.NOT_STARTED, sourceType: 'Government Platform 2025', importance: 'medium', updatedAt: new Date('2025-10-01') },
        { id: 'no25-9', title: 'Create 100,000 green jobs', fullText: 'Create 100,000 new jobs in renewable energy, battery production, hydrogen, and maritime technology.', actorId: 'actor-norway-gov-2025', country: 'Norway', category: PromiseCategory.ECONOMY, timeline: 'By 2029', status: PromiseStatus.NOT_STARTED, sourceType: 'Green Industrial Plan', importance: 'high', updatedAt: new Date('2025-10-01') },
        { id: 'no25-10', title: 'Build 1,000 new nursing home places', fullText: 'Fund construction of 1,000 new nursing home places to reduce waiting lists for elderly care.', actorId: 'actor-norway-gov-2025', country: 'Norway', category: PromiseCategory.HEALTH, timeline: 'By 2029', status: PromiseStatus.NOT_STARTED, sourceType: 'Care Plan 2025', importance: 'high', updatedAt: new Date('2025-10-01') },
    ];

    // Norway 2021-2025 Promises (Previous Term - Completed)
    const norwayPromises2021 = [
        { id: 'no21-1', title: 'Reverse tax cuts for high incomes', fullText: 'Reverse the tax cuts implemented by the previous conservative government for high-income earners.', actorId: 'actor-norway-gov-2021', country: 'Norway', category: PromiseCategory.ECONOMY, timeline: 'Budget 2022', status: PromiseStatus.KEPT, sourceType: 'Hurdalsplattformen', importance: 'high', updatedAt: new Date('2022-11-01') },
        { id: 'no21-2', title: 'Stop oil exploration in new areas', fullText: 'Halt new oil exploration licenses in previously unexplored Arctic areas.', actorId: 'actor-norway-gov-2021', country: 'Norway', category: PromiseCategory.ENVIRONMENT, timeline: 'Immediate', status: PromiseStatus.BROKEN, sourceType: 'Hurdalsplattformen', importance: 'high', updatedAt: new Date('2023-06-15') },
        { id: 'no21-3', title: 'Reduce child poverty by 25%', fullText: 'Implement measures to reduce child poverty by 25% during the term.', actorId: 'actor-norway-gov-2021', country: 'Norway', category: PromiseCategory.SOCIAL, timeline: 'By 2025', status: PromiseStatus.COMPROMISE, sourceType: 'Hurdalsplattformen', importance: 'high', updatedAt: new Date('2025-02-01') },
        { id: 'no21-4', title: 'Free dental care for ages 19-21', fullText: 'Extend free dental care to cover all Norwegians aged 19 to 21.', actorId: 'actor-norway-gov-2021', country: 'Norway', category: PromiseCategory.HEALTH, timeline: 'By 2023', status: PromiseStatus.KEPT, sourceType: 'Hurdalsplattformen', importance: 'medium', updatedAt: new Date('2023-01-01') },
        { id: 'no21-5', title: 'Strengthen district policy', fullText: 'Reverse centralization by moving government jobs to rural areas and increasing support for districts.', actorId: 'actor-norway-gov-2021', country: 'Norway', category: PromiseCategory.GOVERNANCE, timeline: 'Ongoing', status: PromiseStatus.IN_THE_WORKS, sourceType: 'Hurdalsplattformen', importance: 'high', updatedAt: new Date('2024-08-01') },
        { id: 'no21-6', title: 'Reduce ferry prices by 50%', fullText: 'Cut ferry prices by 50% on all domestic routes to reduce transport costs.', actorId: 'actor-norway-gov-2021', country: 'Norway', category: PromiseCategory.INFRASTRUCTURE, timeline: 'By 2023', status: PromiseStatus.COMPROMISE, sourceType: 'Hurdalsplattformen', importance: 'medium', updatedAt: new Date('2023-07-01') },
        { id: 'no21-7', title: 'Increase teacher salaries', fullText: 'Raise teacher salaries significantly to attract more people to the profession.', actorId: 'actor-norway-gov-2021', country: 'Norway', category: PromiseCategory.EDUCATION, timeline: 'By 2024', status: PromiseStatus.STALLED, sourceType: 'Hurdalsplattformen', importance: 'high', updatedAt: new Date('2024-09-01') },
        { id: 'no21-8', title: 'Build 1,000 new student housing units', fullText: 'Fund construction of 1,000 new student housing units annually.', actorId: 'actor-norway-gov-2021', country: 'Norway', category: PromiseCategory.EDUCATION, timeline: 'Annual', status: PromiseStatus.KEPT, sourceType: 'Budget 2022', importance: 'medium', updatedAt: new Date('2024-06-01') },
        { id: 'no21-9', title: 'Salmon tax for aquaculture industry', fullText: 'Introduce a resource rent tax (salmon tax) on the aquaculture industry.', actorId: 'actor-norway-gov-2021', country: 'Norway', category: PromiseCategory.ECONOMY, timeline: 'By 2023', status: PromiseStatus.KEPT, sourceType: 'Budget 2023', importance: 'high', updatedAt: new Date('2023-06-01') },
        { id: 'no21-10', title: 'Cut emissions 55% by 2030', fullText: 'Reduce Norwegian greenhouse gas emissions by at least 55% by 2030 compared to 1990 levels.', actorId: 'actor-norway-gov-2021', country: 'Norway', category: PromiseCategory.ENVIRONMENT, timeline: 'By 2030', status: PromiseStatus.IN_THE_WORKS, sourceType: 'Climate Plan', importance: 'high', updatedAt: new Date('2024-12-01') },
    ];

    // Keep only the defined countries' promises for stability
    const promises = [...albaniaPromises2025, ...albaniaPromises2021, ...norwayPromises2025, ...norwayPromises2021];

    // News sources configuration by country - All European countries
    const newsSources = {
        // ===== SOUTHERN EUROPE =====
        'Albania': [
            { name: 'Top Channel', url: 'https://top-channel.tv', searchUrl: 'https://top-channel.tv/search/?q=', icon: 'üì∫', type: 'TV' },
            { name: 'Balkanweb', url: 'https://balkanweb.com', searchUrl: 'https://balkanweb.com/?s=', icon: 'üåê', type: 'News' },
            { name: 'Euronews Albania', url: 'https://euronews.al', searchUrl: 'https://euronews.al/?s=', icon: 'üá™üá∫', type: 'News' },
            { name: 'Reporter.al', url: 'https://reporter.al', searchUrl: 'https://reporter.al/?s=', icon: 'üì∞', type: 'Investigative' },
            { name: 'Exit News', url: 'https://exit.al', searchUrl: 'https://exit.al/?s=', icon: 'üîç', type: 'Analysis' }
        ],
        'Andorra': [
            { name: 'Diari d\'Andorra', url: 'https://www.diariandorra.ad', searchUrl: 'https://www.diariandorra.ad/?s=', icon: 'üì∞', type: 'Daily' },
            { name: 'ATV', url: 'https://www.andorratv.ad', searchUrl: 'https://www.andorratv.ad/?s=', icon: 'üì∫', type: 'TV' },
            { name: 'Bondia', url: 'https://www.bondia.ad', searchUrl: 'https://www.bondia.ad/?s=', icon: 'üì∞', type: 'News' }
        ],
        'Bosnia and Herzegovina': [
            { name: 'Klix.ba', url: 'https://www.klix.ba', searchUrl: 'https://www.klix.ba/search?q=', icon: 'üåê', type: 'Portal' },
            { name: 'N1 BiH', url: 'https://n1info.ba', searchUrl: 'https://n1info.ba/pretraga/?q=', icon: 'üì∫', type: 'TV' },
            { name: 'Osloboƒëenje', url: 'https://www.oslobodjenje.ba', searchUrl: 'https://www.oslobodjenje.ba/?s=', icon: 'üì∞', type: 'Daily' },
            { name: 'Dnevni Avaz', url: 'https://avaz.ba', searchUrl: 'https://avaz.ba/?s=', icon: 'üì∞', type: 'Daily' },
            { name: 'Al Jazeera Balkans', url: 'https://balkans.aljazeera.net', searchUrl: 'https://balkans.aljazeera.net/search?q=', icon: 'üåç', type: 'International' }
        ],
        'Croatia': [
            { name: 'HRT', url: 'https://www.hrt.hr', searchUrl: 'https://www.hrt.hr/trazi/?q=', icon: 'üì∫', type: 'Public TV' },
            { name: 'Jutarnji List', url: 'https://www.jutarnji.hr', searchUrl: 'https://www.jutarnji.hr/trazi?query=', icon: 'üì∞', type: 'Daily' },
            { name: 'Veƒçernji List', url: 'https://www.vecernji.hr', searchUrl: 'https://www.vecernji.hr/trazi?query=', icon: 'üì∞', type: 'Daily' },
            { name: 'Index.hr', url: 'https://www.index.hr', searchUrl: 'https://www.index.hr/trazi.aspx?q=', icon: 'üåê', type: 'Portal' },
            { name: 'N1 Croatia', url: 'https://n1info.hr', searchUrl: 'https://n1info.hr/pretraga/?q=', icon: 'üì∫', type: 'TV' }
        ],
        'Cyprus': [
            { name: 'Cyprus Mail', url: 'https://cyprus-mail.com', searchUrl: 'https://cyprus-mail.com/?s=', icon: 'üì∞', type: 'English' },
            { name: 'Phileleftheros', url: 'https://www.philenews.com', searchUrl: 'https://www.philenews.com/search/?q=', icon: 'üì∞', type: 'Greek' },
            { name: 'Sigma TV', url: 'https://www.sigmalive.com', searchUrl: 'https://www.sigmalive.com/search?q=', icon: 'üì∫', type: 'TV' },
            { name: 'CNA', url: 'https://cna.org.cy', searchUrl: 'https://cna.org.cy/?s=', icon: 'üì∞', type: 'Agency' }
        ],
        'Greece': [
            { name: 'ERT', url: 'https://www.ert.gr', searchUrl: 'https://www.ert.gr/search/?q=', icon: 'üì∫', type: 'Public TV' },
            { name: 'Kathimerini', url: 'https://www.kathimerini.gr', searchUrl: 'https://www.kathimerini.gr/search/?q=', icon: 'üì∞', type: 'Broadsheet' },
            { name: 'Ta Nea', url: 'https://www.tanea.gr', searchUrl: 'https://www.tanea.gr/search/?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'Proto Thema', url: 'https://www.protothema.gr', searchUrl: 'https://www.protothema.gr/search/?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'Ekathimerini', url: 'https://www.ekathimerini.com', searchUrl: 'https://www.ekathimerini.com/search/?q=', icon: 'üì∞', type: 'English' }
        ],
        'Italy': [
            { name: 'RAI', url: 'https://www.rai.it', searchUrl: 'https://www.rai.it/ricerca.html?q=', icon: 'üì∫', type: 'Public TV' },
            { name: 'Corriere della Sera', url: 'https://www.corriere.it', searchUrl: 'https://www.corriere.it/ricerca/?q=', icon: 'üì∞', type: 'Broadsheet' },
            { name: 'La Repubblica', url: 'https://www.repubblica.it', searchUrl: 'https://ricerca.repubblica.it/ricerca/repubblica?query=', icon: 'üì∞', type: 'Daily' },
            { name: 'La Stampa', url: 'https://www.lastampa.it', searchUrl: 'https://www.lastampa.it/ricerca?query=', icon: 'üì∞', type: 'Daily' },
            { name: 'ANSA', url: 'https://www.ansa.it', searchUrl: 'https://www.ansa.it/ricerca/ansait/search.shtml?q=', icon: 'üì∞', type: 'Agency' },
            { name: 'Il Sole 24 Ore', url: 'https://www.ilsole24ore.com', searchUrl: 'https://www.ilsole24ore.com/ricerca?q=', icon: 'üí∞', type: 'Business' }
        ],
        'Kosovo': [
            { name: 'RTK', url: 'https://www.rtklive.com', searchUrl: 'https://www.rtklive.com/?s=', icon: 'üì∫', type: 'Public TV' },
            { name: 'Koha Ditore', url: 'https://www.koha.net', searchUrl: 'https://www.koha.net/?s=', icon: 'üì∞', type: 'Daily' },
            { name: 'Gazeta Express', url: 'https://www.gazetaexpress.com', searchUrl: 'https://www.gazetaexpress.com/?s=', icon: 'üì∞', type: 'Daily' },
            { name: 'Kallxo', url: 'https://kallxo.com', searchUrl: 'https://kallxo.com/?s=', icon: 'üîç', type: 'Investigative' },
            { name: 'Prishtina Insight', url: 'https://prishtinainsight.com', searchUrl: 'https://prishtinainsight.com/?s=', icon: 'üì∞', type: 'English' }
        ],
        'Malta': [
            { name: 'Times of Malta', url: 'https://timesofmalta.com', searchUrl: 'https://timesofmalta.com/search?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'Malta Today', url: 'https://www.maltatoday.com.mt', searchUrl: 'https://www.maltatoday.com.mt/search?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'TVM', url: 'https://www.tvm.com.mt', searchUrl: 'https://www.tvm.com.mt/en/?s=', icon: 'üì∫', type: 'Public TV' },
            { name: 'The Shift', url: 'https://theshiftnews.com', searchUrl: 'https://theshiftnews.com/?s=', icon: 'üîç', type: 'Investigative' }
        ],
        'Montenegro': [
            { name: 'RTCG', url: 'https://www.rtcg.me', searchUrl: 'https://www.rtcg.me/pretraga.html?q=', icon: 'üì∫', type: 'Public TV' },
            { name: 'Vijesti', url: 'https://www.vijesti.me', searchUrl: 'https://www.vijesti.me/pretraga?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'Dan', url: 'https://www.dan.co.me', searchUrl: 'https://www.dan.co.me/?s=', icon: 'üì∞', type: 'Daily' },
            { name: 'CDM', url: 'https://www.cdm.me', searchUrl: 'https://www.cdm.me/?s=', icon: 'üåê', type: 'Portal' }
        ],
        'North Macedonia': [
            { name: 'MRT', url: 'https://www.mkrtv.mk', searchUrl: 'https://www.mkrtv.mk/?s=', icon: 'üì∫', type: 'Public TV' },
            { name: 'MKD.mk', url: 'https://www.mkd.mk', searchUrl: 'https://www.mkd.mk/?s=', icon: 'üåê', type: 'Portal' },
            { name: 'Sloboden Pechat', url: 'https://www.slobodenpecat.mk', searchUrl: 'https://www.slobodenpecat.mk/?s=', icon: 'üì∞', type: 'Daily' },
            { name: 'Meta.mk', url: 'https://meta.mk', searchUrl: 'https://meta.mk/?s=', icon: 'üîç', type: 'Analysis' },
            { name: 'SDK.mk', url: 'https://sdk.mk', searchUrl: 'https://sdk.mk/?s=', icon: 'üì∞', type: 'News' }
        ],
        'Portugal': [
            { name: 'RTP', url: 'https://www.rtp.pt', searchUrl: 'https://www.rtp.pt/pesquisa?q=', icon: 'üì∫', type: 'Public TV' },
            { name: 'P√∫blico', url: 'https://www.publico.pt', searchUrl: 'https://www.publico.pt/pesquisa?q=', icon: 'üì∞', type: 'Broadsheet' },
            { name: 'Observador', url: 'https://observador.pt', searchUrl: 'https://observador.pt/pesquisa/?s=', icon: 'üì∞', type: 'Daily' },
            { name: 'Expresso', url: 'https://expresso.pt', searchUrl: 'https://expresso.pt/pesquisa?q=', icon: 'üì∞', type: 'Weekly' },
            { name: 'Jornal de Not√≠cias', url: 'https://www.jn.pt', searchUrl: 'https://www.jn.pt/pesquisa?q=', icon: 'üì∞', type: 'Daily' }
        ],
        'San Marino': [
            { name: 'San Marino RTV', url: 'https://www.sanmarinortv.sm', searchUrl: 'https://www.sanmarinortv.sm/?s=', icon: 'üì∫', type: 'Public TV' },
            { name: 'Tribuna Politica', url: 'https://www.tribunapoliticaweb.sm', searchUrl: 'https://www.tribunapoliticaweb.sm/?s=', icon: 'üì∞', type: 'News' }
        ],
        'Serbia': [
            { name: 'RTS', url: 'https://www.rts.rs', searchUrl: 'https://www.rts.rs/search?q=', icon: 'üì∫', type: 'Public TV' },
            { name: 'N1 Serbia', url: 'https://n1info.rs', searchUrl: 'https://n1info.rs/pretraga/?q=', icon: 'üì∫', type: 'TV' },
            { name: 'Blic', url: 'https://www.blic.rs', searchUrl: 'https://www.blic.rs/search?q=', icon: 'üì∞', type: 'Tabloid' },
            { name: 'Danas', url: 'https://www.danas.rs', searchUrl: 'https://www.danas.rs/?s=', icon: 'üì∞', type: 'Daily' },
            { name: 'BIRN Serbia', url: 'https://birn.rs', searchUrl: 'https://birn.rs/?s=', icon: 'üîç', type: 'Investigative' }
        ],
        'Slovenia': [
            { name: 'RTV Slovenija', url: 'https://www.rtvslo.si', searchUrl: 'https://www.rtvslo.si/iskalnik?q=', icon: 'üì∫', type: 'Public TV' },
            { name: 'Delo', url: 'https://www.delo.si', searchUrl: 'https://www.delo.si/iskanje?q=', icon: 'üì∞', type: 'Broadsheet' },
            { name: 'Dnevnik', url: 'https://www.dnevnik.si', searchUrl: 'https://www.dnevnik.si/isci?q=', icon: 'üì∞', type: 'Daily' },
            { name: '24ur', url: 'https://www.24ur.com', searchUrl: 'https://www.24ur.com/iskalnik?q=', icon: 'üåê', type: 'Portal' },
            { name: 'Mladina', url: 'https://www.mladina.si', searchUrl: 'https://www.mladina.si/iskanje?q=', icon: 'üì∞', type: 'Weekly' }
        ],
        'Spain': [
            { name: 'RTVE', url: 'https://www.rtve.es', searchUrl: 'https://www.rtve.es/buscador/?q=', icon: 'üì∫', type: 'Public TV' },
            { name: 'El Pa√≠s', url: 'https://elpais.com', searchUrl: 'https://elpais.com/buscador/?qt=', icon: 'üì∞', type: 'Broadsheet' },
            { name: 'El Mundo', url: 'https://www.elmundo.es', searchUrl: 'https://ariadna.elmundo.es/buscador/archivo.html?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'La Vanguardia', url: 'https://www.lavanguardia.com', searchUrl: 'https://www.lavanguardia.com/buscar?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'El Confidencial', url: 'https://www.elconfidencial.com', searchUrl: 'https://www.elconfidencial.com/buscador/?q=', icon: 'üì∞', type: 'Digital' },
            { name: 'EFE', url: 'https://www.efe.com', searchUrl: 'https://www.efe.com/buscador/?q=', icon: 'üì∞', type: 'Agency' }
        ],
        
        // ===== WESTERN EUROPE =====
        'Austria': [
            { name: 'ORF', url: 'https://orf.at', searchUrl: 'https://orf.at/suche/?q=', icon: 'üì∫', type: 'Public TV' },
            { name: 'Der Standard', url: 'https://www.derstandard.at', searchUrl: 'https://www.derstandard.at/suche?q=', icon: 'üì∞', type: 'Broadsheet' },
            { name: 'Die Presse', url: 'https://www.diepresse.com', searchUrl: 'https://www.diepresse.com/suche?q=', icon: 'üì∞', type: 'Broadsheet' },
            { name: 'Kurier', url: 'https://kurier.at', searchUrl: 'https://kurier.at/suche?q=', icon: 'üì∞', type: 'Tabloid' },
            { name: 'Wiener Zeitung', url: 'https://www.wienerzeitung.at', searchUrl: 'https://www.wienerzeitung.at/suche/?q=', icon: 'üì∞', type: 'Official' }
        ],
        'Belgium': [
            { name: 'VRT', url: 'https://www.vrt.be', searchUrl: 'https://www.vrt.be/vrtnws/nl/zoeken/?q=', icon: 'üì∫', type: 'Public TV (Dutch)' },
            { name: 'RTBF', url: 'https://www.rtbf.be', searchUrl: 'https://www.rtbf.be/en-continu/recherche?q=', icon: 'üì∫', type: 'Public TV (French)' },
            { name: 'De Standaard', url: 'https://www.standaard.be', searchUrl: 'https://www.standaard.be/zoeken?keyword=', icon: 'üì∞', type: 'Dutch Daily' },
            { name: 'Le Soir', url: 'https://www.lesoir.be', searchUrl: 'https://www.lesoir.be/recherche?q=', icon: 'üì∞', type: 'French Daily' },
            { name: 'De Morgen', url: 'https://www.demorgen.be', searchUrl: 'https://www.demorgen.be/zoeken?keyword=', icon: 'üì∞', type: 'Dutch Daily' }
        ],
        'France': [
            { name: 'France T√©l√©visions', url: 'https://www.france.tv', searchUrl: 'https://www.france.tv/recherche/?q=', icon: 'üì∫', type: 'Public TV' },
            { name: 'Le Monde', url: 'https://www.lemonde.fr', searchUrl: 'https://www.lemonde.fr/recherche/?search_keywords=', icon: 'üì∞', type: 'Broadsheet' },
            { name: 'Le Figaro', url: 'https://www.lefigaro.fr', searchUrl: 'https://recherche.lefigaro.fr/recherche/?q=', icon: 'üì∞', type: 'Conservative' },
            { name: 'Lib√©ration', url: 'https://www.liberation.fr', searchUrl: 'https://www.liberation.fr/recherche/?q=', icon: 'üì∞', type: 'Left-leaning' },
            { name: 'France 24', url: 'https://www.france24.com', searchUrl: 'https://www.france24.com/en/search?q=', icon: 'üåç', type: 'International' },
            { name: 'AFP', url: 'https://www.afp.com', searchUrl: 'https://www.afp.com/en/search?q=', icon: 'üì∞', type: 'Agency' }
        ],
        'Germany': [
            { name: 'ARD', url: 'https://www.ard.de', searchUrl: 'https://www.ard.de/suche?q=', icon: 'üì∫', type: 'Public TV' },
            { name: 'ZDF', url: 'https://www.zdf.de', searchUrl: 'https://www.zdf.de/suche?q=', icon: 'üì∫', type: 'Public TV' },
            { name: 'Der Spiegel', url: 'https://www.spiegel.de', searchUrl: 'https://www.spiegel.de/suche/?suchbegriff=', icon: 'üì∞', type: 'Magazine' },
            { name: 'S√ºddeutsche Zeitung', url: 'https://www.sueddeutsche.de', searchUrl: 'https://www.sueddeutsche.de/suche?search=', icon: 'üì∞', type: 'Broadsheet' },
            { name: 'FAZ', url: 'https://www.faz.net', searchUrl: 'https://www.faz.net/suche/?q=', icon: 'üì∞', type: 'Broadsheet' },
            { name: 'Die Zeit', url: 'https://www.zeit.de', searchUrl: 'https://www.zeit.de/suche/?q=', icon: 'üì∞', type: 'Weekly' },
            { name: 'DW', url: 'https://www.dw.com', searchUrl: 'https://www.dw.com/search/?searchNavigationId=9077&languageCode=en&item=', icon: 'üåç', type: 'International' }
        ],
        'Ireland': [
            { name: 'RT√â', url: 'https://www.rte.ie', searchUrl: 'https://www.rte.ie/search/?q=', icon: 'üì∫', type: 'Public TV' },
            { name: 'Irish Times', url: 'https://www.irishtimes.com', searchUrl: 'https://www.irishtimes.com/search?q=', icon: 'üì∞', type: 'Broadsheet' },
            { name: 'Irish Independent', url: 'https://www.independent.ie', searchUrl: 'https://www.independent.ie/search/?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'The Journal', url: 'https://www.thejournal.ie', searchUrl: 'https://www.thejournal.ie/search/?q=', icon: 'üåê', type: 'Digital' },
            { name: 'Irish Examiner', url: 'https://www.irishexaminer.com', searchUrl: 'https://www.irishexaminer.com/search/?q=', icon: 'üì∞', type: 'Daily' }
        ],
        'Liechtenstein': [
            { name: 'Liechtensteiner Vaterland', url: 'https://www.vaterland.li', searchUrl: 'https://www.vaterland.li/suche?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'Liechtensteiner Volksblatt', url: 'https://www.volksblatt.li', searchUrl: 'https://www.volksblatt.li/?s=', icon: 'üì∞', type: 'Daily' }
        ],
        'Luxembourg': [
            { name: 'RTL Luxembourg', url: 'https://www.rtl.lu', searchUrl: 'https://www.rtl.lu/recherche?q=', icon: 'üì∫', type: 'TV' },
            { name: 'Luxemburger Wort', url: 'https://www.wort.lu', searchUrl: 'https://www.wort.lu/de/search?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'Tageblatt', url: 'https://www.tageblatt.lu', searchUrl: 'https://www.tageblatt.lu/suche/?q=', icon: 'üì∞', type: 'Daily' },
            { name: "L'Essentiel", url: 'https://www.lessentiel.lu', searchUrl: 'https://www.lessentiel.lu/fr/search?q=', icon: 'üì∞', type: 'Free Daily' }
        ],
        'Monaco': [
            { name: 'Monaco Matin', url: 'https://www.monacomatin.mc', searchUrl: 'https://www.monacomatin.mc/?s=', icon: 'üì∞', type: 'Daily' },
            { name: 'Monaco Tribune', url: 'https://www.monaco-tribune.com', searchUrl: 'https://www.monaco-tribune.com/?s=', icon: 'üì∞', type: 'News' },
            { name: 'Monte Carlo TMC', url: 'https://www.tmc.tv', searchUrl: 'https://www.tmc.tv/recherche?q=', icon: 'üì∫', type: 'TV' }
        ],
        'Netherlands': [
            { name: 'NOS', url: 'https://nos.nl', searchUrl: 'https://nos.nl/zoeken?q=', icon: 'üì∫', type: 'Public TV' },
            { name: 'De Volkskrant', url: 'https://www.volkskrant.nl', searchUrl: 'https://www.volkskrant.nl/search?query=', icon: 'üì∞', type: 'Broadsheet' },
            { name: 'NRC', url: 'https://www.nrc.nl', searchUrl: 'https://www.nrc.nl/search/?q=', icon: 'üì∞', type: 'Broadsheet' },
            { name: 'De Telegraaf', url: 'https://www.telegraaf.nl', searchUrl: 'https://www.telegraaf.nl/search?query=', icon: 'üì∞', type: 'Tabloid' },
            { name: 'Trouw', url: 'https://www.trouw.nl', searchUrl: 'https://www.trouw.nl/search?query=', icon: 'üì∞', type: 'Daily' },
            { name: 'RTL Nieuws', url: 'https://www.rtlnieuws.nl', searchUrl: 'https://www.rtlnieuws.nl/zoeken?search=', icon: 'üì∫', type: 'Commercial TV' }
        ],
        'Switzerland': [
            { name: 'SRF', url: 'https://www.srf.ch', searchUrl: 'https://www.srf.ch/suche?q=', icon: 'üì∫', type: 'German Public' },
            { name: 'RTS', url: 'https://www.rts.ch', searchUrl: 'https://www.rts.ch/recherche?q=', icon: 'üì∫', type: 'French Public' },
            { name: 'NZZ', url: 'https://www.nzz.ch', searchUrl: 'https://www.nzz.ch/suche?q=', icon: 'üì∞', type: 'German Broadsheet' },
            { name: 'Tages-Anzeiger', url: 'https://www.tagesanzeiger.ch', searchUrl: 'https://www.tagesanzeiger.ch/suche?q=', icon: 'üì∞', type: 'German Daily' },
            { name: 'Le Temps', url: 'https://www.letemps.ch', searchUrl: 'https://www.letemps.ch/recherche?q=', icon: 'üì∞', type: 'French Daily' },
            { name: 'Swissinfo', url: 'https://www.swissinfo.ch', searchUrl: 'https://www.swissinfo.ch/eng/search?q=', icon: 'üåç', type: 'International' }
        ],
        'United Kingdom': [
            { name: 'BBC', url: 'https://www.bbc.co.uk', searchUrl: 'https://www.bbc.co.uk/search?q=', icon: 'üì∫', type: 'Public' },
            { name: 'The Guardian', url: 'https://www.theguardian.com', searchUrl: 'https://www.theguardian.com/search?q=', icon: 'üì∞', type: 'Left-leaning' },
            { name: 'The Times', url: 'https://www.thetimes.co.uk', searchUrl: 'https://www.thetimes.co.uk/search?q=', icon: 'üì∞', type: 'Broadsheet' },
            { name: 'The Telegraph', url: 'https://www.telegraph.co.uk', searchUrl: 'https://www.telegraph.co.uk/search?q=', icon: 'üì∞', type: 'Conservative' },
            { name: 'Financial Times', url: 'https://www.ft.com', searchUrl: 'https://www.ft.com/search?q=', icon: 'üí∞', type: 'Business' },
            { name: 'Sky News', url: 'https://news.sky.com', searchUrl: 'https://news.sky.com/search?q=', icon: 'üì∫', type: 'TV' },
            { name: 'The Independent', url: 'https://www.independent.co.uk', searchUrl: 'https://www.independent.co.uk/search?q=', icon: 'üì∞', type: 'Digital' }
        ],
        
        // ===== NORTHERN EUROPE =====
        'Denmark': [
            { name: 'DR', url: 'https://www.dr.dk', searchUrl: 'https://www.dr.dk/soeg?query=', icon: 'üì∫', type: 'Public TV' },
            { name: 'Politiken', url: 'https://politiken.dk', searchUrl: 'https://politiken.dk/search?q=', icon: 'üì∞', type: 'Broadsheet' },
            { name: 'Berlingske', url: 'https://www.berlingske.dk', searchUrl: 'https://www.berlingske.dk/search?q=', icon: 'üì∞', type: 'Broadsheet' },
            { name: 'Jyllands-Posten', url: 'https://jyllands-posten.dk', searchUrl: 'https://jyllands-posten.dk/search?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'TV2 Denmark', url: 'https://nyheder.tv2.dk', searchUrl: 'https://nyheder.tv2.dk/soeg?query=', icon: 'üì∫', type: 'Commercial TV' }
        ],
        'Estonia': [
            { name: 'ERR', url: 'https://www.err.ee', searchUrl: 'https://www.err.ee/search?q=', icon: 'üì∫', type: 'Public' },
            { name: 'Postimees', url: 'https://www.postimees.ee', searchUrl: 'https://www.postimees.ee/search?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'Delfi', url: 'https://www.delfi.ee', searchUrl: 'https://www.delfi.ee/otsing?q=', icon: 'üåê', type: 'Portal' },
            { name: 'Eesti P√§evaleht', url: 'https://epl.delfi.ee', searchUrl: 'https://epl.delfi.ee/otsing?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'ERR News', url: 'https://news.err.ee', searchUrl: 'https://news.err.ee/search?q=', icon: 'üì∞', type: 'English' }
        ],
        'Finland': [
            { name: 'Yle', url: 'https://yle.fi', searchUrl: 'https://yle.fi/haku?q=', icon: 'üì∫', type: 'Public' },
            { name: 'Helsingin Sanomat', url: 'https://www.hs.fi', searchUrl: 'https://www.hs.fi/haku/?query=', icon: 'üì∞', type: 'Broadsheet' },
            { name: 'Ilta-Sanomat', url: 'https://www.is.fi', searchUrl: 'https://www.is.fi/haku/?query=', icon: 'üì∞', type: 'Tabloid' },
            { name: 'Iltalehti', url: 'https://www.iltalehti.fi', searchUrl: 'https://www.iltalehti.fi/haku?q=', icon: 'üì∞', type: 'Tabloid' },
            { name: 'Yle News', url: 'https://yle.fi/news', searchUrl: 'https://yle.fi/news/search?q=', icon: 'üì∞', type: 'English' }
        ],
        'Iceland': [
            { name: 'R√öV', url: 'https://www.ruv.is', searchUrl: 'https://www.ruv.is/leit?q=', icon: 'üì∫', type: 'Public' },
            { name: 'Morgunbla√∞i√∞', url: 'https://www.mbl.is', searchUrl: 'https://www.mbl.is/leit/?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'V√≠sir', url: 'https://www.visir.is', searchUrl: 'https://www.visir.is/leit?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'Iceland Review', url: 'https://www.icelandreview.com', searchUrl: 'https://www.icelandreview.com/?s=', icon: 'üì∞', type: 'English' },
            { name: 'Stundin', url: 'https://stundin.is', searchUrl: 'https://stundin.is/?s=', icon: 'üîç', type: 'Investigative' }
        ],
        'Latvia': [
            { name: 'LSM', url: 'https://www.lsm.lv', searchUrl: 'https://www.lsm.lv/meklet?q=', icon: 'üì∫', type: 'Public' },
            { name: 'Delfi Latvia', url: 'https://www.delfi.lv', searchUrl: 'https://www.delfi.lv/meklet?q=', icon: 'üåê', type: 'Portal' },
            { name: 'Diena', url: 'https://www.diena.lv', searchUrl: 'https://www.diena.lv/meklet?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'Latvijas Avƒ´ze', url: 'https://www.la.lv', searchUrl: 'https://www.la.lv/?s=', icon: 'üì∞', type: 'Daily' },
            { name: 'Re:Baltica', url: 'https://rebaltica.lv', searchUrl: 'https://rebaltica.lv/?s=', icon: 'üîç', type: 'Investigative' }
        ],
        'Lithuania': [
            { name: 'LRT', url: 'https://www.lrt.lt', searchUrl: 'https://www.lrt.lt/paieska?q=', icon: 'üì∫', type: 'Public' },
            { name: 'Delfi Lithuania', url: 'https://www.delfi.lt', searchUrl: 'https://www.delfi.lt/paieska?q=', icon: 'üåê', type: 'Portal' },
            { name: '15min', url: 'https://www.15min.lt', searchUrl: 'https://www.15min.lt/paieska?q=', icon: 'üåê', type: 'Portal' },
            { name: 'Lietuvos Rytas', url: 'https://www.lrytas.lt', searchUrl: 'https://www.lrytas.lt/paieska?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'LRT English', url: 'https://www.lrt.lt/en', searchUrl: 'https://www.lrt.lt/en/search?q=', icon: 'üì∞', type: 'English' }
        ],
        'Norway': [
            { name: 'NRK', url: 'https://nrk.no', searchUrl: 'https://www.nrk.no/sok/?q=', icon: 'üì∫', type: 'Public TV' },
            { name: 'VG', url: 'https://vg.no', searchUrl: 'https://www.vg.no/spesial/soek/?q=', icon: 'üì∞', type: 'Tabloid' },
            { name: 'Aftenposten', url: 'https://aftenposten.no', searchUrl: 'https://www.aftenposten.no/sok?query=', icon: 'üì∞', type: 'Broadsheet' },
            { name: 'Dagbladet', url: 'https://dagbladet.no', searchUrl: 'https://www.dagbladet.no/sok?q=', icon: 'üì∞', type: 'Tabloid' },
            { name: 'E24', url: 'https://e24.no', searchUrl: 'https://e24.no/sok?q=', icon: 'üí∞', type: 'Business' }
        ],
        'Sweden': [
            { name: 'SVT', url: 'https://www.svt.se', searchUrl: 'https://www.svt.se/sok?q=', icon: 'üì∫', type: 'Public TV' },
            { name: 'Dagens Nyheter', url: 'https://www.dn.se', searchUrl: 'https://www.dn.se/sok/?q=', icon: 'üì∞', type: 'Broadsheet' },
            { name: 'Svenska Dagbladet', url: 'https://www.svd.se', searchUrl: 'https://www.svd.se/sok?q=', icon: 'üì∞', type: 'Broadsheet' },
            { name: 'Aftonbladet', url: 'https://www.aftonbladet.se', searchUrl: 'https://www.aftonbladet.se/sok?q=', icon: 'üì∞', type: 'Tabloid' },
            { name: 'Expressen', url: 'https://www.expressen.se', searchUrl: 'https://www.expressen.se/sok/?q=', icon: 'üì∞', type: 'Tabloid' },
            { name: 'Sveriges Radio', url: 'https://sverigesradio.se', searchUrl: 'https://sverigesradio.se/sok?q=', icon: 'üìª', type: 'Public Radio' }
        ],
        
        // ===== EASTERN EUROPE =====
        'Belarus': [
            { name: 'BelTA', url: 'https://www.belta.by', searchUrl: 'https://www.belta.by/search/?q=', icon: 'üì∞', type: 'State Agency' },
            { name: 'Nasha Niva', url: 'https://nashaniva.com', searchUrl: 'https://nashaniva.com/?s=', icon: 'üì∞', type: 'Independent' },
            { name: 'Zerkalo.io', url: 'https://news.zerkalo.io', searchUrl: 'https://news.zerkalo.io/?s=', icon: 'üåê', type: 'Independent' },
            { name: 'NEXTA', url: 'https://nexta.media', searchUrl: 'https://nexta.media/?s=', icon: 'üì∞', type: 'Independent' },
            { name: 'Belsat', url: 'https://belsat.eu', searchUrl: 'https://belsat.eu/?s=', icon: 'üì∫', type: 'Independent TV' }
        ],
        'Bulgaria': [
            { name: 'BNT', url: 'https://bnt.bg', searchUrl: 'https://bnt.bg/search?q=', icon: 'üì∫', type: 'Public TV' },
            { name: 'bTV', url: 'https://btvnovinite.bg', searchUrl: 'https://btvnovinite.bg/search?q=', icon: 'üì∫', type: 'Commercial TV' },
            { name: 'Dnevnik', url: 'https://www.dnevnik.bg', searchUrl: 'https://www.dnevnik.bg/search?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'Capital', url: 'https://www.capital.bg', searchUrl: 'https://www.capital.bg/search?q=', icon: 'üí∞', type: 'Business' },
            { name: 'Mediapool', url: 'https://www.mediapool.bg', searchUrl: 'https://www.mediapool.bg/?s=', icon: 'üåê', type: 'Portal' }
        ],
        'Czech Republic': [
            { name: 'ƒåT', url: 'https://www.ceskatelevize.cz', searchUrl: 'https://www.ceskatelevize.cz/hledani/?q=', icon: 'üì∫', type: 'Public TV' },
            { name: 'iDNES', url: 'https://www.idnes.cz', searchUrl: 'https://www.idnes.cz/zpravy/hledej.aspx?q=', icon: 'üåê', type: 'Portal' },
            { name: 'Novinky', url: 'https://www.novinky.cz', searchUrl: 'https://www.novinky.cz/hledej?q=', icon: 'üåê', type: 'Portal' },
            { name: 'Hospod√°≈ôsk√© noviny', url: 'https://ihned.cz', searchUrl: 'https://ihned.cz/?m=search&q=', icon: 'üí∞', type: 'Business' },
            { name: 'Respekt', url: 'https://www.respekt.cz', searchUrl: 'https://www.respekt.cz/hledani?q=', icon: 'üì∞', type: 'Weekly' },
            { name: 'Radio Prague', url: 'https://english.radio.cz', searchUrl: 'https://english.radio.cz/search?q=', icon: 'üìª', type: 'English' }
        ],
        'Hungary': [
            { name: 'MTVA', url: 'https://www.mediaklikk.hu', searchUrl: 'https://www.mediaklikk.hu/kereses?q=', icon: 'üì∫', type: 'Public' },
            { name: 'HVG', url: 'https://hvg.hu', searchUrl: 'https://hvg.hu/kereses?q=', icon: 'üì∞', type: 'Weekly' },
            { name: '24.hu', url: 'https://24.hu', searchUrl: 'https://24.hu/kereses/?q=', icon: 'üåê', type: 'Portal' },
            { name: 'Index', url: 'https://index.hu', searchUrl: 'https://index.hu/kereses?q=', icon: 'üåê', type: 'Portal' },
            { name: 'Telex', url: 'https://telex.hu', searchUrl: 'https://telex.hu/kereses?q=', icon: 'üì∞', type: 'Independent' },
            { name: '444', url: 'https://444.hu', searchUrl: 'https://444.hu/kereses?q=', icon: 'üì∞', type: 'Independent' }
        ],
        'Moldova': [
            { name: 'Moldova 1', url: 'https://www.trm.md', searchUrl: 'https://www.trm.md/ro/search?q=', icon: 'üì∫', type: 'Public TV' },
            { name: 'Ziarul de GardƒÉ', url: 'https://www.zdg.md', searchUrl: 'https://www.zdg.md/?s=', icon: 'üì∞', type: 'Investigative' },
            { name: 'Deschide.md', url: 'https://deschide.md', searchUrl: 'https://deschide.md/?s=', icon: 'üåê', type: 'Portal' },
            { name: 'NewsMaker', url: 'https://newsmaker.md', searchUrl: 'https://newsmaker.md/?s=', icon: 'üì∞', type: 'News' },
            { name: 'IPN', url: 'https://www.ipn.md', searchUrl: 'https://www.ipn.md/en/search?q=', icon: 'üì∞', type: 'Agency' }
        ],
        'Poland': [
            { name: 'TVP', url: 'https://www.tvp.pl', searchUrl: 'https://www.tvp.pl/szukaj?query=', icon: 'üì∫', type: 'Public TV' },
            { name: 'TVN24', url: 'https://tvn24.pl', searchUrl: 'https://tvn24.pl/szukaj?q=', icon: 'üì∫', type: 'Commercial TV' },
            { name: 'Gazeta Wyborcza', url: 'https://wyborcza.pl', searchUrl: 'https://szukaj.wyborcza.pl/szukaj?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'Rzeczpospolita', url: 'https://www.rp.pl', searchUrl: 'https://www.rp.pl/szukaj?q=', icon: 'üì∞', type: 'Broadsheet' },
            { name: 'Onet', url: 'https://www.onet.pl', searchUrl: 'https://www.onet.pl/szukaj?query=', icon: 'üåê', type: 'Portal' },
            { name: 'Polskie Radio', url: 'https://www.polskieradio.pl', searchUrl: 'https://www.polskieradio.pl/szukaj?q=', icon: 'üìª', type: 'Public Radio' }
        ],
        'Romania': [
            { name: 'TVR', url: 'https://www.tvr.ro', searchUrl: 'https://www.tvr.ro/cauta?q=', icon: 'üì∫', type: 'Public TV' },
            { name: 'Digi24', url: 'https://www.digi24.ro', searchUrl: 'https://www.digi24.ro/cautare?q=', icon: 'üì∫', type: 'TV' },
            { name: 'AdevƒÉrul', url: 'https://adevarul.ro', searchUrl: 'https://adevarul.ro/cauta?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'HotNews', url: 'https://www.hotnews.ro', searchUrl: 'https://www.hotnews.ro/cauta?q=', icon: 'üåê', type: 'Portal' },
            { name: 'G4Media', url: 'https://www.g4media.ro', searchUrl: 'https://www.g4media.ro/?s=', icon: 'üì∞', type: 'Independent' },
            { name: 'Libertatea', url: 'https://www.libertatea.ro', searchUrl: 'https://www.libertatea.ro/?s=', icon: 'üì∞', type: 'Tabloid' }
        ],
        'Russia': [
            { name: 'Meduza', url: 'https://meduza.io', searchUrl: 'https://meduza.io/search?q=', icon: 'üì∞', type: 'Independent (Exiled)' },
            { name: 'Novaya Gazeta', url: 'https://novayagazeta.eu', searchUrl: 'https://novayagazeta.eu/search?q=', icon: 'üì∞', type: 'Independent (Exiled)' },
            { name: 'The Moscow Times', url: 'https://www.themoscowtimes.com', searchUrl: 'https://www.themoscowtimes.com/search?q=', icon: 'üì∞', type: 'English' },
            { name: 'Mediazona', url: 'https://zona.media', searchUrl: 'https://zona.media/?s=', icon: 'üîç', type: 'Investigative' },
            { name: 'Important Stories', url: 'https://istories.media', searchUrl: 'https://istories.media/?s=', icon: 'üîç', type: 'Investigative' }
        ],
        'Slovakia': [
            { name: 'RTVS', url: 'https://www.rtvs.sk', searchUrl: 'https://www.rtvs.sk/hladaj?q=', icon: 'üì∫', type: 'Public' },
            { name: 'SME', url: 'https://www.sme.sk', searchUrl: 'https://www.sme.sk/hladaj?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'Denn√≠k N', url: 'https://dennikn.sk', searchUrl: 'https://dennikn.sk/hladaj/?q=', icon: 'üì∞', type: 'Independent' },
            { name: 'Aktuality', url: 'https://www.aktuality.sk', searchUrl: 'https://www.aktuality.sk/hladanie/?q=', icon: 'üåê', type: 'Portal' },
            { name: 'Pravda', url: 'https://www.pravda.sk', searchUrl: 'https://www.pravda.sk/hladaj?q=', icon: 'üì∞', type: 'Daily' }
        ],
        'Ukraine': [
            { name: 'Suspilne', url: 'https://suspilne.media', searchUrl: 'https://suspilne.media/search/?q=', icon: 'üì∫', type: 'Public' },
            { name: 'Ukrainska Pravda', url: 'https://www.pravda.com.ua', searchUrl: 'https://www.pravda.com.ua/search/?q=', icon: 'üì∞', type: 'Independent' },
            { name: 'Hromadske', url: 'https://hromadske.ua', searchUrl: 'https://hromadske.ua/search?q=', icon: 'üì∫', type: 'Independent' },
            { name: 'Dzerkalo Tyzhnya', url: 'https://zn.ua', searchUrl: 'https://zn.ua/ukr/search?q=', icon: 'üì∞', type: 'Weekly' },
            { name: 'LB.ua', url: 'https://lb.ua', searchUrl: 'https://lb.ua/search?q=', icon: 'üåê', type: 'Portal' },
            { name: 'Kyiv Independent', url: 'https://kyivindependent.com', searchUrl: 'https://kyivindependent.com/?s=', icon: 'üì∞', type: 'English' }
        ],
        
        // ===== TRANSCONTINENTAL =====
        'Turkey': [
            { name: 'TRT', url: 'https://www.trt.net.tr', searchUrl: 'https://www.trt.net.tr/arama?q=', icon: 'üì∫', type: 'Public TV' },
            { name: 'H√ºrriyet', url: 'https://www.hurriyet.com.tr', searchUrl: 'https://www.hurriyet.com.tr/arama/?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'Cumhuriyet', url: 'https://www.cumhuriyet.com.tr', searchUrl: 'https://www.cumhuriyet.com.tr/arama?q=', icon: 'üì∞', type: 'Daily' },
            { name: 'T24', url: 'https://t24.com.tr', searchUrl: 'https://t24.com.tr/arama?q=', icon: 'üåê', type: 'Portal' },
            { name: 'Bianet', url: 'https://bianet.org', searchUrl: 'https://bianet.org/search?q=', icon: 'üì∞', type: 'Independent' },
            { name: 'Daily Sabah', url: 'https://www.dailysabah.com', searchUrl: 'https://www.dailysabah.com/search?query=', icon: 'üì∞', type: 'English' }
        ],
        
        // ===== PAN-EUROPEAN =====
        'European Union': [
            { name: 'Euronews', url: 'https://www.euronews.com', searchUrl: 'https://www.euronews.com/search?query=', icon: 'üì∫', type: 'Pan-European' },
            { name: 'Politico Europe', url: 'https://www.politico.eu', searchUrl: 'https://www.politico.eu/search/?s=', icon: 'üì∞', type: 'EU Politics' },
            { name: 'EUobserver', url: 'https://euobserver.com', searchUrl: 'https://euobserver.com/search?q=', icon: 'üì∞', type: 'EU Affairs' },
            { name: 'Euractiv', url: 'https://www.euractiv.com', searchUrl: 'https://www.euractiv.com/search/?q=', icon: 'üì∞', type: 'EU Policy' },
            { name: 'European Newsroom', url: 'https://www.europeannewsroom.com', searchUrl: 'https://www.europeannewsroom.com/?s=', icon: 'üì∞', type: 'Collaborative' },
            { name: 'BIRN', url: 'https://balkaninsight.com', searchUrl: 'https://balkaninsight.com/?s=', icon: 'üîç', type: 'Balkans Investigative' }
        ]
    };

    // Related news articles (manually curated - can be updated)
    const newsArticles = [
        // Albania articles
        { id: 'news-al-1', promiseId: 'al25-1', source: 'Top Channel', title: 'Qeveria premton rritjen e pag√´s minimale n√´ 50,000 lek√´', url: 'https://top-channel.tv', date: new Date('2025-05-12'), language: 'sq' },
        { id: 'news-al-2', promiseId: 'al25-8', source: 'Euronews Albania', title: 'Negociatat me BE, Rama: Do t√´ p√´rmbyllim t√´ gjitha kapitujt', url: 'https://euronews.al', date: new Date('2025-05-18'), language: 'sq' },
        { id: 'news-al-3', promiseId: 'al21-3', source: 'Exit News', title: 'Albania Opens EU Accession Negotiations', url: 'https://exit.al', date: new Date('2022-07-19'), language: 'en' },
        { id: 'news-al-4', promiseId: 'al21-1', source: 'Reporter.al', title: 'Rind√´rtimi pas t√´rmetit: 100% e familjeve t√´ strehuara', url: 'https://reporter.al', date: new Date('2024-11-26'), language: 'sq' },
        // Norway articles
        { id: 'news-no-1', promiseId: 'no25-1', source: 'NRK', title: 'Regjeringen lover 55% kutt i utslipp innen 2030', url: 'https://nrk.no', date: new Date('2025-10-02'), language: 'no' },
        { id: 'news-no-2', promiseId: 'no25-5', source: 'VG', title: 'Gratis skolemat til alle elever - slik blir ordningen', url: 'https://vg.no', date: new Date('2025-10-05'), language: 'no' },
        { id: 'news-no-3', promiseId: 'no21-9', source: 'E24', title: 'Lakseskatten vedtatt i Stortinget', url: 'https://e24.no', date: new Date('2023-06-01'), language: 'no' },
        { id: 'news-no-4', promiseId: 'no21-2', source: 'Aftenposten', title: 'Regjeringen √•pner for ny oljeleting i Barentshavet', url: 'https://aftenposten.no', date: new Date('2023-06-15'), language: 'no' }
    ];

    const evidence = [
        // Albania 2025 Term Evidence
        { id: 'e-al25-1', promiseId: 'al25-1', date: new Date('2025-05-15'), description: 'Promise included in official government program presented to Parliament.', verified: true },
        { id: 'e-al25-2', promiseId: 'al25-8', date: new Date('2025-05-20'), description: 'PM Rama reaffirms commitment to completing EU chapters in government formation speech.', verified: true },
        
        // Albania 2021 Term Evidence
        { id: 'e-al21-1a', promiseId: 'al21-1', date: new Date('2022-03-15'), description: 'First phase of reconstruction completed: 2,500 apartments delivered in La√ß.', verified: true },
        { id: 'e-al21-1b', promiseId: 'al21-1', date: new Date('2023-11-26'), description: '100% of earthquake-affected families received new homes or reconstruction support.', verified: true },
        { id: 'e-al21-2a', promiseId: 'al21-2', date: new Date('2022-04-01'), description: 'Minimum wage increased from 30,000 to 34,000 ALL.', verified: true },
        { id: 'e-al21-2b', promiseId: 'al21-2', date: new Date('2023-04-01'), description: 'Minimum wage reached 40,000 ALL as promised.', verified: true },
        { id: 'e-al21-3', promiseId: 'al21-3', date: new Date('2022-07-19'), description: 'EU officially opens accession negotiations with Albania (and North Macedonia).', verified: true },
        { id: 'e-al21-6', promiseId: 'al21-6', date: new Date('2025-01-20'), description: 'Transparency International 2024 report shows Albania dropped 6 positions to 106th place.', verified: true },
        { id: 'e-al21-10', promiseId: 'al21-10', date: new Date('2024-12-01'), description: 'e-Albania portal now offers over 1,200 services, covering 95% of government transactions.', verified: true },
        
        // Norway 2025 Term Evidence
        { id: 'e-no25-1', promiseId: 'no25-1', date: new Date('2025-10-05'), description: 'Climate commitment reaffirmed in government declaration (Regjeringserkl√¶ringen).', verified: true },
        { id: 'e-no25-2', promiseId: 'no25-5', date: new Date('2025-10-08'), description: 'School meals program included as priority in government platform.', verified: true },
        
        // Norway 2021 Term Evidence
        { id: 'e-no21-1', promiseId: 'no21-1', date: new Date('2022-11-01'), description: 'Budget 2023 includes increased taxes on incomes over 750,000 NOK.', verified: true },
        { id: 'e-no21-2', promiseId: 'no21-2', date: new Date('2023-06-15'), description: 'Government approves new exploration licenses in the Barents Sea despite campaign pledge.', verified: true },
        { id: 'e-no21-4', promiseId: 'no21-4', date: new Date('2023-01-01'), description: 'Free dental care extended to 19-21 year olds from January 2023.', verified: true },
        { id: 'e-no21-6', promiseId: 'no21-6', date: new Date('2023-07-01'), description: 'Ferry prices reduced by 30-50% on most routes, with some remote routes becoming free.', verified: true },
        { id: 'e-no21-7', promiseId: 'no21-7', date: new Date('2024-09-01'), description: 'Teacher strikes over salary disputes. Government failed to reach agreement on significant increases.', verified: true },
        { id: 'e-no21-9', promiseId: 'no21-9', date: new Date('2023-06-01'), description: 'Salmon tax passed by Parliament after contentious debate, effective 2023.', verified: true },
    ];

    // ============================================================================
    // DATABASE HELPERS
    // ============================================================================

    const db = {
        actors: {
            findMany: (opts = {}) => {
                let result = [...actors];
                if (opts.where?.type) result = result.filter(a => a.type === opts.where.type);
                if (opts.where?.isCurrent !== undefined) result = result.filter(a => a.isCurrent === opts.where.isCurrent);
                return result;
            },
            findUnique: (opts) => actors.find(a => a.id === opts.where.id),
            findBySlug: (slug) => actors.filter(a => a.slug === slug),
            findBySlugAndTerm: (slug, termSlug) => actors.find(a => a.slug === slug && a.termSlug === termSlug),
            findCurrentBySlug: (slug) => actors.find(a => a.slug === slug && a.isCurrent),
            getTermsForCountry: (slug) => actors.filter(a => a.slug === slug).map(a => ({ termSlug: a.termSlug, isCurrent: a.isCurrent, termStart: a.termStart, termEnd: a.termEnd })).sort((a, b) => b.termStart - a.termStart)
        },
        promises: {
            findMany: (opts = {}) => {
                let result = [...promises];
                if (opts.where?.actorId) result = result.filter(p => p.actorId === opts.where.actorId);
                return result;
            },
            findUnique: (opts) => {
                const p = promises.find(pr => pr.id === opts.where.id);
                if (p && opts.include?.actor) return {...p, actor: actors.find(a => a.id === p.actorId)};
                if (p && opts.include?.evidence) return {...p, actor: actors.find(a => a.id === p.actorId), evidence: evidence.filter(e => e.promiseId === p.id)};
                return p;
            }
        }
    };

    // ============================================================================
    // UI HELPERS
    // ============================================================================

    const statusConfig = {
        NOT_STARTED: { label: 'Not Started', color: 'bg-gray-100 text-gray-600', chartColor: '#9ca3af' },
        IN_THE_WORKS: { label: 'In Progress', color: 'bg-blue-50 text-blue-600', chartColor: '#3b82f6' },
        STALLED: { label: 'Stalled', color: 'bg-amber-50 text-amber-600', chartColor: '#f59e0b' },
        COMPROMISE: { label: 'Compromise', color: 'bg-violet-50 text-violet-600', chartColor: '#8b5cf6' },
        KEPT: { label: 'Kept', color: 'bg-emerald-50 text-emerald-600', chartColor: '#10b981' },
        BROKEN: { label: 'Broken', color: 'bg-red-50 text-red-600', chartColor: '#ef4444' }
    };

    const categoryConfig = {
        ECONOMY: { label: 'Economy', color: '#6366f1' },
        HEALTH: { label: 'Health', color: '#ec4899' },
        EDUCATION: { label: 'Education', color: '#8b5cf6' },
        INFRASTRUCTURE: { label: 'Infrastructure', color: '#f59e0b' },
        ENVIRONMENT: { label: 'Environment', color: '#10b981' },
        GOVERNANCE: { label: 'Governance', color: '#0ea5e9' },
        SOCIAL: { label: 'Social', color: '#f43f5e' },
        OTHER: { label: 'Other', color: '#6b7280' }
    };

    const statusWeight = {
        NOT_STARTED: 0.2,
        IN_THE_WORKS: 0.5,
        STALLED: 0.2,
        COMPROMISE: 0.7,
        KEPT: 1.0,
        BROKEN: 0.0
    };

    const importanceWeight = {
        high: 1.0,
        medium: 0.7,
        low: 0.5,
        standard: 0.5,
        undefined: 0.5
    };
    const statusBadge = (status) => `<span class="inline-block px-2 py-0.5 text-xs font-medium rounded ${statusConfig[status].color}">${statusConfig[status].label}</span>`;
    const statusProgress = (status) => {
        const map = { NOT_STARTED: 10, IN_THE_WORKS: 40, STALLED: 40, COMPROMISE: 75, KEPT: 100, BROKEN: 100 };
        return map[status] || 10;
    };
    const renderMiniTimeline = (status) => {
        const stepMap = { NOT_STARTED: 1, IN_THE_WORKS: 3, STALLED: 3, COMPROMISE: 5, KEPT: 5, BROKEN: 5 };
        const active = stepMap[status] || 1;
        const isBroken = status === 'BROKEN';
        return `<div class="mini-timeline">${Array.from({ length: 5 }).map((_, i) => {
            const isActive = i < active;
            const isLast = i === 4;
            const cls = isBroken && isLast ? 'broken' : (isActive ? 'active' : '');
            return `<span class="${cls}"></span>`;
        }).join('')}</div>`;
    };
    const categoryBadge = (cat) => `<span class="inline-block px-2 py-0.5 text-xs font-medium rounded bg-gray-100 text-gray-600">${categoryConfig[cat].label}</span>`;
    
    const formatDate = (d) => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    const formatDateShort = (d) => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    const daysBetween = (a, b) => Math.round(Math.abs((a - b) / 86400000));

    function calcStats(proms) {
        const total = proms.length;
        const counts = {};
        Object.keys(PromiseStatus).forEach(s => counts[s] = 0);
        proms.forEach(p => counts[p.status]++);

        // Accountability score includes status and impact weight
        const weightedSum = proms.reduce((sum, p) => {
            const statusVal = statusWeight[p.status] ?? 0;
            const impactVal = importanceWeight[p.importance] ?? 0.5;
            return sum + statusVal * impactVal;
        }, 0);
        const score = total > 0 ? Math.round((weightedSum / total) * 100) : 0;

        return { total, counts, score, keptPct: total ? Math.round(counts.KEPT / total * 100) : 0, brokenPct: total ? Math.round(counts.BROKEN / total * 100) : 0 };
    }

    // Momentum snapshot for the last 30 days
    function calcMomentum(proms) {
        const cutoff = Date.now() - 30 * 24 * 60 * 60 * 1000;
        const recent = proms.filter(p => new Date(p.updatedAt).getTime() >= cutoff);
        const kept = recent.filter(p => p.status === PromiseStatus.KEPT).length;
        const stalled = recent.filter(p => p.status === PromiseStatus.STALLED).length;
        const broken = recent.filter(p => p.status === PromiseStatus.BROKEN).length;
        return { kept, stalled, broken };
    }

    // Momentum for a specific actor
    function calcMomentumForActor(actorId) {
        const actorPromises = promises.filter(p => p.actorId === actorId);
        return calcMomentum(actorPromises);
    }

    function showToast(msg) {
        const c = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = 'toast bg-gray-900 text-white text-sm px-4 py-2 rounded-lg shadow-lg';
        t.textContent = msg;
        c.appendChild(t);
        setTimeout(() => t.remove(), 2500);
    }

    function copyLink(url) {
        navigator.clipboard.writeText(url).then(() => showToast('Link copied'));
    }

    // ============================================================================
    // PRINT VIEW TOGGLE
    // ============================================================================

    function setPrintMode(on = true) {
        const body = document.body;
        body.classList.toggle('print-mode', on);
        const btn = document.getElementById('print-view-btn');
        if (btn) {
            btn.textContent = on ? 'Exit print view' : 'Print view';
            btn.className = `hidden sm:flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium rounded-lg transition-base ${on ? 'bg-gray-900 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`;
        }
        showToast(on ? 'Print view enabled' : 'Print view disabled');
    }

    function togglePrintMode() {
        const isOn = document.body.classList.contains('print-mode');
        setPrintMode(!isOn);
    }

    // ============================================================================
    // GLOBAL SEARCH
    // ============================================================================

    function openSearchModal() {
        const modal = document.getElementById('search-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.getElementById('global-search-input').focus();
    }

    function closeSearchModal() {
        const modal = document.getElementById('search-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.getElementById('global-search-input').value = '';
        document.getElementById('search-results').innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">Type to search promises, categories, or countries...</div>';
    }

    function performGlobalSearch(query) {
        if (!query || query.length < 2) {
            return '<div class="text-center py-8 text-gray-400 text-sm">Type at least 2 characters...</div>';
        }
        
        const q = query.toLowerCase();
        const results = promises.filter(p => 
            p.title.toLowerCase().includes(q) || 
            p.fullText.toLowerCase().includes(q) ||
            p.country.toLowerCase().includes(q) ||
            categoryConfig[p.category]?.label.toLowerCase().includes(q)
        ).slice(0, 10);
        
        if (results.length === 0) {
            return '<div class="text-center py-8 text-gray-400 text-sm">No promises found matching your search.</div>';
        }
        
        return results.map(p => {
            const actor = actors.find(a => a.id === p.actorId);
            return `
            <a href="#/promise/${p.id}" onclick="closeSearchModal()" class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition-base">
                <div class="w-1 h-10 rounded country-${actor?.countryCode.toLowerCase()}"></div>
                <div class="flex-1 min-w-0">
                    <div class="font-medium text-gray-900 truncate">${highlightMatch(p.title, query)}</div>
                    <div class="text-sm text-gray-500 flex items-center gap-2">
                        <span>${actor?.country}</span>
                        <span>¬∑</span>
                        <span>${categoryConfig[p.category].label}</span>
                    </div>
                </div>
                ${statusBadge(p.status)}
            </a>`;
        }).join('');
    }

    function highlightMatch(text, query) {
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<mark class="bg-yellow-100 text-yellow-800 rounded px-0.5">$1</mark>');
    }

    // ============================================================================
    // NEWS SOURCES INTEGRATION
    // ============================================================================

    // Get news sources for a country
    function getNewsSourcesForCountry(country) {
        return newsSources[country] || [];
    }

    // Get news articles for a promise
    function getNewsForPromise(promiseId) {
        return newsArticles.filter(n => n.promiseId === promiseId);
    }

    // Generate search URL for a promise on a news source
    function getSearchUrl(source, promiseTitle) {
        // Create search-friendly query
        const query = encodeURIComponent(promiseTitle.slice(0, 50));
        return source.searchUrl + query;
    }

    // Render news sources section for a promise
    function renderNewsSources(promise) {
        const country = promise.country;
        const sources = getNewsSourcesForCountry(country);
        const articles = getNewsForPromise(promise.id);
        
        return `
        <div class="border-t border-gray-100 mt-6 pt-6">
            <h3 class="font-medium text-gray-900 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
                </svg>
                News Coverage
            </h3>
            
            ${articles.length > 0 ? `
            <!-- Related Articles -->
            <div class="mb-6">
                <div class="text-xs text-gray-400 uppercase tracking-wide mb-3">Related Articles</div>
                <div class="space-y-2">
                    ${articles.map(article => `
                    <a href="${article.url}" target="_blank" rel="noopener noreferrer" 
                       class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-base group">
                        <div class="w-10 h-10 bg-white rounded-lg border border-gray-200 flex items-center justify-center text-lg">
                            ${sources.find(s => s.name === article.source)?.icon || 'üì∞'}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium text-gray-900 group-hover:text-blue-600 line-clamp-1">${article.title}</div>
                            <div class="text-xs text-gray-500 flex items-center gap-2">
                                <span>${article.source}</span>
                                <span>¬∑</span>
                                <span>${formatDate(article.date)}</span>
                                ${article.language !== 'en' ? `<span class="px-1.5 py-0.5 bg-gray-200 rounded text-gray-600">${article.language.toUpperCase()}</span>` : ''}
                            </div>
                        </div>
                        <svg class="w-4 h-4 text-gray-300 group-hover:text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                    </a>`).join('')}
                </div>
            </div>` : ''}
            
            <!-- Search on News Sources -->
            <div>
                <div class="text-xs text-gray-400 uppercase tracking-wide mb-3">Search on ${country} News</div>
                <div class="flex flex-wrap gap-2">
                    ${sources.map(source => `
                    <a href="${getSearchUrl(source, promise.title)}" target="_blank" rel="noopener noreferrer"
                       class="inline-flex items-center gap-2 px-3 py-2 bg-white border border-gray-200 rounded-lg hover:border-gray-300 hover:bg-gray-50 transition-base text-sm">
                        <span>${source.icon}</span>
                        <span class="text-gray-700">${source.name}</span>
                        <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                    </a>`).join('')}
                </div>
                <p class="text-xs text-gray-400 mt-3">
                    Click to search for news about this promise on each outlet. Opens in new tab.
                </p>
            </div>
        </div>`;
    }

    // Render news sources overview for a country
    function renderCountryNewsSources(country) {
        const sources = getNewsSourcesForCountry(country);
        
        return `
        <div class="bg-white rounded-xl border border-gray-200 p-6">
            <h3 class="font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
                </svg>
                News Sources
            </h3>
            <p class="text-sm text-gray-500 mb-4">Trusted news outlets covering ${country} politics</p>
            <div class="space-y-2">
                ${sources.map(source => `
                <a href="${source.url}" target="_blank" rel="noopener noreferrer"
                   class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition-base group">
                    <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center text-lg group-hover:bg-gray-200 transition-base">
                        ${source.icon}
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-900 group-hover:text-blue-600">${source.name}</div>
                        <div class="text-xs text-gray-400">${source.type}</div>
                    </div>
                    <svg class="w-4 h-4 text-gray-300 group-hover:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                    </svg>
                </a>`).join('')}
            </div>
        </div>`;
    }

    // ============================================================================
    // SHARE CARD FEATURE
    // ============================================================================

    let currentSharePromise = null;

    function openShareModal(promiseId) {
        const p = promises.find(pr => pr.id === promiseId);
        if (!p) return;
        
        currentSharePromise = p;
        const actor = actors.find(a => a.id === p.actorId);
        
        const preview = document.getElementById('share-card-preview');
        preview.innerHTML = `
        <div class="share-card p-6 text-white">
            <div class="flex items-center gap-2 mb-4">
                <div class="w-1 h-6 rounded bg-white/30"></div>
                <span class="text-sm text-gray-300">${actor?.country} ¬∑ ${actor?.termSlug}</span>
            </div>
            <h3 class="text-lg font-bold mb-3">${p.title}</h3>
            <div class="flex items-center gap-3 mb-4">
                <span class="px-2 py-1 rounded text-xs font-medium" style="background: ${statusConfig[p.status].chartColor}20; color: ${statusConfig[p.status].chartColor}">${statusConfig[p.status].label}</span>
                <span class="text-sm text-gray-400">${p.timeline}</span>
            </div>
            <div class="flex items-center justify-between pt-4 border-t border-white/10">
                <span class="text-xs text-gray-400">PromiseTracker</span>
                <span class="text-xs text-gray-400">promisetracker.org</span>
            </div>
        </div>`;
        
        const modal = document.getElementById('share-modal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeShareModal() {
        const modal = document.getElementById('share-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        currentSharePromise = null;
    }

    function shareToTwitter() {
        if (!currentSharePromise) return;
        const text = `${currentSharePromise.title} - Status: ${statusConfig[currentSharePromise.status].label}`;
        const url = `${location.origin}${location.pathname}#/promise/${currentSharePromise.id}`;
        window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
    }

    function shareToFacebook() {
        if (!currentSharePromise) return;
        const url = `${location.origin}${location.pathname}#/promise/${currentSharePromise.id}`;
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
    }

    function shareToLinkedIn() {
        if (!currentSharePromise) return;
        const url = `${location.origin}${location.pathname}#/promise/${currentSharePromise.id}`;
        window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`, '_blank');
    }

    function copyShareLink() {
        if (!currentSharePromise) return;
        const url = `${location.origin}${location.pathname}#/promise/${currentSharePromise.id}`;
        navigator.clipboard.writeText(url).then(() => {
            showToast('Link copied to clipboard!');
            closeShareModal();
        });
    }

    // ============================================================================
    // PROMISE ALERTS (localStorage based)
    // ============================================================================

    function getAlerts() {
        return JSON.parse(localStorage.getItem('promiseAlerts') || '[]');
    }

    function toggleAlert(promiseId) {
        const alerts = getAlerts();
        const idx = alerts.indexOf(promiseId);
        
        if (idx > -1) {
            alerts.splice(idx, 1);
            showToast('Alert removed');
        } else {
            alerts.push(promiseId);
            showToast('You\'ll be notified when this promise is updated!');
        }
        
        localStorage.setItem('promiseAlerts', JSON.stringify(alerts));
        updateAlertButton(promiseId);
    }

    function hasAlert(promiseId) {
        return getAlerts().includes(promiseId);
    }

    function updateAlertButton(promiseId) {
        const btn = document.getElementById('alert-btn');
        if (!btn) return;
        const isActive = hasAlert(promiseId);
        btn.className = `inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg transition-base ${isActive ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`;
        btn.innerHTML = `
            <svg class="w-4 h-4" fill="${isActive ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
            ${isActive ? 'Watching' : 'Watch'}
        `;
    }

    // Minimal watchlist renderer for country page
    function renderWatchlist(actorId) {
        const alerts = getAlerts();
        const watched = promises.filter(p => alerts.includes(p.id) && p.actorId === actorId);
        if (!watched.length) {
            return `<div class="text-sm text-gray-500">No watched promises yet.</div>`;
        }
        return `<div class="space-y-2">
            ${watched.slice(0, 5).map(p => {
                const actor = actors.find(a => a.id === p.actorId);
                return `
                <a href="#/promise/${p.id}" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 transition-base">
                    <div class="w-1 h-8 rounded country-${actor?.countryCode.toLowerCase()}"></div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm text-gray-900 truncate">${p.title}</div>
                        <div class="text-xs text-gray-400">Last updated: ${formatDate(p.updatedAt)}</div>
                    </div>
                    ${statusBadge(p.status)}
                </a>`;
            }).join('')}
        </div>`;
    }

    // ============================================================================
    // CITIZEN SENTIMENT / PULSE SYSTEM
    // ============================================================================

    const sentimentEmojis = [
        { value: 1, emoji: 'üò†', label: 'Very Dissatisfied', color: '#ef4444' },
        { value: 2, emoji: 'üòï', label: 'Dissatisfied', color: '#f97316' },
        { value: 3, emoji: 'üòê', label: 'Neutral', color: '#eab308' },
        { value: 4, emoji: 'üôÇ', label: 'Satisfied', color: '#84cc16' },
        { value: 5, emoji: 'üòä', label: 'Very Satisfied', color: '#22c55e' }
    ];

    const sentimentCategories = [
        { id: 'overall', label: 'Overall Performance', icon: 'üìä' },
        { id: 'economy', label: 'Economy & Jobs', icon: 'üíº' },
        { id: 'health', label: 'Healthcare', icon: 'üè•' },
        { id: 'education', label: 'Education', icon: 'üéì' },
        { id: 'environment', label: 'Environment', icon: 'üå±' },
        { id: 'transparency', label: 'Transparency', icon: 'üîç' }
    ];

    // Get sentiment data from localStorage
    function getSentimentData() {
        return JSON.parse(localStorage.getItem('citizenSentiment') || '{}');
    }

    // Save sentiment vote
    function saveSentimentVote(countrySlug, category, value) {
        const data = getSentimentData();
        const key = `${countrySlug}_${category}`;
        const today = new Date().toISOString().split('T')[0];
        
        if (!data[key]) {
            data[key] = { votes: [], history: [] };
        }
        
        // Add vote with timestamp
        data[key].votes.push({ value, date: today, timestamp: Date.now() });
        
        // Update history (aggregate by day)
        const historyEntry = data[key].history.find(h => h.date === today);
        if (historyEntry) {
            historyEntry.total += value;
            historyEntry.count += 1;
            historyEntry.avg = historyEntry.total / historyEntry.count;
        } else {
            data[key].history.push({ date: today, total: value, count: 1, avg: value });
        }
        
        localStorage.setItem('citizenSentiment', JSON.stringify(data));
        
        // Mark that user voted today for this category
        const userVotes = JSON.parse(localStorage.getItem('userSentimentVotes') || '{}');
        userVotes[key] = today;
        localStorage.setItem('userSentimentVotes', JSON.stringify(userVotes));
        
        return data[key];
    }

    // Check if user already voted today
    function hasVotedToday(countrySlug, category) {
        const userVotes = JSON.parse(localStorage.getItem('userSentimentVotes') || '{}');
        const key = `${countrySlug}_${category}`;
        const today = new Date().toISOString().split('T')[0];
        return userVotes[key] === today;
    }

    // Get aggregate sentiment for a country/category
    function getAggregateSentiment(countrySlug, category) {
        const data = getSentimentData();
        const key = `${countrySlug}_${category}`;
        
        if (!data[key] || data[key].votes.length === 0) {
            return { average: 3, count: 0, trend: 'neutral' }; // Default neutral
        }
        
        const votes = data[key].votes;
        const total = votes.reduce((sum, v) => sum + v.value, 0);
        const average = total / votes.length;
        
        // Calculate trend (last 7 days vs previous 7 days)
        const now = Date.now();
        const week = 7 * 24 * 60 * 60 * 1000;
        const recentVotes = votes.filter(v => now - v.timestamp < week);
        const olderVotes = votes.filter(v => now - v.timestamp >= week && now - v.timestamp < week * 2);
        
        let trend = 'neutral';
        if (recentVotes.length > 0 && olderVotes.length > 0) {
            const recentAvg = recentVotes.reduce((s, v) => s + v.value, 0) / recentVotes.length;
            const olderAvg = olderVotes.reduce((s, v) => s + v.value, 0) / olderVotes.length;
            if (recentAvg > olderAvg + 0.3) trend = 'up';
            else if (recentAvg < olderAvg - 0.3) trend = 'down';
        }
        
        return { average, count: votes.length, trend };
    }

    // Compact poll summary for hero/inline use
    function renderPollInline(countrySlug) {
        const poll = getPollData(countrySlug);
        const total = poll.total || 1;
        const options = pollOptions.map(opt => {
            const count = poll.votes[opt.id] || 0;
            const pct = Math.round((count / total) * 100);
            return { ...opt, pct };
        });
        return `
        <div class="bg-white rounded-lg border border-gray-200 p-3 flex items-center gap-3">
            <div class="flex-1">
                <div class="text-xs text-gray-500">Citizen question</div>
                <div class="text-sm font-semibold text-gray-800">${pollQuestion}</div>
                <div class="flex gap-2 mt-2">
                    ${options.map(o => `
                        <div class="flex-1">
                            <div class="flex justify-between text-[11px] text-gray-500">
                                <span>${o.label}</span><span>${o.pct}%</span>
                            </div>
                            <div class="h-1.5 bg-gray-100 rounded-full overflow-hidden">
                                <div class="h-full bg-gray-800" style="width:${o.pct}%"></div>
                            </div>
                        </div>`).join('')}
                </div>
                <div class="text-[11px] text-gray-400 mt-2">${poll.total} votes</div>
            </div>
            <a href="#/insights" class="text-xs text-blue-600 hover:text-blue-700">Full poll ‚Üí</a>
        </div>`;
    }

    // Get sentiment history for chart
    function getSentimentHistory(countrySlug, category, days = 30) {
        const data = getSentimentData();
        const key = `${countrySlug}_${category}`;
        
        if (!data[key] || !data[key].history) return [];
        
        // Get last N days
        const history = data[key].history.slice(-days);
        return history;
    }

    // Generate demo sentiment data for display
    function generateDemoSentiment(countrySlug) {
        const data = getSentimentData();
        const categories = ['overall', 'economy', 'health', 'education', 'environment', 'transparency'];
        
        categories.forEach(cat => {
            const key = `${countrySlug}_${cat}`;
            if (!data[key] || data[key].votes.length < 10) {
                // Generate some demo votes
                const baseValue = countrySlug === 'albania' ? 3.2 : 3.5;
                const votes = [];
                const history = [];
                
                for (let i = 30; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    // Generate 5-15 votes per day with some variance
                    const dailyVotes = Math.floor(Math.random() * 10) + 5;
                    let dayTotal = 0;
                    
                    for (let j = 0; j < dailyVotes; j++) {
                        const variance = (Math.random() - 0.5) * 2;
                        const value = Math.max(1, Math.min(5, Math.round(baseValue + variance)));
                        votes.push({ value, date: dateStr, timestamp: date.getTime() + j * 1000 });
                        dayTotal += value;
                    }
                    
                    history.push({ date: dateStr, total: dayTotal, count: dailyVotes, avg: dayTotal / dailyVotes });
                }
                
                data[key] = { votes, history };
            }
        });
        
        localStorage.setItem('citizenSentiment', JSON.stringify(data));
    }

    // Render sentiment barometer
    function renderSentimentBarometer(countrySlug, category = 'overall', size = 'normal') {
        const sentiment = getAggregateSentiment(countrySlug, category);
        const position = ((sentiment.average - 1) / 4) * 100; // Convert 1-5 to 0-100%
        
        const getSentimentLabel = (avg) => {
            if (avg < 1.5) return { text: 'Very Dissatisfied', class: 'text-red-600', dot: '#ef4444' };
            if (avg < 2.5) return { text: 'Dissatisfied', class: 'text-orange-600', dot: '#f97316' };
            if (avg < 3.5) return { text: 'Neutral', class: 'text-yellow-600', dot: '#eab308' };
            if (avg < 4.5) return { text: 'Satisfied', class: 'text-lime-600', dot: '#84cc16' };
            return { text: 'Very Satisfied', class: 'text-green-600', dot: '#22c55e' };
        };
        
        const label = getSentimentLabel(sentiment.average);
        const trendIcon = sentiment.trend === 'up' ? '‚Üó' : sentiment.trend === 'down' ? '‚Üò' : '‚Üí';
        const trendClass = sentiment.trend === 'up' ? 'text-green-600' : sentiment.trend === 'down' ? 'text-red-600' : 'text-gray-400';
        
        if (size === 'compact') {
            return `
            <div class="flex items-center gap-2">
                <div class="sentiment-gauge flex-1">
                    <div class="sentiment-needle" style="left: ${position}%"></div>
                </div>
                <span class="text-sm font-semibold ${label.class}">${sentiment.average.toFixed(1)}</span>
            </div>`;
        }
        
        return `
        <div class="space-y-3">
            <div class="sentiment-gauge">
                <div class="sentiment-needle" style="left: ${position}%"></div>
            </div>
            <div class="flex justify-between text-[11px] text-gray-400 uppercase tracking-wide">
                <span>Very Dissatisfied</span>
                <span>Very Satisfied</span>
            </div>
            <div class="flex items-center justify-center gap-3">
                <span class="text-3xl font-bold ${label.class}">${sentiment.average.toFixed(1)}</span>
                <span class="sentiment-chip">
                    <span class="dot" style="background:${label.dot}"></span>
                    <span class="text-sm font-medium ${label.class}">${label.text}</span>
                    <span class="text-xs ${trendClass}" title="Trend">${trendIcon}</span>
                </span>
            </div>
            <div class="text-center text-xs text-gray-400">${sentiment.count} votes</div>
        </div>`;
    }

    // Render emoji voting widget
    function renderEmojiVoting(countrySlug, category = 'overall') {
        const hasVoted = hasVotedToday(countrySlug, category);
        const catInfo = sentimentCategories.find(c => c.id === category) || sentimentCategories[0];
        
        return `
        <div class="text-center" id="vote-widget-${category}">
            <div class="text-sm text-gray-500 mb-3">${catInfo.icon} ${catInfo.label}</div>
            <div class="flex justify-center gap-2 mb-2">
                ${sentimentEmojis.map(s => `
                <button onclick="submitSentimentVote('${countrySlug}', '${category}', ${s.value})" 
                    class="emoji-btn ${hasVoted ? 'opacity-50 cursor-not-allowed' : ''}" 
                    ${hasVoted ? 'disabled' : ''}
                    title="${s.label}">
                    ${s.emoji}
                </button>`).join('')}
            </div>
            ${hasVoted 
                ? '<div class="text-xs text-green-600">‚úì Thanks for voting today!</div>' 
                : '<div class="text-xs text-gray-400 gentle-pulse">How do you feel about this?</div>'}
        </div>`;
    }

    // Submit sentiment vote
    function submitSentimentVote(countrySlug, category, value) {
        if (hasVotedToday(countrySlug, category)) {
            showToast('You already voted today for this category!');
            return;
        }
        
        saveSentimentVote(countrySlug, category, value);
        
        // Animate the selected emoji
        const widget = document.getElementById(`vote-widget-${category}`);
        if (widget) {
            const buttons = widget.querySelectorAll('.emoji-btn');
            buttons.forEach((btn, i) => {
                if (i === value - 1) {
                    btn.classList.add('selected');
                }
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.disabled = true;
            });
            
            const hint = widget.querySelector('.gentle-pulse');
            if (hint) {
                hint.classList.remove('gentle-pulse');
                hint.className = 'text-xs text-green-600';
                hint.textContent = '‚úì Thanks for voting today!';
            }
        }
        
        // Update barometer if present
        const barometer = document.getElementById(`barometer-${category}`);
        if (barometer) {
            barometer.innerHTML = renderSentimentBarometer(countrySlug, category);
        }
        
        showToast(`Your voice matters! Vote recorded: ${sentimentEmojis.find(s => s.value === value).label}`);
    }

    // Submit sentiment from country page
    function submitCountrySentiment(countrySlug, value) {
        if (hasVotedToday(countrySlug, 'overall')) {
            showToast('You already voted today!');
            return;
        }
        
        saveSentimentVote(countrySlug, 'overall', value);
        
        // Update barometer
        const barometer = document.getElementById('country-barometer-overall');
        if (barometer) {
            barometer.innerHTML = renderSentimentBarometer(countrySlug, 'overall', 'compact');
        }
        
        // Disable buttons
        const buttons = document.querySelectorAll('.emoji-btn');
        buttons.forEach((btn, i) => {
            if (i === value - 1) {
                btn.classList.add('selected');
            }
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            btn.disabled = true;
        });
        
        showToast(`Thanks for sharing how you feel! ${sentimentEmojis.find(s => s.value === value).emoji}`);
    }

    // ============================================================================
    // EXPORT DATA
    // ============================================================================

    function exportToCSV(actorId = null) {
        let data = actorId ? promises.filter(p => p.actorId === actorId) : promises;
        
        const headers = ['Title', 'Status', 'Category', 'Country', 'Timeline', 'Source', 'Full Text'];
        const rows = data.map(p => [
            `"${p.title.replace(/"/g, '""')}"`,
            statusConfig[p.status].label,
            categoryConfig[p.category].label,
            p.country,
            p.timeline,
            p.sourceType,
            `"${p.fullText.replace(/"/g, '""')}"`
        ]);
        
        const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `promisetracker-${actorId ? actors.find(a => a.id === actorId)?.slug : 'all'}-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        
        URL.revokeObjectURL(url);
        showToast('Data exported successfully!');
    }

    // ============================================================================
    // ACHIEVEMENT BADGES
    // ============================================================================

    function getAchievements(actorId) {
        const proms = promises.filter(p => p.actorId === actorId);
        const stats = calcStats(proms);
        const badges = [];
        
        // Early Mover - At least 1 promise in progress within first 100 days
        const actor = actors.find(a => a.id === actorId);
        const daysSinceStart = actor ? daysBetween(actor.termStart, new Date()) : 0;
        if (daysSinceStart <= 100 && stats.counts.IN_THE_WORKS > 0) {
            badges.push({ id: 'early-mover', name: 'Early Mover', icon: 'üöÄ', desc: 'Started work within first 100 days' });
        }
        
        // Promise Keeper - 50%+ promises kept
        if (stats.keptPct >= 50 && stats.total >= 5) {
            badges.push({ id: 'promise-keeper', name: 'Promise Keeper', icon: '‚úÖ', desc: 'Kept 50%+ of promises' });
        }
        
        // Transparency Champion - Has evidence for 80%+ promises
        const promisesWithEvidence = proms.filter(p => evidence.some(e => e.promiseId === p.id)).length;
        if (promisesWithEvidence / proms.length >= 0.8 && proms.length >= 5) {
            badges.push({ id: 'transparency', name: 'Transparency Champion', icon: 'üîç', desc: 'Evidence documented for 80%+ promises' });
        }
        
        // Multi-Category - Promises across 5+ categories
        const categories = new Set(proms.map(p => p.category));
        if (categories.size >= 5) {
            badges.push({ id: 'diverse', name: 'Diverse Agenda', icon: 'üåà', desc: 'Promises across 5+ policy areas' });
        }
        
        // Clean Record - No broken promises
        if (stats.counts.BROKEN === 0 && stats.total >= 5) {
            badges.push({ id: 'clean', name: 'Clean Record', icon: '‚≠ê', desc: 'No broken promises yet' });
        }
        
        return badges;
    }

    function renderBadges(actorId) {
        const badges = getAchievements(actorId);
        if (badges.length === 0) return '';
        
        return `
        <div class="flex flex-wrap gap-2">
            ${badges.map(b => `
            <div class="flex items-center gap-1 px-2 py-0.5 text-[11px] font-medium rounded-full border border-gray-200 bg-white text-gray-600" title="${b.desc}">
                <span class="text-sm">${b.icon}</span>
                <span>${b.name}</span>
            </div>`).join('')}
        </div>`;
    }

    // ============================================================================
    // COMMUNITY DISCUSSIONS (LOCAL STORAGE)
    // ============================================================================

    function getCountryDiscussions(slug) {
        const data = JSON.parse(localStorage.getItem('countryDiscussions') || '{}');
        return data[slug] || [];
    }

    function saveCountryDiscussions(slug, threads) {
        const data = JSON.parse(localStorage.getItem('countryDiscussions') || '{}');
        data[slug] = threads;
        localStorage.setItem('countryDiscussions', JSON.stringify(data));
    }

    function generateDiscussionId() {
        return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
    }

    function formatDiscussionDate(ts) {
        return new Date(ts).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
    }

    function getInitials(name) {
        return name
            .split(' ')
            .map(part => part.charAt(0).toUpperCase())
            .slice(0, 2)
            .join('') || 'C';
    }

    function renderCountryDiscussionsContent(slug) {
        const threads = getCountryDiscussions(slug).sort((a, b) => b.timestamp - a.timestamp);
        const topicFilters = ['all', 'general', 'economy', 'health', 'education', 'environment', 'governance'];
        
        return `
        <div class="bg-white rounded-xl border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Community Discussion</h2>
                    <p class="text-sm text-gray-500">Share thoughts about government progress or promises.</p>
                </div>
                <span class="text-xs text-gray-400">${threads.length} posts stored locally</span>
            </div>
            <div class="flex flex-wrap gap-2 mb-4" id="discussion-filters-${slug}">
                ${topicFilters.map(filter => `
                    <button data-topic="${filter}" class="discussion-filter px-3 py-1.5 text-xs rounded-full border ${filter === 'all' ? 'bg-gray-900 text-white border-gray-900' : 'bg-white text-gray-600 border-gray-200 hover:border-gray-300'}">
                        ${filter === 'all' ? 'All topics' : filter.charAt(0).toUpperCase() + filter.slice(1)}
                    </button>
                `).join('')}
            </div>
            <form onsubmit="submitCountryDiscussion(event, '${slug}')" class="space-y-3 mb-6">
                <div class="flex flex-col sm:flex-row gap-3">
                    <input name="name" type="text" placeholder="Display name (optional)" class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-gray-300">
                    <select name="topic" class="px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-gray-300">
                        <option value="general">General</option>
                        <option value="economy">Economy</option>
                        <option value="health">Health</option>
                        <option value="education">Education</option>
                        <option value="environment">Environment</option>
                        <option value="governance">Governance</option>
                    </select>
                </div>
                <textarea name="message" rows="3" placeholder="Add your comment, question, or reaction..." class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-gray-300" required></textarea>
                <div class="flex flex-wrap items-center gap-3 justify-between text-xs text-gray-400">
                    <span>Saved only on your device. Future update will sync discussions.</span>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-gray-900 rounded-lg hover:bg-gray-800 transition-base">Post</button>
                </div>
            </form>
            <div class="space-y-3">
                ${threads.length ? threads.map(t => renderDiscussionItem(slug, t)).join('') : '<div class="text-center text-gray-400 text-sm py-4">No comments yet. Start the conversation.</div>'}
            </div>
        </div>`;
    }

    function applyDiscussionFilter(slug, topic) {
        const container = document.getElementById(`discussion-${slug}`);
        if (!container) return;
        const threads = getCountryDiscussions(slug).sort((a, b) => b.timestamp - a.timestamp);
        const filteredThreads = topic === 'all' ? threads : threads.filter(t => t.topic === topic);
        const list = container.querySelector('.space-y-3');
        if (!list) return;
        list.innerHTML = filteredThreads.length
            ? filteredThreads.map(t => renderDiscussionItem(slug, t)).join('')
            : '<div class="text-center text-gray-400 text-sm py-4">No posts in this topic yet.</div>';
    }

    function renderDiscussionItem(slug, thread) {
        const topics = {
            general: { label: 'General', color: 'bg-gray-100 text-gray-600' },
            economy: { label: 'Economy', color: 'bg-blue-50 text-blue-600' },
            health: { label: 'Health', color: 'bg-pink-50 text-pink-600' },
            education: { label: 'Education', color: 'bg-purple-50 text-purple-600' },
            environment: { label: 'Environment', color: 'bg-green-50 text-green-600' },
            governance: { label: 'Governance', color: 'bg-indigo-50 text-indigo-600' }
        };
        const topic = topics[thread.topic] || topics.general;
        const replies = thread.replies || [];
        return `
        <div class="p-4 border border-gray-100 rounded-lg">
            <div class="flex items-start gap-3">
                <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-sm font-semibold text-gray-600">
                    ${getInitials(thread.name || 'Citizen')}
                </div>
                <div class="flex-1">
                    <div class="flex items-center gap-2 flex-wrap">
                        <span class="text-sm font-medium text-gray-900">${thread.name || 'Citizen'}</span>
                        <span class="text-xs text-gray-400">${formatDiscussionDate(thread.timestamp)}</span>
                        <span class="text-xs px-2 py-0.5 rounded-full ${topic.color}">${topic.label}</span>
                    </div>
                    <p class="text-sm text-gray-700 mt-1 whitespace-pre-line">${thread.message}</p>
                    <div class="flex items-center gap-4 mt-3 text-xs text-gray-500">
                        <button onclick="likeCountryDiscussion('${slug}', '${thread.id}')" class="inline-flex items-center gap-1 text-gray-500 hover:text-gray-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                            ${thread.likes || 0}
                        </button>
                        <button onclick="toggleReplyForm('${thread.id}')" class="inline-flex items-center gap-1 text-gray-500 hover:text-gray-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 10h13m-6-7l7 7-7 7"/></svg>
                            Reply
                        </button>
                    </div>
                    <div id="reply-form-${thread.id}" class="hidden mt-3">
                        <form onsubmit="submitDiscussionReply(event, '${slug}', '${thread.id}')" class="space-y-2">
                            <input name="name" type="text" placeholder="Name (optional)" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-gray-300">
                            <textarea name="message" rows="2" placeholder="Write a reply..." class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-gray-300" required></textarea>
                            <div class="flex justify-end gap-2 text-xs">
                                <button type="button" onclick="toggleReplyForm('${thread.id}', true)" class="px-3 py-1.5 text-gray-500 bg-gray-100 rounded-lg">Cancel</button>
                                <button type="submit" class="px-3 py-1.5 text-white bg-gray-900 rounded-lg">Post reply</button>
                            </div>
                        </form>
                    </div>
                    ${replies.length ? `
                        <div class="mt-4 space-y-2">
                            ${replies.map(reply => `
                                <div class="flex items-start gap-3 pl-3 border-l border-gray-100">
                                    <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-xs font-semibold text-gray-500">
                                        ${getInitials(reply.name || 'Citizen')}
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 text-xs text-gray-400">
                                            <span class="text-gray-700 font-medium">${reply.name || 'Citizen'}</span>
                                            <span>${formatDiscussionDate(reply.timestamp)}</span>
                                        </div>
                                        <p class="text-sm text-gray-600 mt-0.5 whitespace-pre-line">${reply.message}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>`;
    }

    function submitCountryDiscussion(event, slug) {
        event.preventDefault();
        const form = event.target;
        const name = form.name.value.trim();
        const topic = form.topic.value;
        const message = form.message.value.trim();
        if (!message) {
            showToast('Please enter a message.');
            return;
        }
        const threads = getCountryDiscussions(slug);
        threads.unshift({
            id: generateDiscussionId(),
            name: name || 'Citizen',
            topic,
            message,
            timestamp: Date.now(),
            likes: 0,
            replies: []
        });
        saveCountryDiscussions(slug, threads);
        form.reset();
        showToast('Thanks for sharing your perspective!');
        updateCountryDiscussionSection(slug);
    }

    function submitDiscussionReply(event, slug, threadId) {
        event.preventDefault();
        const form = event.target;
        const name = form.name.value.trim();
        const message = form.message.value.trim();
        if (!message) {
            showToast('Please enter a reply.');
            return;
        }
        const threads = getCountryDiscussions(slug);
        const thread = threads.find(t => t.id === threadId);
        if (!thread) return;
        if (!thread.replies) thread.replies = [];
        thread.replies.push({
            id: generateDiscussionId(),
            name: name || 'Citizen',
            message,
            timestamp: Date.now()
        });
        saveCountryDiscussions(slug, threads);
        showToast('Reply added');
        updateCountryDiscussionSection(slug);
    }

    function toggleReplyForm(threadId, close = false) {
        const form = document.getElementById(`reply-form-${threadId}`);
        if (!form) return;
        if (close) {
            form.classList.add('hidden');
            form.querySelector('form').reset();
        } else {
            form.classList.toggle('hidden');
        }
    }

    function likeCountryDiscussion(slug, id) {
        const threads = getCountryDiscussions(slug);
        const thread = threads.find(t => t.id === id);
        if (!thread) return;
        thread.likes = (thread.likes || 0) + 1;
        saveCountryDiscussions(slug, threads);
        updateCountryDiscussionSection(slug);
    }

    function updateCountryDiscussionSection(slug) {
        const container = document.getElementById(`discussion-${slug}`);
        if (container) {
            container.innerHTML = renderCountryDiscussionsContent(slug);
            initDiscussionFilters(slug);
        }
    }

    function initDiscussionFilters(slug) {
        const filterContainer = document.getElementById(`discussion-filters-${slug}`);
        if (!filterContainer) return;
        filterContainer.querySelectorAll('.discussion-filter').forEach(btn => {
            btn.addEventListener('click', () => {
                filterContainer.querySelectorAll('.discussion-filter').forEach(b => {
                    b.className = 'discussion-filter px-3 py-1.5 text-xs rounded-full border bg-white text-gray-600 border-gray-200 hover:border-gray-300';
                });
                btn.className = 'discussion-filter px-3 py-1.5 text-xs rounded-full border bg-gray-900 text-white border-gray-900';
                applyDiscussionFilter(slug, btn.dataset.topic);
            });
        });
    }

    // ============================================================================
    // DEADLINE ALERTS
    // ============================================================================

    function getUpcomingDeadlines(days = 90) {
        const now = new Date();
        const cutoff = new Date(now.getTime() + days * 24 * 60 * 60 * 1000);
        
        return promises.filter(p => {
            if (p.status === 'KEPT' || p.status === 'BROKEN') return false;
            const match = p.timeline.match(/\d{4}/);
            if (!match) return false;
            const year = parseInt(match[0]);
            const deadline = new Date(year, 11, 31); // End of mentioned year
            return deadline <= cutoff && deadline >= now;
        }).map(p => ({
            ...p,
            urgency: getUrgencyLevel(p.timeline)
        }));
    }

    function getUrgencyLevel(timeline) {
        const match = timeline.match(/\d{4}/);
        if (!match) return 'low';
        const year = parseInt(match[0]);
        const now = new Date();
        const diff = year - now.getFullYear();
        if (diff <= 0) return 'critical';
        if (diff === 1) return 'high';
        return 'medium';
    }

    // ============================================================================
    // WEEKLY DIGEST & WATCHLIST HELPERS
    // ============================================================================

    function getWeeklyDigest(actorId, days = 7) {
        const cutoff = Date.now() - days * 24 * 60 * 60 * 1000;
        const actorPromises = promises.filter(p => p.actorId === actorId);
        const recentPromises = actorPromises.filter(p => new Date(p.updatedAt).getTime() >= cutoff);
        const recentEvidence = evidence.filter(e => {
            const p = actorPromises.find(pr => pr.id === e.promiseId);
            return p && new Date(e.date).getTime() >= cutoff;
        }).sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 4);

        const counts = {
            kept: recentPromises.filter(p => p.status === PromiseStatus.KEPT).length,
            stalled: recentPromises.filter(p => p.status === PromiseStatus.STALLED).length,
            broken: recentPromises.filter(p => p.status === PromiseStatus.BROKEN).length,
            updated: recentPromises.length
        };

        return { counts, recentEvidence, hasActivity: recentPromises.length > 0 || recentEvidence.length > 0 };
    }

    function renderWeeklyDigest(actorId) {
        const digest = getWeeklyDigest(actorId);
        if (!digest.hasActivity) {
            return `<div class="text-sm text-gray-500">No notable changes in the last 7 days.</div>`;
        }
        return `
        <div class="grid sm:grid-cols-4 gap-3 mb-4">
            <div class="p-3 rounded-lg bg-emerald-50 text-emerald-700">
                <div class="text-2xl font-semibold">+${digest.counts.kept}</div>
                <div class="text-xs">Kept</div>
            </div>
            <div class="p-3 rounded-lg bg-amber-50 text-amber-700">
                <div class="text-2xl font-semibold">+${digest.counts.stalled}</div>
                <div class="text-xs">Stalled</div>
            </div>
            <div class="p-3 rounded-lg bg-red-50 text-red-700">
                <div class="text-2xl font-semibold">+${digest.counts.broken}</div>
                <div class="text-xs">Broken</div>
            </div>
            <div class="p-3 rounded-lg bg-blue-50 text-blue-700">
                <div class="text-2xl font-semibold">+${digest.counts.updated}</div>
                <div class="text-xs">Updated</div>
            </div>
        </div>
        ${digest.recentEvidence.length ? `
        <div class="space-y-2">
            ${digest.recentEvidence.map(e => {
                const p = promises.find(pr => pr.id === e.promiseId);
                return `<div class="p-3 border border-gray-100 rounded-lg bg-gray-50">
                    <div class="flex items-center justify-between text-xs text-gray-400">
                        <span>${formatDate(e.date)}</span>
                        <span>${statusBadge(p.status)}</span>
                    </div>
                    <div class="text-sm text-gray-800 mt-1">${e.description}</div>
                    ${p ? `<div class="text-xs text-blue-600 mt-1 truncate">${p.title}</div>` : ''}
                </div>`;
            }).join('')}
        </div>` : ''}`;
    }

    // Compact weekly digest for country pages
    function renderWeeklyDigestCompact(actorId) {
        const digest = getWeeklyDigest(actorId);
        if (!digest.hasActivity) return '';
        return `
        <div class="border border-gray-200 rounded-lg p-4 bg-white">
            <div class="flex items-center justify-between mb-3">
                <div>
                    <div class="text-sm font-semibold text-gray-800">This Week</div>
                    <div class="text-xs text-gray-400">What changed</div>
                </div>
                <div class="flex gap-2 text-xs">
                    <span class="px-2 py-0.5 rounded bg-emerald-50 text-emerald-700">+${digest.counts.kept} kept</span>
                    <span class="px-2 py-0.5 rounded bg-amber-50 text-amber-700">+${digest.counts.stalled} stalled</span>
                    <span class="px-2 py-0.5 rounded bg-red-50 text-red-700">+${digest.counts.broken} broken</span>
                </div>
            </div>
            ${digest.recentEvidence.length ? `
            <div class="space-y-2">
                ${digest.recentEvidence.map(e => {
                    const p = promises.find(pr => pr.id === e.promiseId);
                    return `
                    <div class="p-2 border border-gray-100 rounded bg-gray-50">
                        <div class="flex items-center justify-between text-xs text-gray-400">
                            <span>${formatDate(e.date)}</span>
                            ${p ? statusBadge(p.status) : ''}
                        </div>
                        <div class="text-sm text-gray-700 mt-0.5">${e.description}</div>
                        ${p ? `<div class="text-xs text-blue-600 truncate">${p.title}</div>` : ''}
                    </div>`;
                }).join('')}
            </div>` : '<div class="text-xs text-gray-400">No new evidence this week.</div>'}
        </div>`;
    }

    // ============================================================================
    // CITIZEN POLL (LOCAL STORAGE)
    // ============================================================================

    const pollQuestion = 'Do you feel the government is on track this month?';
    const pollOptions = [
        { id: 'yes', label: 'Yes' },
        { id: 'unsure', label: 'Unsure' },
        { id: 'no', label: 'No' }
    ];

    function getPollData(countrySlug) {
        const data = JSON.parse(localStorage.getItem('pollVotes') || '{}');
        const key = `${countrySlug}_poll`;
        if (!data[key]) {
            data[key] = { total: 0, votes: { yes: 0, unsure: 0, no: 0 } };
            localStorage.setItem('pollVotes', JSON.stringify(data));
        }
        return data[key];
    }

    function hasVotedPoll(countrySlug) {
        const votes = JSON.parse(localStorage.getItem('userPollVotes') || '{}');
        return !!votes[countrySlug];
    }

    function votePoll(countrySlug, optionId) {
        if (hasVotedPoll(countrySlug)) {
            showToast('You already voted in this poll.');
            return;
        }
        const data = JSON.parse(localStorage.getItem('pollVotes') || '{}');
        const key = `${countrySlug}_poll`;
        if (!data[key]) data[key] = { total: 0, votes: { yes: 0, unsure: 0, no: 0 } };
        data[key].votes[optionId] = (data[key].votes[optionId] || 0) + 1;
        data[key].total += 1;
        localStorage.setItem('pollVotes', JSON.stringify(data));

        const userVotes = JSON.parse(localStorage.getItem('userPollVotes') || '{}');
        userVotes[countrySlug] = optionId;
        localStorage.setItem('userPollVotes', JSON.stringify(userVotes));

        showToast('Vote recorded!');
        const pollContainer = document.getElementById(`poll-${countrySlug}`);
        if (pollContainer) pollContainer.innerHTML = renderPoll(countrySlug);
    }

    function renderPoll(countrySlug) {
        const poll = getPollData(countrySlug);
        const total = poll.total || 1; // avoid division by zero
        const voted = hasVotedPoll(countrySlug);
        return `
        <div class="p-4 bg-white rounded-lg border border-gray-200" id="poll-${countrySlug}">
            <div class="text-sm font-semibold text-gray-800 mb-2">Citizen Question</div>
            <div class="text-sm text-gray-600 mb-3">${pollQuestion}</div>
            <div class="space-y-2">
                ${pollOptions.map(opt => {
                    const count = poll.votes[opt.id] || 0;
                    const pct = Math.round((count / total) * 100);
                    return `
                    <button ${voted ? 'disabled' : ''} onclick="votePoll('${countrySlug}', '${opt.id}')" 
                        class="w-full text-left p-2 border border-gray-200 rounded-lg hover:bg-gray-50 transition-base ${voted ? 'cursor-default opacity-80' : ''}">
                        <div class="flex justify-between text-sm text-gray-700 mb-1">
                            <span>${opt.label}</span>
                            <span class="text-gray-500">${pct}%</span>
                        </div>
                        <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                            <div class="h-full bg-gray-800" style="width:${pct}%"></div>
                        </div>
                    </button>`;
                }).join('')}
            </div>
            <div class="text-xs text-gray-400 mt-2">${poll.total} votes</div>
        </div>`;
    }

    // ============================================================================
    // CITIZEN PULSE PAGE
    // ============================================================================

    function renderCitizenPulse() {
        const currentGovs = db.actors.findMany({ where: { type: ActorType.GOVERNMENT, isCurrent: true } });
        
        // Generate demo data if needed
        currentGovs.forEach(g => generateDemoSentiment(g.slug));
        
        return `
        <div class="fade-in py-8">
            <div class="max-w-6xl mx-auto px-4 sm:px-6">
                <!-- Header -->
                <div class="text-center mb-10">
                    <h1 class="text-3xl font-bold text-gray-900 mb-3">Citizen Pulse</h1>
                    <p class="text-gray-500 max-w-2xl mx-auto">
                        Your voice matters. Rate how you feel about your government's performance 
                        and see how other citizens are feeling in real-time.
                    </p>
                </div>
                
                <!-- Country Selection Tabs -->
                <div class="flex justify-center gap-2 mb-8">
                    ${currentGovs.map((g, i) => `
                    <button onclick="switchPulseCountry('${g.slug}')" 
                        class="pulse-country-tab px-4 py-2 rounded-lg text-sm font-medium transition-base ${i === 0 ? 'bg-gray-900 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}"
                        data-country="${g.slug}">
                        <span class="inline-block w-1 h-4 rounded mr-2 country-${g.countryCode.toLowerCase()}" style="vertical-align: middle"></span>
                        ${g.country}
                    </button>`).join('')}
                </div>
                
                <!-- Main Pulse Content -->
                <div id="pulse-content">
                    ${renderPulseCountryContent(currentGovs[0]?.slug || 'albania')}
                </div>
                
                <!-- How It Works -->
                <div class="mt-12 bg-gray-50 rounded-xl p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 text-center">How Citizen Pulse Works</h2>
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="text-center">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <span class="text-2xl">üó≥Ô∏è</span>
                            </div>
                            <h3 class="font-medium text-gray-900 mb-1">Vote Daily</h3>
                            <p class="text-sm text-gray-500">Share how you feel about different aspects of government performance once per day.</p>
                        </div>
                        <div class="text-center">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <span class="text-2xl">üìä</span>
                            </div>
                            <h3 class="font-medium text-gray-900 mb-1">See Aggregated Results</h3>
                            <p class="text-sm text-gray-500">View the collective sentiment of citizens across all categories in real-time.</p>
                        </div>
                        <div class="text-center">
                            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <span class="text-2xl">üìà</span>
                            </div>
                            <h3 class="font-medium text-gray-900 mb-1">Track Trends</h3>
                            <p class="text-sm text-gray-500">See how public sentiment changes over time with our historical charts.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Privacy Note -->
                <div class="mt-6 text-center text-xs text-gray-400">
                    <p>üîí Your votes are anonymous and stored locally on your device. We don't track personal information.</p>
                </div>
            </div>
        </div>`;
    }

    function renderPulseCountryContent(countrySlug) {
        const actor = db.actors.findCurrentBySlug(countrySlug);
        if (!actor) return '<div class="text-center text-gray-500">Country not found</div>';
        
        const overallSentiment = getAggregateSentiment(countrySlug, 'overall');
        
        // Determine card style based on sentiment
        const cardClass = overallSentiment.average >= 3.5 ? 'sentiment-card-positive' : 
                         overallSentiment.average < 2.5 ? 'sentiment-card-negative' : 'sentiment-card-neutral';
        
        return `
        <!-- Overall Sentiment Card -->
        <div class="${cardClass} rounded-xl p-6 mb-8">
            <div class="grid md:grid-cols-2 gap-8 items-center">
                <div>
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-1 h-10 rounded country-${actor.countryCode.toLowerCase()}"></div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">${actor.country}</h2>
                            <p class="text-sm text-gray-500">${actor.leader} ¬∑ ${actor.party}</p>
                        </div>
                    </div>
                    
                    <h3 class="text-sm font-medium text-gray-700 mb-3">Overall Public Sentiment</h3>
                    <div id="barometer-overall">
                        ${renderSentimentBarometer(countrySlug, 'overall')}
                    </div>
                </div>
                
                <div class="bg-white/50 rounded-xl p-5">
                    <h3 class="text-sm font-medium text-gray-700 mb-4 text-center">Cast Your Vote</h3>
                    ${renderEmojiVoting(countrySlug, 'overall')}
                </div>
            </div>
        </div>
        
        <!-- Category Ratings -->
        <div class="mb-8">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Rate by Category</h2>
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                ${sentimentCategories.filter(c => c.id !== 'overall').map(cat => {
                    const sentiment = getAggregateSentiment(countrySlug, cat.id);
                    const cardTone = sentiment.average >= 3.5 ? 'border-lime-200 bg-lime-50/60' : 
                                     sentiment.average < 2.5 ? 'border-rose-200 bg-rose-50/60' : 'border-gray-200 bg-white';
                    return `
                    <div class="rounded-xl border ${cardTone} p-4 shadow-sm">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">${cat.icon}</span>
                                <span class="font-semibold text-gray-900">${cat.label}</span>
                            </div>
                            <span class="text-base font-bold ${sentiment.average >= 3.5 ? 'text-lime-600' : sentiment.average < 2.5 ? 'text-rose-600' : 'text-gray-700'}">
                                ${sentiment.average.toFixed(1)}
                            </span>
                        </div>
                        <div id="barometer-${cat.id}" class="mb-3">
                            ${renderSentimentBarometer(countrySlug, cat.id, 'compact')}
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="text-xs text-gray-500">Rate this area</div>
                            <div class="flex gap-1">${sentimentEmojis.map(s => `
                                <button onclick="submitSentimentVote('${countrySlug}', '${cat.id}', ${s.value})" 
                                    class="emoji-btn ${hasVotedToday(countrySlug, cat.id) ? 'opacity-50 cursor-not-allowed' : ''}"
                                    ${hasVotedToday(countrySlug, cat.id) ? 'disabled' : ''} title="${s.label}">
                                    ${s.emoji}
                                </button>`).join('')}
                            </div>
                        </div>
                    </div>`;
                }).join('')}
            </div>
        </div>
        
        <!-- Sentiment Trend Chart -->
        <div class="bg-white rounded-xl border border-gray-200 p-6 mb-8">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Sentiment Trend (Last 30 Days)</h2>
            <div class="h-64 chart-container relative">
                <div class="chart-skeleton skeleton"></div>
                <canvas id="sentiment-trend-chart"></canvas>
            </div>
        </div>
        
        <!-- Category Comparison Chart -->
        <div class="grid md:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl border border-gray-200 p-6">
                <h3 class="font-semibold text-gray-900 mb-4">Category Breakdown</h3>
                <div class="h-64 chart-container relative">
                    <div class="chart-skeleton skeleton"></div>
                    <canvas id="category-sentiment-chart"></canvas>
                </div>
            </div>
            
            <div class="bg-white rounded-xl border border-gray-200 p-6">
                <h3 class="font-semibold text-gray-900 mb-4">Recent Activity</h3>
                <div class="space-y-3">
                    ${generateRecentSentimentActivity(countrySlug)}
                </div>
            </div>
        </div>`;
    }

    function generateRecentSentimentActivity(countrySlug) {
        const data = getSentimentData();
        const activities = [];
        
        sentimentCategories.forEach(cat => {
            const key = `${countrySlug}_${cat.id}`;
            if (data[key] && data[key].votes) {
                const recentVotes = data[key].votes.slice(-5);
                recentVotes.forEach(vote => {
                    activities.push({
                        category: cat.label,
                        icon: cat.icon,
                        value: vote.value,
                        date: vote.date,
                        timestamp: vote.timestamp
                    });
                });
            }
        });
        
        // Sort by timestamp and take most recent
        activities.sort((a, b) => b.timestamp - a.timestamp);
        const recent = activities.slice(0, 8);
        
        if (recent.length === 0) {
            return '<div class="text-center text-gray-400 py-6">No activity yet. Be the first to vote!</div>';
        }
        
        return recent.map(a => {
            const emoji = sentimentEmojis.find(e => e.value === a.value);
            return `
            <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50">
                <span class="text-lg">${emoji?.emoji || 'üòê'}</span>
                <div class="flex-1 min-w-0">
                    <div class="text-sm text-gray-700">${a.icon} ${a.category}</div>
                    <div class="text-xs text-gray-400">${formatDate(new Date(a.timestamp))}</div>
                </div>
                <span class="text-xs px-2 py-1 rounded-full" style="background: ${emoji?.color}20; color: ${emoji?.color}">${emoji?.label}</span>
            </div>`;
        }).join('');
    }

    function switchPulseCountry(countrySlug) {
        // Update tabs
        document.querySelectorAll('.pulse-country-tab').forEach(tab => {
            if (tab.dataset.country === countrySlug) {
                tab.className = 'pulse-country-tab px-4 py-2 rounded-lg text-sm font-medium transition-base bg-gray-900 text-white';
            } else {
                tab.className = 'pulse-country-tab px-4 py-2 rounded-lg text-sm font-medium transition-base bg-gray-100 text-gray-600 hover:bg-gray-200';
            }
        });
        
        // Update content
        const content = document.getElementById('pulse-content');
        if (content) {
            content.innerHTML = renderPulseCountryContent(countrySlug);
            initPulseCharts(countrySlug);
        }
    }

    function initPulseCharts(countrySlug) {
        setTimeout(() => {
            // Sentiment Trend Chart
            const trendCtx = document.getElementById('sentiment-trend-chart');
            if (trendCtx) {
                const renderTrend = () => {
                    const history = getSentimentHistory(countrySlug, 'overall', 30);
                    
                    if (charts['sentiment-trend-chart']) {
                        charts['sentiment-trend-chart'].destroy();
                    }
                    
                    charts['sentiment-trend-chart'] = new Chart(trendCtx, {
                        type: 'line',
                        data: {
                            labels: history.map(h => {
                                const d = new Date(h.date);
                                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            }),
                            datasets: [{
                                label: 'Public Sentiment',
                                data: history.map(h => h.avg),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 3,
                                pointHoverRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (ctx) => {
                                            const val = ctx.raw;
                                            const label = val >= 4 ? 'Satisfied' : val >= 3 ? 'Neutral' : 'Dissatisfied';
                                            return `${val.toFixed(2)} - ${label}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: { 
                                    min: 1, 
                                    max: 5, 
                                    ticks: { stepSize: 1 },
                                    grid: { color: '#f3f4f6' }
                                },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                    removeSkeleton('sentiment-trend-chart');
                };
                lazyRenderChart('sentiment-trend-chart', renderTrend);
            }
            
            // Category Sentiment Chart
            const catCtx = document.getElementById('category-sentiment-chart');
            if (catCtx) {
                const renderCat = () => {
                    const categories = sentimentCategories.filter(c => c.id !== 'overall');
                    const sentiments = categories.map(c => getAggregateSentiment(countrySlug, c.id).average);
                    
                    if (charts['category-sentiment-chart']) {
                        charts['category-sentiment-chart'].destroy();
                    }
                    
                    charts['category-sentiment-chart'] = new Chart(catCtx, {
                        type: 'radar',
                        data: {
                            labels: categories.map(c => c.label),
                            datasets: [{
                                label: 'Sentiment',
                                data: sentiments,
                                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                borderColor: '#3b82f6',
                                pointBackgroundColor: '#3b82f6',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: '#3b82f6'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                r: {
                                    min: 1,
                                    max: 5,
                                    ticks: { stepSize: 1, display: false },
                                    pointLabels: { font: { size: 11 } }
                                }
                            }
                        }
                    });
                    removeSkeleton('category-sentiment-chart');
                };
                lazyRenderChart('category-sentiment-chart', renderCat);
            }
        }, 100);
    }

    // ============================================================================
    // TREND TRACKING
    // ============================================================================

    function getScoreTrend(actorId) {
        // Simulated historical data - in real app this would come from database
        const actor = actors.find(a => a.id === actorId);
        if (!actor) return [];
        
        const currentStats = calcStats(promises.filter(p => p.actorId === actorId));
        const months = [];
        const startDate = new Date(actor.termStart);
        const now = new Date();
        
        // Generate monthly data points
        let current = new Date(startDate);
        while (current <= now) {
            const monthsElapsed = (current.getFullYear() - startDate.getFullYear()) * 12 + (current.getMonth() - startDate.getMonth());
            // Simulate score growth over time
            const baseScore = Math.min(currentStats.score, monthsElapsed * 2);
            months.push({
                date: new Date(current),
                label: current.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }),
                score: Math.max(0, baseScore + Math.floor(Math.random() * 5 - 2))
            });
            current.setMonth(current.getMonth() + 1);
        }
        
        return months;
    }

    // Country indicator element
    const countryBar = (code) => `<div class="country-indicator h-full country-${code.toLowerCase()}"></div>`;

    // ============================================================================
    // CHARTS
    // ============================================================================

    let charts = {};
    const destroyCharts = () => { Object.values(charts).forEach(c => c?.destroy()); charts = {}; };

    function renderStatusChart(id, counts) {
        const ctx = document.getElementById(id);
        if (!ctx) return;
        charts[id] = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(counts).map(s => statusConfig[s].label),
                datasets: [{ data: Object.values(counts), backgroundColor: Object.keys(counts).map(s => statusConfig[s].chartColor), borderWidth: 0 }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: { legend: { position: 'bottom', labels: { padding: 12, usePointStyle: true, pointStyle: 'circle', font: { size: 11 } } } }
            }
        });
        removeSkeleton(id);
    }

    function renderCategoryChart(id, proms) {
        const ctx = document.getElementById(id);
        if (!ctx) return;
        const catCounts = {};
        Object.keys(PromiseCategory).forEach(c => catCounts[c] = 0);
        proms.forEach(p => catCounts[p.category]++);
        const filtered = Object.entries(catCounts).filter(([,v]) => v > 0).sort((a,b) => b[1] - a[1]);
        
        charts[id] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: filtered.map(([c]) => categoryConfig[c].label),
                datasets: [{ data: filtered.map(([,v]) => v), backgroundColor: filtered.map(([c]) => categoryConfig[c].color), borderRadius: 4, maxBarThickness: 28 }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true, ticks: { stepSize: 1 }, grid: { display: false } }, y: { grid: { display: false } } }
            }
        });
        removeSkeleton(id);
    }

    function removeSkeleton(id) {
        const el = document.getElementById(id);
        const skeleton = el?.parentElement?.querySelector('.chart-skeleton');
        if (skeleton) skeleton.remove();
    }

    function lazyRenderChart(id, renderFn) {
        const canvas = document.getElementById(id);
        if (!canvas) return;
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    renderFn();
                    observer.disconnect();
                }
            });
        }, { threshold: 0.2 });
        observer.observe(canvas);
    }

    // ============================================================================
    // PAGES
    // ============================================================================

    function renderHome() {
        // Show only tracked governments (Albania & Norway)
        const govs = db.actors.findMany({ where: { type: ActorType.GOVERNMENT } })
            .filter(g => ['albania', 'norway'].includes(g.slug))
            .sort((a, b) => (b.isCurrent === a.isCurrent) ? a.country.localeCompare(b.country) : (b.isCurrent ? 1 : -1));
        const all = db.promises.findMany();
        const kept = all.filter(p => p.status === PromiseStatus.KEPT).length;
        
        return `
        <div class="fade-in">
            <!-- Hero -->
            <section class="bg-white border-b border-gray-100">
                <div class="max-w-6xl mx-auto px-4 sm:px-6 py-16 md:py-24">
                    <div class="max-w-2xl">
                        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4 leading-tight">
                            Track what governments<br>promise and deliver
                        </h1>
                        <p class="text-gray-500 text-lg mb-8">
                            Following the 2025 parliamentary elections in Albania and Norway. Every promise documented, every action tracked.
                        </p>
                        <div class="flex flex-wrap gap-3">
                            <a href="#/governments" class="px-5 py-2.5 bg-gray-900 text-white text-sm font-medium rounded-lg hover:bg-gray-800 transition-base">
                                View Governments
                            </a>
                            <a href="#/compare" class="px-5 py-2.5 bg-white text-gray-700 text-sm font-medium rounded-lg border border-gray-200 hover:bg-gray-50 transition-base">
                                Compare
                            </a>
                        </div>
                    </div>
                    
                    <div class="mt-12 grid grid-cols-3 gap-6 max-w-md">
                        <div>
                            <div class="text-2xl font-bold text-gray-900">${all.length}</div>
                            <div class="text-sm text-gray-500">Promises</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-emerald-600">${kept}</div>
                            <div class="text-sm text-gray-500">Kept</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-gray-900">${govs.length}</div>
                            <div class="text-sm text-gray-500">Governments</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Countries -->
            <section class="max-w-6xl mx-auto px-4 sm:px-6 py-12">
                <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
                    <h2 class="text-lg font-semibold text-gray-900">Select a country</h2>
                    <span class="text-xs text-gray-400">${govs.length} countries tracked</span>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                    ${govs.map(actor => {
                        const stats = calcStats(db.promises.findMany({ where: { actorId: actor.id } }));
                        const termYears = `${actor.termStart.getFullYear()}‚Äì${actor.termEnd.getFullYear()}`;
                        const now = new Date();
                        const isNewTerm = (now - actor.termStart) < 90 * 24 * 60 * 60 * 1000; // Within 90 days
                        // Generate demo sentiment if needed
                        generateDemoSentiment(actor.slug);
                        const sentiment = getAggregateSentiment(actor.slug, 'overall');
                        const sentimentEmoji = sentiment.average >= 4 ? 'üòä' : sentiment.average >= 3 ? 'üôÇ' : sentiment.average >= 2 ? 'üòê' : 'üòï';
                        return `
                        <a href="#/country/${actor.slug}" class="group flex bg-white rounded-xl border border-gray-200 overflow-hidden hover:border-gray-300 hover:shadow-sm transition-base">
                            ${countryBar(actor.countryCode)}
                            <div class="flex-1 p-5">
                                <div class="flex items-start justify-between mb-3">
                                    <div>
                                        <div class="flex items-center gap-2 flex-wrap">
                                            <h3 class="font-semibold text-gray-900 group-hover:text-gray-700">${actor.country}</h3>
                                            ${isNewTerm ? '<span class="text-xs px-1.5 py-0.5 bg-blue-50 text-blue-600 rounded">New Term</span>' : ''}
                                        </div>
                                        <p class="text-sm text-gray-500">${actor.leader} ¬∑ ${actor.party}</p>
                                        <p class="text-xs text-gray-400 mt-0.5">${termYears} ¬∑ ${actor.coalitionType}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-semibold ${stats.score >= 50 ? 'text-emerald-600' : stats.score > 0 ? 'text-amber-600' : 'text-gray-400'}">${stats.score > 0 ? stats.score + '%' : '‚Äî'}</div>
                                        <div class="text-xs text-gray-400">${stats.score > 0 ? 'score' : 'tracking'}</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4 text-sm">
                                    <span class="text-gray-500">${stats.total} promises</span>
                                    <span class="text-blue-600">${stats.counts.NOT_STARTED} to track</span>
                                    ${stats.counts.KEPT > 0 ? `<span class="text-emerald-600">${stats.counts.KEPT} kept</span>` : ''}
                                    <span class="ml-auto flex items-center gap-1 text-gray-500" title="Citizen sentiment">
                                        <span>${sentimentEmoji}</span>
                                        <span class="text-xs">${sentiment.average.toFixed(1)}</span>
                                    </span>
                                </div>
                            </div>
                            <div class="flex items-center px-4 text-gray-300 group-hover:text-gray-400">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5l7 7-7 7"/></svg>
                            </div>
                        </a>`;
                    }).join('')}
                </div>
            </section>
            
            <!-- Quick Tools Section -->
            <section class="max-w-6xl mx-auto px-4 sm:px-6 py-12 border-t border-gray-100">
                <h2 class="text-lg font-semibold text-gray-900 mb-6">Explore Tools</h2>
                <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <a href="#/timeline" class="group p-5 bg-white rounded-xl border border-gray-200 hover:border-blue-300 hover:shadow-sm transition-base">
                        <div class="w-10 h-10 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center mb-3 group-hover:bg-blue-100 transition-base">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                        </div>
                        <h3 class="font-medium text-gray-900 mb-1">Timeline View</h3>
                        <p class="text-sm text-gray-500">See all promises on a visual timeline with deadlines</p>
                    </a>
                    
                    <a href="#/insights" class="group p-5 bg-white rounded-xl border border-gray-200 hover:border-emerald-300 hover:shadow-sm transition-base">
                        <div class="w-10 h-10 rounded-lg bg-emerald-50 text-emerald-600 flex items-center justify-center mb-3 group-hover:bg-emerald-100 transition-base">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                        </div>
                        <h3 class="font-medium text-gray-900 mb-1">Insights</h3>
                        <p class="text-sm text-gray-500">Analytics, trends, and category performance</p>
                    </a>
                    
                    <a href="#/compare" class="group p-5 bg-white rounded-xl border border-gray-200 hover:border-violet-300 hover:shadow-sm transition-base">
                        <div class="w-10 h-10 rounded-lg bg-violet-50 text-violet-600 flex items-center justify-center mb-3 group-hover:bg-violet-100 transition-base">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/></svg>
                        </div>
                        <h3 class="font-medium text-gray-900 mb-1">Compare</h3>
                        <p class="text-sm text-gray-500">Side-by-side comparison of governments</p>
                    </a>
                    
                    <a href="#/pulse" class="group p-5 bg-gradient-to-br from-yellow-600 to-amber-700 rounded-xl text-white hover:from-yellow-700 hover:to-amber-800 transition-base">
                        <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center mb-3">
                            <span class="text-xl">üó≥Ô∏è</span>
                        </div>
                        <h3 class="font-medium mb-1">Citizen Pulse</h3>
                        <p class="text-sm text-white/80">Rate government performance & see public sentiment</p>
                    </a>
                </div>
            </section>
            
            <!-- Recent Updates -->
            <section class="max-w-6xl mx-auto px-4 sm:px-6 py-12 border-t border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-semibold text-gray-900">Recent Updates</h2>
                    <a href="#/insights" class="text-sm text-gray-500 hover:text-gray-700 transition-base">View all ‚Üí</a>
                </div>
                <div class="grid md:grid-cols-3 gap-4">
                    ${evidence.slice(0, 3).map(e => {
                        const promise = promises.find(p => p.id === e.promiseId);
                        const actor = promise ? actors.find(a => a.id === promise.actorId) : null;
                        return `
                        <a href="#/promise/${e.promiseId}" class="block p-4 bg-white rounded-lg border border-gray-200 hover:border-gray-300 transition-base">
                            <div class="flex items-center gap-2 mb-2">
                                ${actor ? `<div class="w-1 h-4 rounded country-${actor.countryCode.toLowerCase()}"></div>` : ''}
                                <span class="text-xs text-gray-400">${formatDate(e.date)}</span>
                                ${e.verified ? '<span class="text-xs text-emerald-600">‚úì</span>' : ''}
                            </div>
                            <p class="text-sm text-gray-700 line-clamp-2 mb-2">${e.description}</p>
                            ${promise ? `<p class="text-xs text-blue-600 truncate">${promise.title}</p>` : ''}
                        </a>`;
                    }).join('')}
                </div>
            </section>
            
            <!-- Status Legend -->
            <section class="max-w-6xl mx-auto px-4 sm:px-6 py-12 border-t border-gray-100">
                <h2 class="text-lg font-semibold text-gray-900 mb-6">Status definitions</h2>
                <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    ${Object.entries(statusConfig).map(([k, v]) => `
                    <div class="flex items-center gap-3 p-3 rounded-lg bg-white border border-gray-100">
                        <div class="w-3 h-3 rounded-full" style="background: ${v.chartColor}"></div>
                        <span class="text-sm text-gray-700">${v.label}</span>
                    </div>`).join('')}
                </div>
            </section>
        </div>`;
    }

    function renderCountry(slug, termSlug = null) {
        const terms = db.actors.getTermsForCountry(slug);
        if (!terms.length) return renderNotFound();
        
        // Get the requested term or default to current
        const actor = termSlug 
            ? db.actors.findBySlugAndTerm(slug, termSlug)
            : db.actors.findCurrentBySlug(slug);
        
        if (!actor) return renderNotFound();
        
        const proms = db.promises.findMany({ where: { actorId: actor.id } });
        const stats = calcStats(proms);
        const momentumActor = calcMomentumForActor(actor.id);
        
        const now = new Date();
        const termTotal = daysBetween(actor.termStart, actor.termEnd);
        const termElapsed = Math.max(0, Math.min(daysBetween(actor.termStart, now), termTotal));
        const termPct = Math.min(100, Math.max(0, Math.round(termElapsed / termTotal * 100)));
        const daysRemaining = Math.max(0, daysBetween(now, actor.termEnd));
        const isCompleted = now > actor.termEnd;
        const isNewTerm = now < actor.termStart;
        
        return `
        <div class="fade-in">
            <!-- Header -->
            <section class="bg-white border-b border-gray-100">
                <div class="max-w-6xl mx-auto px-4 sm:px-6 py-8">
                    <div class="flex items-center justify-between mb-4">
                        <a href="#/governments" class="inline-flex items-center gap-1 text-sm text-gray-400 hover:text-gray-600 transition-base">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 19l-7-7 7-7"/></svg>
                            All governments
                        </a>
                        
                        <!-- Term Selector -->
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-400">Term:</span>
                            <div class="flex rounded-lg border border-gray-200 overflow-hidden">
                                ${terms.map(t => `
                                <a href="#/country/${slug}/${t.termSlug}" 
                                   class="px-3 py-1.5 text-sm font-medium transition-base ${t.termSlug === actor.termSlug 
                                       ? 'bg-gray-900 text-white' 
                                       : 'bg-white text-gray-600 hover:bg-gray-50'}">${t.termSlug}${t.isCurrent ? ' ‚óè' : ''}</a>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-start gap-4">
                        <div class="w-1 h-12 rounded country-${actor.countryCode.toLowerCase()}"></div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <h1 class="text-2xl font-bold text-gray-900">${actor.country}</h1>
                                ${isCompleted ? '<span class="text-xs px-2 py-0.5 bg-gray-100 text-gray-500 rounded">Completed Term</span>' : ''}
                                ${actor.isCurrent && !isCompleted ? '<span class="text-xs px-2 py-0.5 bg-emerald-50 text-emerald-600 rounded">Current Term</span>' : ''}
                            </div>
                            <p class="text-gray-500">${actor.leader}, ${actor.leaderTitle}</p>
                            <div class="flex flex-wrap gap-2 mt-2">
                                <span class="inline-block px-2 py-0.5 text-xs font-medium rounded bg-gray-100 text-gray-600">${actor.party}</span>
                                <span class="inline-block px-2 py-0.5 text-xs font-medium rounded bg-gray-100 text-gray-600">${actor.coalitionType}</span>
                                <span class="inline-block px-2 py-0.5 text-xs font-medium rounded bg-blue-50 text-blue-600">Parliament: ${actor.seats}</span>
                            </div>
                        </div>
                        <div class="text-right hidden sm:block">
                            <div class="text-2xl font-bold ${stats.score >= 50 ? 'text-emerald-600' : stats.score > 0 ? 'text-amber-600' : 'text-gray-400'}">${stats.score}%</div>
                            <div class="text-xs text-gray-400">accountability score</div>
                        </div>
                    </div>
                    
                    <!-- Achievements -->
                    ${renderBadges(actor.id)}
                </div>
            </section>
            
            <!-- Citizen Pulse Widget -->
            ${actor.isCurrent ? `
            <section class="max-w-6xl mx-auto px-4 sm:px-6 py-4">
                <div class="rounded-xl border border-yellow-100 bg-gradient-to-r from-yellow-50 to-amber-50 p-4 flex flex-wrap items-center gap-3">
                    <div class="flex-1 min-w-[200px]">
                        <div class="text-[13px] uppercase tracking-wide text-amber-700">Citizen Pulse</div>
                        <div class="text-base font-semibold text-gray-900">How are you feeling about this government?</div>
                        <div class="mt-2 hidden md:block" id="country-barometer-overall">
                            ${renderSentimentBarometer(actor.slug, 'overall', 'compact')}
                        </div>
                    </div>
                    <div class="flex items-center gap-2 flex-wrap">
                        ${(() => {
                            const voted = hasVotedToday(actor.slug, 'overall');
                            return sentimentEmojis.map(s => `
                            <button onclick="submitCountrySentiment('${actor.slug}', ${s.value})" 
                                class="emoji-btn text-xl ${voted ? 'opacity-50 cursor-not-allowed' : ''}" 
                                ${voted ? 'disabled' : ''}
                                title="${s.label}">
                                ${s.emoji}
                            </button>`).join('');
                        })()}
                    </div>
                    <div class="w-full md:w-auto flex-1 min-w-[240px]">
                        ${renderPollInline(actor.slug)}
                    </div>
                    <a href="#/pulse" class="text-sm text-amber-700 font-semibold">See details ‚Üí</a>
                </div>
            </section>` : ''}
            
            <!-- Stats -->
            <section class="max-w-6xl mx-auto px-4 sm:px-6 py-6">
                <div class="grid grid-cols-2 lg:grid-cols-5 gap-3">
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="text-2xl font-bold text-gray-900">${stats.total}</div>
                        <div class="text-sm text-gray-500">Total</div>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="text-2xl font-bold text-emerald-600">${stats.counts.KEPT}</div>
                        <div class="text-sm text-gray-500">Kept</div>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="text-2xl font-bold text-blue-600">${stats.counts.IN_THE_WORKS}</div>
                        <div class="text-sm text-gray-500">In Progress</div>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="text-2xl font-bold text-red-600">${stats.counts.BROKEN}</div>
                        <div class="text-sm text-gray-500">Broken</div>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4 col-span-2 lg:col-span-1">
                        <div class="text-2xl font-bold text-gray-900">${termPct}%</div>
                        <div class="text-sm text-gray-500">Term complete</div>
                    </div>
                </div>
                
                <!-- Momentum deltas -->
                <div class="grid grid-cols-3 gap-3 mt-3">
                    <div class="p-3 rounded-lg bg-emerald-50 text-emerald-700 text-center">
                        <div class="text-xl font-semibold">+${momentumActor.kept}</div>
                        <div class="text-xs">Kept (30d)</div>
                    </div>
                    <div class="p-3 rounded-lg bg-amber-50 text-amber-700 text-center">
                        <div class="text-xl font-semibold">+${momentumActor.stalled}</div>
                        <div class="text-xs">Stalled (30d)</div>
                    </div>
                    <div class="p-3 rounded-lg bg-red-50 text-red-700 text-center">
                        <div class="text-xl font-semibold">+${momentumActor.broken}</div>
                        <div class="text-xs">Broken (30d)</div>
                    </div>
                </div>
                
                <!-- Term progress -->
                <div class="mt-3 bg-white rounded-lg border border-gray-200 p-4">
                    <div class="flex items-center justify-between text-sm text-gray-500 mb-2">
                        <span>Electoral term ${actor.termSlug}</span>
                        <span>${formatDate(actor.termStart)} ‚Üí ${formatDate(actor.termEnd)}</span>
                    </div>
                    <div class="h-1.5 bg-gray-100 rounded-full overflow-hidden">
                        <div class="h-full ${isCompleted ? 'bg-gray-400' : 'bg-gray-900'} rounded-full transition-all" style="width: ${termPct}%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400 mt-2">
                        ${isCompleted 
                            ? `<span>Term completed</span><span>${termTotal} days total</span>`
                            : `<span>${termPct > 0 ? termElapsed + ' days elapsed' : 'Term starting soon'}</span><span>${daysRemaining} days remaining</span>`
                        }
                    </div>
                </div>
            </section>
            
            <!-- Digest, Watchlist & Poll -->
            <section class="max-w-6xl mx-auto px-4 sm:px-6 py-4">
                <div class="grid md:grid-cols-3 gap-4">
                    <div class="md:col-span-2 bg-white rounded-lg border border-gray-200 p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <div class="text-sm font-semibold text-gray-800">This Week</div>
                                <div class="text-xs text-gray-400">What changed</div>
                            </div>
                        </div>
                        ${renderWeeklyDigestCompact(actor.id)}
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <div class="text-sm font-semibold text-gray-800">Your Watchlist</div>
                                <div class="text-xs text-gray-400">Tracked promises</div>
                            </div>
                        </div>
                        ${renderWatchlist(actor.id)}
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4 md:col-span-3">
                        ${renderPoll(actor.slug)}
                    </div>
                </div>
            </section>
            
            <!-- Charts and Widgets -->
            <section class="max-w-6xl mx-auto px-4 sm:px-6 py-4">
                <div class="grid lg:grid-cols-3 gap-4">
                    <div class="bg-white rounded-lg border border-gray-200 p-5">
                        <h3 class="text-sm font-medium text-gray-700 mb-4">By status</h3>
                        <div class="chart-container relative">
                            <div class="chart-skeleton skeleton"></div>
                            <canvas id="status-chart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-5">
                        <h3 class="text-sm font-medium text-gray-700 mb-4">By category</h3>
                        <div class="chart-container relative">
                            <div class="chart-skeleton skeleton"></div>
                            <canvas id="category-chart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-5">
                        <h3 class="text-sm font-medium text-gray-700 mb-4">Citizen Priorities</h3>
                        <p class="text-xs text-gray-400 mb-3">Promises with the most votes from citizens</p>
                        ${(() => {
                            const votes = JSON.parse(localStorage.getItem('promiseVotes') || '{}');
                            const actorPromises = proms.map(p => ({ ...p, votes: votes[p.id] || 0 })).filter(p => p.votes > 0).sort((a, b) => b.votes - a.votes).slice(0, 4);
                            if (actorPromises.length === 0) {
                                return `<div class="text-center py-8 text-gray-400 text-sm">
                                    <svg class="w-8 h-8 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 15l7-7 7 7"/></svg>
                                    <p>No votes yet</p>
                                    <p class="text-xs mt-1">Click on a promise and vote!</p>
                                </div>`;
                            }
                            return `<div class="space-y-2">
                                ${actorPromises.map((p, i) => `
                                <a href="#/promise/${p.id}" class="flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50 transition-base">
                                    <span class="w-5 h-5 rounded-full ${i === 0 ? 'bg-amber-100 text-amber-600' : 'bg-gray-100 text-gray-500'} text-xs flex items-center justify-center font-medium">${i + 1}</span>
                                    <span class="text-sm text-gray-700 flex-1 truncate">${p.title}</span>
                                    <span class="text-xs text-gray-400">${p.votes}</span>
                                </a>`).join('')}
                            </div>`;
                        })()}
                    </div>
                </div>
            </section>
            
            <!-- Key Promises Spotlight -->
            ${proms.filter(p => p.importance === 'high').length > 0 ? `
            <section class="max-w-6xl mx-auto px-4 sm:px-6 py-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-semibold text-gray-900">Key Promises</h2>
                    <span class="text-xs text-amber-600">‚òÖ High importance</span>
                </div>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
                    ${proms.filter(p => p.importance === 'high').slice(0, 3).map(p => `
                    <a href="#/promise/${p.id}" class="spotlight-card block p-4 rounded-lg border border-gray-200 hover:border-gray-300 transition-base">
                        <div class="flex items-center gap-2 mb-2">
                            ${statusBadge(p.status)}
                            ${categoryBadge(p.category)}
                        </div>
                        <h3 class="font-medium text-gray-900 mb-1 line-clamp-2">${p.title}</h3>
                        <p class="text-xs text-gray-500">${p.timeline}</p>
                    </a>`).join('')}
                </div>
            </section>` : ''}
            
            <!-- Filters -->
            <section class="max-w-6xl mx-auto px-4 sm:px-6 py-4">
                <div class="flex flex-wrap gap-2" id="filters">
                    <button data-status="" class="filter-btn px-3 py-1.5 text-sm font-medium rounded-lg bg-gray-900 text-white">All</button>
                    ${Object.entries(statusConfig).map(([k, v]) => `
                    <button data-status="${k}" class="filter-btn px-3 py-1.5 text-sm font-medium rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition-base">${v.label}</button>
                    `).join('')}
                </div>
            </section>
            
            <!-- Promise List -->
            <section class="max-w-6xl mx-auto px-4 sm:px-6 py-4 pb-12">
                <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <div class="p-4 border-b border-gray-100 flex items-center justify-between gap-3">
                        <h3 class="font-medium text-gray-900">Promises</h3>
                        <div class="flex items-center gap-2 flex-wrap justify-end">
                            <input type="text" id="search" placeholder="Search..." class="px-3 py-1.5 text-sm border border-gray-200 rounded-lg w-48 focus:outline-none focus:ring-1 focus:ring-gray-300" aria-label="Search promises">
                            <button onclick="togglePrintMode()" id="print-view-btn" class="hidden sm:flex items-center gap-1.5 px-3 py-1.5 text-sm text-gray-500 bg-gray-100 rounded-lg hover:bg-gray-200 transition-base" title="Toggle print view">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 9V4a1 1 0 011-1h10a1 1 0 011 1v5M6 9h12M6 9H5a1 1 0 00-1 1v9a1 1 0 001 1h14a1 1 0 001-1v-9a1 1 0 00-1-1h-1m-6 4h.01"/></svg>
                                Print view
                            </button>
                            <button onclick="exportToCSV('${actor.id}')" class="export-btn hidden sm:flex items-center gap-1.5 px-3 py-1.5 text-sm text-gray-500 bg-gray-100 rounded-lg hover:bg-gray-200 transition-base" title="Export to CSV">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                                Export
                            </button>
                        </div>
                    </div>
                    <div id="promise-list" class="divide-y divide-gray-100">
                        ${proms.map(p => renderPromiseRow(p)).join('')}
                    </div>
                </div>
            </section>
            
            <!-- Community Discussion -->
            <section class="max-w-6xl mx-auto px-4 sm:px-6 pb-20">
                <div class="bg-gradient-to-br from-gray-50 to-white border border-gray-200 rounded-xl p-4 mb-4 text-xs text-gray-500">
                    Citizen conversation space. Posts are saved on your device only (no account needed). We'll sync across users in a future release.
                </div>
                <div id="discussion-${actor.slug}">
                    ${renderCountryDiscussionsContent(actor.slug)}
                </div>
            </section>
        </div>`;
    }

    function renderPromiseRow(p) {
        const ev = evidence.filter(e => e.promiseId === p.id).length;
        return `
        <div class="promise-row p-4 hover:bg-gray-50 transition-base" data-status="${p.status}" data-category="${p.category}">
            <div class="flex items-start justify-between gap-4">
                <div class="flex-1 min-w-0">
                    <div class="flex flex-wrap items-center gap-2 mb-1">
                        ${statusBadge(p.status)}
                        ${categoryBadge(p.category)}
                        ${p.importance === 'high' ? '<span class="text-[11px] px-2 py-0.5 rounded-full bg-amber-50 text-amber-700 border border-amber-100">High impact</span>' : p.importance === 'medium' ? '<span class="text-[11px] px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 border border-blue-100">Medium</span>' : '<span class="text-[11px] px-2 py-0.5 rounded-full bg-gray-50 text-gray-600 border border-gray-100">Standard</span>'}
                    </div>
                    <a href="#/promise/${p.id}" class="block font-medium text-gray-900 hover:text-gray-600 transition-base">${p.title}</a>
                    <div class="flex items-center gap-3 mt-1 text-xs text-gray-400">
                        <span>${p.timeline}</span>
                        ${ev ? `<span>${ev} evidence</span>` : ''}
                    </div>
                    <div class="flex items-center gap-2 text-xs text-gray-500 mt-1">
                        <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 8h16M4 16h16M4 12h8"/></svg>
                        <span class="text-gray-600">Source:</span>
                        <span class="text-gray-700">${p.sourceType || 'Not specified'}</span>
                        ${p.sourceLink ? `<a href="${p.sourceLink}" target="_blank" rel="noopener" class="text-blue-600 hover:text-blue-700 underline">Open</a>` : ''}
                    </div>
                    ${renderMiniTimeline(p.status)}
                    <div class="mt-2 mini-progress">
                        <div class="mini-progress-fill" style="width:${statusProgress(p.status)}%; background:${statusConfig[p.status].chartColor}"></div>
                    </div>
                </div>
                <button onclick="copyLink(location.origin + '#/promise/${p.id}')" class="p-2 text-gray-300 hover:text-gray-500 transition-base" title="Copy link">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                </button>
            </div>
            <div class="mt-2 text-xs text-blue-600">Last updated: ${formatDate(p.updatedAt)}</div>
        </div>`;
    }

    // Get vote count for a promise
    function getVotes(promiseId) {
        const votes = JSON.parse(localStorage.getItem('promiseVotes') || '{}');
        return votes[promiseId] || 0;
    }
    
    // Check if user has voted
    function hasVoted(promiseId) {
        const userVotes = JSON.parse(localStorage.getItem('userVotes') || '[]');
        return userVotes.includes(promiseId);
    }
    
    // Vote for a promise
    function voteForPromise(promiseId) {
        const votes = JSON.parse(localStorage.getItem('promiseVotes') || '{}');
        const userVotes = JSON.parse(localStorage.getItem('userVotes') || '[]');
        
        if (userVotes.includes(promiseId)) {
            // Remove vote
            votes[promiseId] = Math.max(0, (votes[promiseId] || 1) - 1);
            const idx = userVotes.indexOf(promiseId);
            userVotes.splice(idx, 1);
            showToast('Vote removed');
        } else {
            // Add vote
            votes[promiseId] = (votes[promiseId] || 0) + 1;
            userVotes.push(promiseId);
            showToast('Vote recorded! This promise will be prioritized.');
        }
        
        localStorage.setItem('promiseVotes', JSON.stringify(votes));
        localStorage.setItem('userVotes', JSON.stringify(userVotes));
        
        // Update button UI
        const btn = document.getElementById('vote-btn');
        if (btn) {
            const voted = hasVoted(promiseId);
            btn.className = `vote-btn inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg transition-base ${voted ? 'bg-emerald-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`;
            btn.innerHTML = `
                <svg class="w-4 h-4" fill="${voted ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg>
                ${voted ? 'Voted' : 'Vote'} ¬∑ ${getVotes(promiseId)}
            `;
        }
    }

    function renderPromiseDetail(id) {
        const p = db.promises.findUnique({ where: { id }, include: { evidence: true } });
        if (!p) return renderNotFound();
        
        const voted = hasVoted(id);
        const voteCount = getVotes(id);
        
        // Find related promises (same category, different promise)
        const related = promises
            .filter(pr => pr.category === p.category && pr.id !== p.id)
            .slice(0, 3);
        
        return `
        <div class="fade-in py-8">
            <div class="max-w-3xl mx-auto px-4 sm:px-6">
                <a href="#/country/${p.actor.slug}/${p.actor.termSlug}" class="inline-flex items-center gap-1 text-sm text-gray-400 hover:text-gray-600 mb-6 transition-base">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 19l-7-7 7-7"/></svg>
                    ${p.actor.country} ¬∑ ${p.actor.termSlug}
                </a>
                
                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                    <div class="p-6">
                        <div class="flex flex-wrap items-center gap-2 mb-3">
                            ${statusBadge(p.status)}
                            ${categoryBadge(p.category)}
                            ${p.importance === 'high' ? '<span class="text-xs text-amber-600 font-medium">‚òÖ Key Promise</span>' : ''}
                        </div>
                        
                        <h1 class="text-xl font-bold text-gray-900 mb-3">${p.title}</h1>
                        <div class="flex flex-wrap items-center gap-2 mb-4 text-xs text-gray-600">
                            <span class="px-2 py-0.5 rounded bg-gray-100 text-gray-700">Source: ${p.sourceType || 'Not specified'}</span>
                            ${p.sourceLink
                                ? `<a href="${p.sourceLink}" target="_blank" rel="noopener" class="text-blue-600 hover:text-blue-700 underline">Open link</a>`
                                : '<span class="text-gray-400">No link provided</span>'}
                        </div>
                        
                        <!-- Progress Tracker -->
                        ${renderProgressTracker(p.status)}
                        
                        <div class="grid sm:grid-cols-2 gap-3 mb-6">
                            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                <div class="w-1 h-8 rounded country-${p.actor.countryCode.toLowerCase()}"></div>
                                <div>
                                    <div class="text-xs text-gray-400">Government</div>
                                    <div class="text-sm text-gray-700">${p.actor.country}</div>
                                </div>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <div class="text-xs text-gray-400">Timeline</div>
                                <div class="text-sm text-gray-700">${p.timeline}</div>
                            </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                <div class="text-xs text-gray-400">Source</div>
                                <div class="flex items-center gap-2 text-sm text-gray-700">
                                    <span>${p.sourceType}</span>
                                    ${p.sourceLink ? `<a href="${p.sourceLink}" target="_blank" rel="noopener" class="text-blue-600 hover:text-blue-700 text-xs underline">Open</a>` : `<span class="text-gray-400 text-xs">No link provided</span>`}
                                </div>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <div class="text-xs text-gray-400">Last updated</div>
                                <div class="text-sm text-gray-700">${formatDate(p.updatedAt)}</div>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-gray-50 rounded-lg mb-6">
                            <div class="text-xs text-gray-400 mb-1">Full promise</div>
                            <p class="text-gray-700">${p.fullText}</p>
                        </div>
                        
                        <!-- Urgency indicator -->
                        ${(() => {
                            const urgency = getUrgencyLevel(p.timeline);
                            if (urgency === 'critical' && p.status !== 'KEPT' && p.status !== 'BROKEN') {
                                return `<div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-center gap-2">
                                    <span class="w-2 h-2 bg-red-500 rounded-full urgent"></span>
                                    <span class="text-sm text-red-700 font-medium">Deadline approaching! This promise was due by the timeline specified.</span>
                                </div>`;
                            }
                            return '';
                        })()}
                        
                        <!-- Action buttons -->
                        <div class="flex flex-wrap gap-3">
                            <button id="vote-btn" onclick="voteForPromise('${p.id}')" class="vote-btn inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg transition-base ${voted ? 'bg-emerald-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                                <svg class="w-4 h-4" fill="${voted ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg>
                                ${voted ? 'Voted' : 'Vote'} ¬∑ ${voteCount}
                            </button>
                            
                            <button onclick="openShareModal('${p.id}')" class="inline-flex items-center gap-2 px-4 py-2 text-sm text-gray-500 bg-gray-100 rounded-lg hover:bg-gray-200 transition-base">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                                Share
                            </button>
                            
                            <button id="alert-btn" onclick="toggleAlert('${p.id}')" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg transition-base ${hasAlert(p.id) ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                                <svg class="w-4 h-4" fill="${hasAlert(p.id) ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                                ${hasAlert(p.id) ? 'Watching' : 'Watch'}
                            </button>
                        </div>
                    </div>
                    
                    <!-- Evidence -->
                    <div class="border-t border-gray-100">
                        <div class="p-4 border-b border-gray-100">
                            <h2 class="font-medium text-gray-900">Evidence Timeline (${p.evidence?.length || 0})</h2>
                        </div>
                        ${p.evidence?.length ? `
                        <div class="p-4">
                            <div class="relative pl-6 border-l-2 border-gray-200 space-y-4">
                                ${p.evidence.map(e => `
                                <div class="relative">
                                    <div class="absolute -left-[25px] w-3 h-3 rounded-full ${e.verified ? 'bg-emerald-500' : 'bg-gray-300'} border-2 border-white"></div>
                                    <div class="p-3 bg-gray-50 rounded-lg">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-sm font-medium text-gray-700">${formatDate(e.date)}</span>
                                            ${e.verified 
                                                ? '<span class="text-xs px-1.5 py-0.5 bg-emerald-50 text-emerald-600 rounded" title="Verified: sourced from official or reputable documentation">‚úì Verified</span>' 
                                                : '<span class="text-xs px-1.5 py-0.5 bg-gray-100 text-gray-500 rounded" title="Unverified: awaiting confirmation or documentation">Unverified</span>'}
                                        </div>
                                        <p class="text-sm text-gray-600">${e.description}</p>
                                        ${e.sourceLink ? `<a href="${e.sourceLink}" target="_blank" rel="noopener" class="text-xs text-blue-600 hover:text-blue-700 underline">Source</a>` : ''}
                                    </div>
                                </div>`).join('')}
                            </div>
                        </div>` : `
                        <div class="p-8 text-center text-gray-400 text-sm">
                            <svg class="w-8 h-8 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            No evidence documented yet
                        </div>`}
                    </div>
                </div>
                
                <!-- News Sources Section -->
                ${renderNewsSources(p)}
                
                <!-- Related Promises -->
                ${related.length > 0 ? `
                <div class="mt-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Related Promises</h2>
                    <div class="grid gap-3">
                        ${related.map(rp => {
                            const rActor = actors.find(a => a.id === rp.actorId);
                            return `
                            <a href="#/promise/${rp.id}" class="flex items-center gap-4 p-4 bg-white rounded-lg border border-gray-200 hover:border-gray-300 transition-base">
                                <div class="w-1 h-10 rounded country-${rActor?.countryCode.toLowerCase()}"></div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-gray-900 truncate">${rp.title}</div>
                                    <div class="text-sm text-gray-500">${rActor?.country} ¬∑ ${rp.timeline}</div>
                                </div>
                                ${statusBadge(rp.status)}
                            </a>`;
                        }).join('')}
                    </div>
                </div>` : ''}
            </div>
        </div>`;
    }

    function renderGovernments() {
        // Only show tracked governments (Albania & Norway)
        const govs = db.actors.findMany({ where: { type: ActorType.GOVERNMENT } })
            .filter(g => ['albania', 'norway'].includes(g.slug))
            .sort((a, b) => (b.isCurrent === a.isCurrent) ? a.country.localeCompare(b.country) : (b.isCurrent ? 1 : -1));
        const currentGovs = govs.filter(g => g.isCurrent);
        const pastGovs = govs.filter(g => !g.isCurrent);
        
        const renderActorCard = (actor, showCurrentBadge = false) => {
            const stats = calcStats(db.promises.findMany({ where: { actorId: actor.id } }));
            const now = new Date();
            const isCompleted = now > actor.termEnd;
            return `
            <div class="flex bg-white rounded-xl border border-gray-200 overflow-hidden hover:border-gray-300 transition-base">
                ${countryBar(actor.countryCode)}
                <div class="flex-1 p-5">
                    <div class="flex flex-col md:flex-row md:items-center gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1 flex-wrap">
                                <h2 class="font-semibold text-gray-900">${actor.country}</h2>
                                <span class="text-xs px-1.5 py-0.5 bg-gray-100 text-gray-500 rounded">${actor.termSlug}</span>
                                ${showCurrentBadge && actor.isCurrent ? '<span class="text-xs px-1.5 py-0.5 bg-emerald-50 text-emerald-600 rounded">Current</span>' : ''}
                                ${isCompleted ? '<span class="text-xs px-1.5 py-0.5 bg-gray-100 text-gray-400 rounded">Completed</span>' : ''}
                            </div>
                            <p class="text-sm text-gray-500">${actor.leader} ¬∑ ${actor.party}</p>
                            <p class="text-xs text-gray-400 mt-1">${actor.coalitionType} ¬∑ ${actor.seats} seats</p>
                        </div>
                        <div class="flex items-center gap-6 text-sm">
                            <div class="text-center"><div class="font-semibold text-gray-900">${stats.total}</div><div class="text-xs text-gray-400">Promises</div></div>
                            <div class="text-center"><div class="font-semibold text-emerald-600">${stats.counts.KEPT}</div><div class="text-xs text-gray-400">Kept</div></div>
                            <div class="text-center"><div class="font-semibold ${stats.score >= 50 ? 'text-emerald-600' : stats.score > 0 ? 'text-amber-600' : 'text-gray-400'}">${stats.score > 0 ? stats.score + '%' : '‚Äî'}</div><div class="text-xs text-gray-400">${stats.score > 0 ? 'Score' : 'Tracking'}</div></div>
                        </div>
                        <a href="#/country/${actor.slug}/${actor.termSlug}" class="px-4 py-2 bg-gray-900 text-white text-sm font-medium rounded-lg hover:bg-gray-800 transition-base">
                            View Dashboard
                        </a>
                    </div>
                </div>
            </div>`;
        };
        
        return `
        <div class="fade-in py-8">
            <div class="max-w-6xl mx-auto px-4 sm:px-6">
                <h1 class="text-2xl font-bold text-gray-900 mb-2">Governments</h1>
                <p class="text-gray-500 mb-8">Tracking electoral promises by parliamentary term</p>
                
                <!-- Current Terms -->
                <div class="mb-8">
                    <h2 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">Current Terms</h2>
                    <div class="space-y-3">
                        ${currentGovs.map(actor => renderActorCard(actor, true)).join('')}
                    </div>
                </div>
                
                <!-- Previous Terms -->
                ${pastGovs.length > 0 ? `
                <div class="mb-8">
                    <h2 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-3">Previous Terms</h2>
                    <div class="space-y-3">
                        ${pastGovs.map(actor => renderActorCard(actor, false)).join('')}
                    </div>
                </div>` : ''}
                
                <div class="mt-8 p-4 bg-gray-50 rounded-lg border border-gray-100">
                    <p class="text-sm text-gray-500 text-center">
                        More countries coming soon. <a href="#/contact" class="text-gray-700 hover:underline">Suggest a country</a>
                    </p>
                </div>
            </div>
        </div>`;
    }

    function renderCompare() {
        const allGovs = db.actors.findMany({ where: { type: ActorType.GOVERNMENT } });
        const currentGovs = allGovs.filter(g => g.isCurrent);
        const pastGovs = allGovs.filter(g => !g.isCurrent);
        
        const renderComparisonTable = (govs, title, description) => {
            const data = govs.map(g => ({ actor: g, stats: calcStats(db.promises.findMany({ where: { actorId: g.id } })) }));
            const now = new Date();
            
            return `
            <div class="mb-8">
                <h2 class="text-lg font-semibold text-gray-900 mb-1">${title}</h2>
                <p class="text-sm text-gray-500 mb-4">${description}</p>
                <div class="bg-white rounded-xl border border-gray-200 overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-100 bg-gray-50">
                                <th class="text-left p-4 font-medium text-gray-500">Metric</th>
                                ${data.map(d => `
                                <th class="p-4 text-center min-w-[140px]">
                                    <div class="font-semibold text-gray-900">${d.actor.country}</div>
                                    <div class="text-xs text-gray-400 font-normal">${d.actor.termSlug}</div>
                                </th>`).join('')}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <tr class="bg-gray-50/50">
                                <td class="p-4 text-gray-500">Leader</td>
                                ${data.map(d => `<td class="p-4 text-center text-gray-700">${d.actor.leader}</td>`).join('')}
                            </tr>
                            <tr>
                                <td class="p-4 text-gray-500">Party</td>
                                ${data.map(d => `<td class="p-4 text-center text-gray-700">${d.actor.party}</td>`).join('')}
                            </tr>
                            <tr class="bg-gray-50/50">
                                <td class="p-4 text-gray-500">Government Type</td>
                                ${data.map(d => `<td class="p-4 text-center text-gray-700">${d.actor.coalitionType}</td>`).join('')}
                            </tr>
                            <tr>
                                <td class="p-4 text-gray-500">Parliament Seats</td>
                                ${data.map(d => `<td class="p-4 text-center text-gray-700">${d.actor.seats}</td>`).join('')}
                            </tr>
                            <tr class="bg-gray-50/50">
                                <td class="p-4 text-gray-500">Election Date</td>
                                ${data.map(d => `<td class="p-4 text-center text-gray-700">${formatDate(d.actor.electionDate)}</td>`).join('')}
                            </tr>
                            <tr class="border-t-2 border-gray-200">
                                <td class="p-4 text-gray-500 font-medium">Total Promises</td>
                                ${data.map(d => `<td class="p-4 text-center font-semibold text-gray-900">${d.stats.total}</td>`).join('')}
                            </tr>
                            <tr class="bg-gray-50/50">
                                <td class="p-4 text-gray-500">Not Started</td>
                                ${data.map(d => `<td class="p-4 text-center font-semibold text-gray-500">${d.stats.counts.NOT_STARTED}</td>`).join('')}
                            </tr>
                            <tr>
                                <td class="p-4 text-gray-500">In Progress</td>
                                ${data.map(d => `<td class="p-4 text-center font-semibold text-blue-600">${d.stats.counts.IN_THE_WORKS}</td>`).join('')}
                            </tr>
                            <tr class="bg-gray-50/50">
                                <td class="p-4 text-gray-500">Stalled</td>
                                ${data.map(d => `<td class="p-4 text-center font-semibold text-amber-600">${d.stats.counts.STALLED}</td>`).join('')}
                            </tr>
                            <tr>
                                <td class="p-4 text-gray-500">Compromise</td>
                                ${data.map(d => `<td class="p-4 text-center font-semibold text-violet-600">${d.stats.counts.COMPROMISE}</td>`).join('')}
                            </tr>
                            <tr class="bg-gray-50/50">
                                <td class="p-4 text-gray-500">Kept</td>
                                ${data.map(d => `<td class="p-4 text-center font-semibold text-emerald-600">${d.stats.counts.KEPT}</td>`).join('')}
                            </tr>
                            <tr>
                                <td class="p-4 text-gray-500">Broken</td>
                                ${data.map(d => `<td class="p-4 text-center font-semibold text-red-600">${d.stats.counts.BROKEN}</td>`).join('')}
                            </tr>
                            <tr class="border-t-2 border-gray-200 bg-gray-50">
                                <td class="p-4 text-gray-700 font-medium">Accountability Score</td>
                                ${data.map(d => `<td class="p-4 text-center font-bold text-lg ${d.stats.score >= 50 ? 'text-emerald-600' : d.stats.score > 0 ? 'text-amber-600' : 'text-gray-400'}">${d.stats.score > 0 ? d.stats.score + '%' : '‚Äî'}</td>`).join('')}
                            </tr>
                            <tr>
                                <td class="p-4"></td>
                                ${data.map(d => `<td class="p-4 text-center"><a href="#/country/${d.actor.slug}/${d.actor.termSlug}" class="inline-block px-3 py-1.5 bg-gray-900 text-white text-sm rounded-lg hover:bg-gray-800 transition-base">View</a></td>`).join('')}
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>`;
        };
        
        return `
        <div class="fade-in py-8">
            <div class="max-w-6xl mx-auto px-4 sm:px-6">
                <h1 class="text-2xl font-bold text-gray-900 mb-2">Compare Governments</h1>
                <p class="text-gray-500 mb-8">Side-by-side comparison of promise tracking across countries and terms</p>
                
                ${renderComparisonTable(currentGovs, 'Current Terms (2025‚Äì2029)', 'New governments tracking promises from the 2025 elections')}
                
                ${pastGovs.length > 0 ? renderComparisonTable(pastGovs, 'Previous Terms (2021‚Äì2025)', 'Completed terms with final accountability scores') : ''}
                
                <div class="p-4 bg-blue-50 rounded-lg border border-blue-100">
                    <p class="text-sm text-blue-700">
                        <strong>How to read the score:</strong> The accountability score is calculated based on kept promises (100%), compromises (50%), and in-progress items (30%). A higher score indicates better follow-through on electoral commitments.
                    </p>
                </div>
            </div>
        </div>`;
    }

    function renderSimplePage(title, content) {
        return `
        <div class="fade-in py-12">
            <div class="max-w-2xl mx-auto px-4 sm:px-6">
                <h1 class="text-2xl font-bold text-gray-900 mb-4">${title}</h1>
                <div class="text-gray-600 space-y-4">${content}</div>
                <a href="#/" class="inline-block mt-6 text-sm text-gray-400 hover:text-gray-600">‚Üê Back</a>
            </div>
        </div>`;
    }

    function renderAbout() {
        return renderSimplePage('About', '<p>PromiseTracker is a civic technology initiative dedicated to government accountability and transparency.</p><p>We track political promises from official sources and monitor them with verifiable evidence.</p>');
    }

    function renderMethodology() {
        return renderSimplePage('Methodology', '<p>We collect promises from official manifestos, speeches, and government programs.</p><p>Each promise is assigned a status based on official actions, legislation, and measurable outcomes.</p><p>All status changes are backed by documented evidence.</p>');
    }

    function renderContact() {
        return renderSimplePage('Contact', '<p>Email: contact@promisetracker.org</p>');
    }

    function renderNotFound() {
        return renderSimplePage('Not Found', '<p>The page you are looking for does not exist.</p>');
    }

    // ============================================================================
    // NEW TOOLS: TIMELINE VIEW
    // ============================================================================

    function renderTimeline() {
        const allPromises = db.promises.findMany();
        const currentGovs = db.actors.findMany({ where: { type: ActorType.GOVERNMENT } });
        
        // Group promises by year/quarter based on timeline
        const getTimelinePosition = (p) => {
            const match = p.timeline.match(/\d{4}/);
            if (match) return parseInt(match[0]);
            if (p.timeline.includes('2026')) return 2026;
            if (p.timeline.includes('2027')) return 2027;
            if (p.timeline.includes('2028')) return 2028;
            if (p.timeline.includes('2029')) return 2029;
            return 2027; // default middle
        };
        
        const years = [2025, 2026, 2027, 2028, 2029];
        const now = new Date();
        const currentYear = now.getFullYear();
        const yearProgress = (currentYear - 2025 + (now.getMonth() / 12)) / 4 * 100;
        
        return `
        <div class="fade-in py-8">
            <div class="max-w-6xl mx-auto px-4 sm:px-6">
                <h1 class="text-2xl font-bold text-gray-900 mb-2">Promise Timeline</h1>
                <p class="text-gray-500 mb-8">Visual overview of when promises are due across all governments</p>
                
                <!-- Timeline Legend -->
                <div class="flex flex-wrap gap-4 mb-8">
                    ${currentGovs.map(g => `
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full country-${g.countryCode.toLowerCase()}" style="background: ${g.countryCode === 'AL' ? '#E41E20' : g.countryCode === 'NO' ? '#BA0C2F' : '#9ca3af'}"></div>
                        <span class="text-sm text-gray-600">${g.country}</span>
                    </div>`).join('')}
                    <div class="flex items-center gap-2 ml-auto">
                        <div class="w-3 h-3 rounded-full bg-emerald-500"></div>
                        <span class="text-sm text-gray-600">Kept</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                        <span class="text-sm text-gray-600">In Progress</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-gray-400"></div>
                        <span class="text-sm text-gray-600">Not Started</span>
                    </div>
                </div>
                
                <!-- Main Timeline -->
                <div class="bg-white rounded-xl border border-gray-200 p-6 mb-6">
                    <div class="relative">
                        <!-- Year markers -->
                        <div class="flex justify-between mb-2">
                            ${years.map(y => `<span class="text-sm font-medium ${y === currentYear ? 'text-blue-600' : 'text-gray-400'}">${y}</span>`).join('')}
                        </div>
                        
                        <!-- Track -->
                        <div class="timeline-track mb-8">
                            <div class="timeline-progress" style="width: ${Math.min(100, Math.max(0, yearProgress))}%"></div>
                            <!-- Now marker -->
                            <div class="absolute top-1/2 transform -translate-y-1/2 w-0.5 h-6 bg-blue-600" style="left: ${Math.min(100, Math.max(0, yearProgress))}%">
                                <span class="absolute -top-6 left-1/2 -translate-x-1/2 text-xs text-blue-600 font-medium whitespace-nowrap">Now</span>
                            </div>
                        </div>
                        
                        <!-- Promise markers by country -->
                        ${currentGovs.map((g, gi) => {
                            const gPromises = allPromises.filter(p => p.actorId === g.id);
                            return `
                            <div class="mb-6">
                                <div class="flex items-center gap-2 mb-3">
                                    <div class="w-1 h-4 rounded country-${g.countryCode.toLowerCase()}"></div>
                                    <span class="text-sm font-medium text-gray-700">${g.country}</span>
                                    <span class="text-xs text-gray-400">(${gPromises.length} promises)</span>
                                </div>
                                <div class="relative h-8 bg-gray-50 rounded">
                                    ${gPromises.map((p, i) => {
                                        const year = getTimelinePosition(p);
                                        const pos = ((year - 2025) / 4) * 100;
                                        const color = p.status === 'KEPT' ? '#10b981' : p.status === 'IN_THE_WORKS' ? '#3b82f6' : p.status === 'BROKEN' ? '#ef4444' : '#9ca3af';
                                        const offset = (i % 3 - 1) * 8; // Stagger overlapping markers
                                        return `
                                        <a href="#/promise/${p.id}" class="timeline-marker" style="left: ${pos}%; background: ${color}; top: calc(50% + ${offset}px)">
                                            <div class="timeline-tooltip">
                                                <div class="font-medium">${p.title.substring(0, 40)}${p.title.length > 40 ? '...' : ''}</div>
                                                <div class="text-gray-300">${p.timeline} ¬∑ ${statusConfig[p.status].label}</div>
                                            </div>
                                        </a>`;
                                    }).join('')}
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
                
                <!-- Upcoming Deadlines -->
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Upcoming Deadlines</h2>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${allPromises
                        .filter(p => p.status === 'NOT_STARTED' || p.status === 'IN_THE_WORKS')
                        .sort((a, b) => getTimelinePosition(a) - getTimelinePosition(b))
                        .slice(0, 6)
                        .map(p => {
                            const actor = actors.find(a => a.id === p.actorId);
                            return `
                            <a href="#/promise/${p.id}" class="block bg-white rounded-lg border border-gray-200 p-4 hover:border-gray-300 transition-base">
                                <div class="flex items-start gap-3">
                                    <div class="w-1 h-full min-h-[40px] rounded country-${actor?.countryCode.toLowerCase()}"></div>
                                    <div class="flex-1 min-w-0">
                                        <div class="text-xs text-gray-400 mb-1">${p.timeline}</div>
                                        <div class="font-medium text-gray-900 text-sm truncate">${p.title}</div>
                                        <div class="flex items-center gap-2 mt-2">
                                            ${statusBadge(p.status)}
                                            <span class="text-xs text-gray-400">${actor?.country}</span>
                                        </div>
                                    </div>
                                </div>
                            </a>`;
                        }).join('')}
                </div>
            </div>
        </div>`;
    }

    // ============================================================================
    // NEW TOOLS: INSIGHTS & ANALYTICS
    // ============================================================================

    function getCategoryStatusHeatmap() {
        const heatmap = {};
        Object.keys(PromiseCategory).forEach(cat => {
            heatmap[cat] = { ...Object.keys(PromiseStatus).reduce((acc, s) => ({ ...acc, [s]: 0 }), {}) };
        });
        promises.forEach(p => {
            if (!heatmap[p.category]) return;
            heatmap[p.category][p.status] += 1;
        });
        return heatmap;
    }

    function getRecentEvidenceSummary(days = 30) {
        const cutoff = Date.now() - days * 24 * 60 * 60 * 1000;
        const recent = evidence.filter(e => new Date(e.date).getTime() >= cutoff);
        const verified = recent.filter(e => e.verified).length;
        const avgAge = recent.length
            ? Math.round(recent.reduce((sum, e) => sum + (Date.now() - new Date(e.date).getTime()), 0) / recent.length / 86400000)
            : 0;
        return { count: recent.length, verified, avgAge };
    }

    function renderInsights() {
        const allGovs = db.actors.findMany({ where: { type: ActorType.GOVERNMENT } });
        const currentGovs = allGovs.filter(g => g.isCurrent);
        const pastGovs = allGovs.filter(g => !g.isCurrent);
        const heatmap = getCategoryStatusHeatmap();
        const recentEvidenceSummary = getRecentEvidenceSummary();
        const momentum = calcMomentum(promises);
        
        // Calculate category performance across all governments
        const categoryPerformance = {};
        Object.keys(PromiseCategory).forEach(cat => {
            const catPromises = promises.filter(p => p.category === cat);
            if (catPromises.length > 0) {
                const kept = catPromises.filter(p => p.status === 'KEPT').length;
                const broken = catPromises.filter(p => p.status === 'BROKEN').length;
                categoryPerformance[cat] = {
                    total: catPromises.length,
                    kept,
                    broken,
                    rate: Math.round((kept / catPromises.length) * 100)
                };
            }
        });
        
        // Get priority promises (user votes from localStorage)
        const votes = JSON.parse(localStorage.getItem('promiseVotes') || '{}');
        const topVoted = Object.entries(votes)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .map(([id]) => promises.find(p => p.id === id))
            .filter(Boolean);
        
        // Recent activity (evidence)
        const recentEvidence = evidence
            .sort((a, b) => new Date(b.date) - new Date(a.date))
            .slice(0, 5);
        
        return `
        <div class="fade-in py-8">
            <div class="max-w-6xl mx-auto px-4 sm:px-6">
                <h1 class="text-2xl font-bold text-gray-900 mb-2">Insights & Analytics</h1>
                <p class="text-gray-500 mb-8">Deep dive into promise tracking patterns and citizen priorities</p>
                
                <div class="grid lg:grid-cols-3 gap-6">
                    <!-- Left Column -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Category Performance -->
                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Performance by Category</h2>
                            <p class="text-sm text-gray-500 mb-4">How well are promises kept across different policy areas?</p>
                            <div class="radar-container relative">
                                <div class="chart-skeleton skeleton"></div>
                                <canvas id="radar-chart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Category Breakdown Table -->
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                            <div class="p-4 border-b border-gray-100">
                                <h2 class="font-semibold text-gray-900">Category Breakdown</h2>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="text-left p-3 font-medium text-gray-500">Category</th>
                                            <th class="text-center p-3 font-medium text-gray-500">Total</th>
                                            <th class="text-center p-3 font-medium text-gray-500">Kept</th>
                                            <th class="text-center p-3 font-medium text-gray-500">Broken</th>
                                            <th class="text-right p-3 font-medium text-gray-500">Success Rate</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-100">
                                        ${Object.entries(categoryPerformance)
                                            .sort((a, b) => b[1].rate - a[1].rate)
                                            .map(([cat, data]) => `
                                            <tr class="hover:bg-gray-50">
                                                <td class="p-3">
                                                    <div class="flex items-center gap-2">
                                                        <div class="w-2 h-2 rounded-full" style="background: ${categoryConfig[cat].color}"></div>
                                                        ${categoryConfig[cat].label}
                                                    </div>
                                                </td>
                                                <td class="p-3 text-center text-gray-600">${data.total}</td>
                                                <td class="p-3 text-center text-emerald-600">${data.kept}</td>
                                                <td class="p-3 text-center text-red-600">${data.broken}</td>
                                                <td class="p-3 text-right">
                                                    <div class="flex items-center justify-end gap-2">
                                                        <div class="w-16 h-1.5 bg-gray-100 rounded-full overflow-hidden">
                                                            <div class="h-full bg-emerald-500 rounded-full" style="width: ${data.rate}%"></div>
                                                        </div>
                                                        <span class="text-gray-700 font-medium w-10 text-right">${data.rate}%</span>
                                                    </div>
                                                </td>
                                            </tr>`).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Status Heatmap -->
                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-2">
                                <h2 class="text-lg font-semibold text-gray-900">Category Heatmap</h2>
                                <span class="text-xs text-gray-400">Activity by status and category</span>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="text-left p-3 font-medium text-gray-500">Category</th>
                                            ${Object.keys(PromiseStatus).map(s => `<th class="text-center p-3 font-medium text-gray-500">${statusConfig[s].label}</th>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-100">
                                        ${Object.entries(heatmap).map(([cat, statuses]) => {
                                            return `
                                            <tr class="hover:bg-gray-50">
                                                <td class="p-3">
                                                    <div class="flex items-center gap-2">
                                                        <div class="w-2 h-2 rounded-full" style="background: ${categoryConfig[cat].color}"></div>
                                                        ${categoryConfig[cat].label}
                                                    </div>
                                                </td>
                                                ${Object.keys(PromiseStatus).map(s => {
                                                    const val = statuses[s];
                                                    const max = Math.max(...Object.values(statuses));
                                                    const bgOpacity = max ? Math.min(0.8, 0.2 + (val / max) * 0.6) : 0.2;
                                                    return `<td class="p-3 text-center">
                                                        <span class="inline-flex items-center justify-center min-w-[34px] px-2 py-1 rounded text-xs"
                                                            style="background: ${statusConfig[s].chartColor}${Math.round(bgOpacity * 255).toString(16).padStart(2,'0')}; color:${statusConfig[s].chartColor}; opacity:${val === 0 ? 0.4 : 1};">
                                                            ${val}
                                                        </span>
                                                    </td>`;
                                                }).join('')}
                                            </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Momentum Snapshot -->
                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-3">
                                <h2 class="text-lg font-semibold text-gray-900">Last 30 Days</h2>
                                <span class="text-xs text-gray-400">Momentum</span>
                            </div>
                            <div class="grid grid-cols-3 gap-3 text-center">
                                <div class="p-3 rounded-lg bg-emerald-50">
                                    <div class="text-2xl font-bold text-emerald-700">+${momentum.kept}</div>
                                    <div class="text-xs text-emerald-700">Kept</div>
                                </div>
                                <div class="p-3 rounded-lg bg-amber-50">
                                    <div class="text-2xl font-bold text-amber-700">+${momentum.stalled}</div>
                                    <div class="text-xs text-amber-700">Stalled</div>
                                </div>
                                <div class="p-3 rounded-lg bg-red-50">
                                    <div class="text-2xl font-bold text-red-700">+${momentum.broken}</div>
                                    <div class="text-xs text-red-700">Broken</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Score Trend Chart -->
                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Score Trends Over Time</h2>
                            <p class="text-sm text-gray-500 mb-4">How accountability scores have evolved since term start</p>
                            <div class="chart-container relative">
                                <div class="chart-skeleton skeleton"></div>
                                <canvas id="trend-chart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Historical Comparison -->
                        ${pastGovs.length > 0 ? `
                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Term Comparison</h2>
                            <p class="text-sm text-gray-500 mb-4">How do current terms compare to previous ones?</p>
                            <div class="chart-container relative">
                                <div class="chart-skeleton skeleton"></div>
                                <canvas id="comparison-chart"></canvas>
                            </div>
                        </div>` : ''}
                    </div>
                    
                    <!-- Right Column -->
                    <div class="space-y-6">
                        <!-- Citizen Priorities -->
                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="font-semibold text-gray-900">Citizen Priorities</h2>
                                <span class="text-xs text-gray-400">Vote on promises</span>
                            </div>
                            <p class="text-sm text-gray-500 mb-4">What matters most to you? Vote for promises you want tracked closely.</p>
                            
                            ${topVoted.length > 0 ? `
                            <div class="space-y-2 mb-4">
                                <div class="text-xs text-gray-400 uppercase tracking-wide">Top Voted</div>
                                ${topVoted.map((p, i) => `
                                <a href="#/promise/${p.id}" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 transition-base">
                                    <span class="w-5 h-5 rounded-full bg-amber-100 text-amber-600 text-xs flex items-center justify-center font-medium">${i + 1}</span>
                                    <span class="text-sm text-gray-700 flex-1 truncate">${p.title}</span>
                                    <span class="text-xs text-gray-400">${votes[p.id]} votes</span>
                                </a>`).join('')}
                            </div>` : `
                            <div class="text-center py-6 text-gray-400 text-sm">
                                <p>No votes yet. Visit promise pages to vote!</p>
                            </div>`}
                            
                            <a href="#/governments" class="block text-center text-sm text-blue-600 hover:text-blue-700 transition-base">
                                Browse promises to vote ‚Üí
                            </a>
                        </div>

                        <!-- Weekly Digest -->
                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="font-semibold text-gray-900">This Week</h2>
                                <span class="text-xs text-gray-400">What changed</span>
                            </div>
                            ${renderWeeklyDigest(currentGovs[0]?.id || actors[0]?.id || '')}
                        </div>
                        
                        <!-- Recent Activity -->
                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                            <h2 class="font-semibold text-gray-900 mb-4">Recent Activity</h2>
                            <div class="space-y-3">
                                ${recentEvidence.map(e => {
                                    const promise = promises.find(p => p.id === e.promiseId);
                                    return `
                                    <a href="#/promise/${e.promiseId}" class="block p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-base">
                                        <div class="text-xs text-gray-400 mb-1">${formatDate(e.date)}</div>
                                        <div class="text-sm text-gray-700 line-clamp-2">${e.description}</div>
                                        ${promise ? `<div class="text-xs text-blue-600 mt-1 truncate">${promise.title}</div>` : ''}
                                    </a>`;
                                }).join('')}
                            </div>
                        </div>

                        <!-- Citizen Poll -->
                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-3">
                                <h2 class="font-semibold text-gray-900">Citizen Poll</h2>
                                <span class="text-xs text-gray-400">One-question pulse</span>
                            </div>
                            ${renderPoll(currentGovs[0]?.slug || actors[0]?.slug || 'albania')}
                        </div>
                        
                        <!-- Quick Stats -->
                        <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-xl p-6 text-white">
                            <h2 class="font-semibold mb-4">Quick Stats</h2>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="text-2xl font-bold">${promises.length}</div>
                                    <div class="text-xs text-gray-400">Total Promises</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold">${allGovs.length}</div>
                                    <div class="text-xs text-gray-400">Terms Tracked</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-emerald-400">${promises.filter(p => p.status === 'KEPT').length}</div>
                                    <div class="text-xs text-gray-400">Promises Kept</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold">${evidence.length}</div>
                                    <div class="text-xs text-gray-400">Evidence Items</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-amber-300">${calcMomentum(promises).kept - calcMomentum(promises).broken}</div>
                                    <div class="text-xs text-amber-100">30d momentum (kept - broken)</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-blue-200">${Math.max(...actors.map(a => calcStats(promises.filter(p => p.actorId === a.id)).score || 0))}%</div>
                                    <div class="text-xs text-gray-300">Top Accountability Score</div>
                                </div>
                            </div>
                        </div>

                        <!-- Evidence Summary -->
                        <div class="bg-white rounded-xl border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="font-semibold text-gray-900">Evidence Summary</h2>
                                <span class="text-xs text-gray-400">Last 30 days</span>
                            </div>
                            <div class="grid grid-cols-3 gap-3 text-center">
                                <div class="p-3 rounded-lg bg-gray-50">
                                    <div class="text-2xl font-bold text-gray-900">${recentEvidenceSummary.count}</div>
                                    <div class="text-xs text-gray-500">New items</div>
                                </div>
                                <div class="p-3 rounded-lg bg-emerald-50">
                                    <div class="text-2xl font-bold text-emerald-700">${recentEvidenceSummary.verified}</div>
                                    <div class="text-xs text-emerald-700">Verified</div>
                                </div>
                                <div class="p-3 rounded-lg bg-gray-50">
                                    <div class="text-2xl font-bold text-gray-900">${recentEvidenceSummary.avgAge}d</div>
                                    <div class="text-xs text-gray-500">Avg age</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Urgent Deadlines -->
                        ${(() => {
                            const urgent = getUpcomingDeadlines(365);
                            if (urgent.length === 0) return '';
                            return `
                            <div class="bg-white rounded-xl border border-gray-200 p-6">
                                <div class="flex items-center gap-2 mb-4">
                                    <span class="w-2 h-2 bg-red-500 rounded-full urgent"></span>
                                    <h2 class="font-semibold text-gray-900">Upcoming Deadlines</h2>
                                </div>
                                <div class="space-y-2">
                                    ${urgent.slice(0, 4).map(p => {
                                        const actor = actors.find(a => a.id === p.actorId);
                                        return `
                                        <a href="#/promise/${p.id}" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 transition-base">
                                            <div class="w-1 h-8 rounded country-${actor?.countryCode.toLowerCase()}"></div>
                                            <div class="flex-1 min-w-0">
                                                <div class="text-sm text-gray-900 truncate">${p.title}</div>
                                                <div class="text-xs text-gray-500">${p.timeline}</div>
                                            </div>
                                            <span class="px-2 py-0.5 text-xs rounded ${p.urgency === 'critical' ? 'bg-red-100 text-red-600' : p.urgency === 'high' ? 'bg-amber-100 text-amber-600' : 'bg-blue-100 text-blue-600'}">${p.urgency}</span>
                                        </a>`;
                                    }).join('')}
                                </div>
                            </div>`;
                        })()}
                        
                        <!-- Your Alerts -->
                        ${(() => {
                            const alerts = getAlerts();
                            const watchedPromises = promises.filter(p => alerts.includes(p.id));
                            if (watchedPromises.length === 0) return '';
                            return `
                            <div class="bg-white rounded-xl border border-gray-200 p-6">
                                <div class="flex items-center gap-2 mb-4">
                                    <svg class="w-4 h-4 text-amber-500" fill="currentColor" viewBox="0 0 24 24"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                                    <h2 class="font-semibold text-gray-900">Your Watchlist</h2>
                                </div>
                                <div class="space-y-2">
                                    ${watchedPromises.slice(0, 4).map(p => {
                                        const actor = actors.find(a => a.id === p.actorId);
                                        return `
                                        <a href="#/promise/${p.id}" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 transition-base">
                                            <div class="w-1 h-8 rounded country-${actor?.countryCode.toLowerCase()}"></div>
                                            <div class="flex-1 min-w-0">
                                                <div class="text-sm text-gray-900 truncate">${p.title}</div>
                                            </div>
                                            ${statusBadge(p.status)}
                                        </a>`;
                                    }).join('')}
                                </div>
                            </div>`;
                        })()}
                        
                        <!-- Export All Data -->
                        <button onclick="exportToCSV()" class="w-full flex items-center justify-center gap-2 p-4 bg-gray-100 rounded-xl hover:bg-gray-200 transition-base">
                            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                            <span class="text-sm font-medium text-gray-700">Export All Data (CSV)</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>`;
    }
    
    function initInsightsPage() {
        // Radar Chart for category performance (lazy render)
        const radarCtx = document.getElementById('radar-chart');
        if (radarCtx) {
            const renderRadar = () => {
                const categoryPerformance = {};
                Object.keys(PromiseCategory).forEach(cat => {
                    const catPromises = promises.filter(p => p.category === cat);
                    if (catPromises.length > 0) {
                        const kept = catPromises.filter(p => p.status === 'KEPT').length;
                        categoryPerformance[cat] = Math.round((kept / catPromises.length) * 100);
                    }
                });
                const labels = Object.keys(categoryPerformance).map(c => categoryConfig[c].label);
                const data = Object.values(categoryPerformance);
                if (charts['radar-chart']) charts['radar-chart'].destroy();
                charts['radar-chart'] = new Chart(radarCtx, {
                    type: 'radar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Success Rate %',
                            data,
                            backgroundColor: 'rgba(16, 185, 129, 0.2)',
                            borderColor: '#10b981',
                            pointBackgroundColor: '#10b981',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: '#10b981'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: { beginAtZero: true, max: 100, ticks: { stepSize: 25 } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
                removeSkeleton('radar-chart');
            };
            lazyRenderChart('radar-chart', renderRadar);
        }

        // Comparison chart (lazy render)
        const compCtx = document.getElementById('comparison-chart');
        if (compCtx) {
            const renderComparison = () => {
                const currentGovs = actors.filter(a => a.isCurrent);
                const pastGovs = actors.filter(a => !a.isCurrent);
                const getScore = (actorId) => {
                    const proms = promises.filter(p => p.actorId === actorId);
                    return calcStats(proms).score;
                };
                if (charts['comparison-chart']) charts['comparison-chart'].destroy();
                charts['comparison-chart'] = new Chart(compCtx, {
                    type: 'bar',
                    data: {
                        labels: [...new Set(actors.map(a => a.country))],
                        datasets: [
                            {
                                label: 'Previous Term',
                                data: [...new Set(actors.map(a => a.country))].map(country => {
                                    const past = pastGovs.find(g => g.country === country);
                                    return past ? getScore(past.id) : 0;
                                }),
                                backgroundColor: '#9ca3af'
                            },
                            {
                                label: 'Current Term',
                                data: [...new Set(actors.map(a => a.country))].map(country => {
                                    const current = currentGovs.find(g => g.country === country);
                                    return current ? getScore(current.id) : 0;
                                }),
                                backgroundColor: '#3b82f6'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } },
                        scales: { y: { beginAtZero: true, max: 100 } }
                    }
                });
                removeSkeleton('comparison-chart');
            };
            lazyRenderChart('comparison-chart', renderComparison);
        }

        // Trend chart already lazy-rendered via lazyRenderChart in other sections
        // Trend chart here: ensure lazy render too
        const trendCtx = document.getElementById('trend-chart');
        if (trendCtx) {
            const renderTrendChart = () => {
                const trendData = actors.filter(a => a.isCurrent).map(actor => {
                    return { actor, data: getScoreTrend(actor.id) };
                });
                if (charts['trend-chart']) charts['trend-chart'].destroy();
                charts['trend-chart'] = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: trendData[0]?.data.map(d => d.label) || [],
                        datasets: trendData.map((td, idx) => ({
                            label: td.actor.country,
                            data: td.data.map(d => d.score),
                            borderColor: idx === 0 ? '#3b82f6' : '#10b981',
                            backgroundColor: 'transparent',
                            tension: 0.35,
                            pointRadius: 2,
                            borderWidth: 2
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: true, position: 'bottom' } },
                        scales: {
                            y: { beginAtZero: true, max: 100, grid: { color: '#f3f4f6' } },
                            x: { grid: { display: false } }
                        }
                    }
                });
                removeSkeleton('trend-chart');
            };
            lazyRenderChart('trend-chart', renderTrendChart);
        }
    }

    // ============================================================================
    // ROUTER
    // ============================================================================

    const routes = {
        '/': renderHome,
        '/governments': renderGovernments,
        '/compare': renderCompare,
        '/timeline': renderTimeline,
        '/insights': renderInsights,
        '/pulse': renderCitizenPulse,
        '/about': renderAbout,
        '/methodology': renderMethodology,
        '/contact': renderContact
    };

    function router() {
        const hash = location.hash.slice(1) || '/';
        const app = document.getElementById('app');
        destroyCharts();
        
        if (hash.startsWith('/country/')) {
            const parts = hash.split('/');
            const slug = parts[2];
            const termSlug = parts[3] || null;
            app.innerHTML = renderCountry(slug, termSlug);
            initCountryPage();
        } else if (hash.startsWith('/promise/')) {
            app.innerHTML = renderPromiseDetail(hash.split('/')[2]);
        } else if (hash === '/insights') {
            app.innerHTML = renderInsights();
            initInsightsPage();
        } else if (hash === '/pulse') {
            app.innerHTML = renderCitizenPulse();
            const currentGovs = db.actors.findMany({ where: { type: ActorType.GOVERNMENT, isCurrent: true } });
            if (currentGovs.length > 0) initPulseCharts(currentGovs[0].slug);
        } else {
            app.innerHTML = routes[hash]?.() || renderNotFound();
        }
        
        scrollTo(0, 0);
    }

    function initCountryPage() {
        setTimeout(() => {
            const parts = location.hash.split('/');
            const slug = parts[2];
            const termSlug = parts[3] || null;
            
            // Find the correct actor based on slug and term
            const actor = termSlug 
                ? db.actors.findBySlugAndTerm(slug, termSlug)
                : db.actors.findCurrentBySlug(slug);
            
            if (!actor) return;
            
            const proms = db.promises.findMany({ where: { actorId: actor.id } });
            const stats = calcStats(proms);
            
            // Lazy render charts
            lazyRenderChart('status-chart', () => renderStatusChart('status-chart', stats.counts));
            lazyRenderChart('category-chart', () => renderCategoryChart('category-chart', proms));
        }, 50);
        
        // Filters
        let activeStatus = '';
        document.getElementById('filters')?.addEventListener('click', e => {
            const btn = e.target.closest('.filter-btn');
            if (!btn) return;
            activeStatus = btn.dataset.status;
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.className = b.dataset.status === activeStatus || (!activeStatus && b.dataset.status === '')
                    ? 'filter-btn px-3 py-1.5 text-sm font-medium rounded-lg bg-gray-900 text-white'
                    : 'filter-btn px-3 py-1.5 text-sm font-medium rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 transition-base';
            });
            filterRows();
        });
        
        // Search
        document.getElementById('search')?.addEventListener('input', filterRows);
        
        function filterRows() {
            const q = document.getElementById('search')?.value.toLowerCase() || '';
            document.querySelectorAll('.promise-row').forEach(row => {
                const matchStatus = !activeStatus || row.dataset.status === activeStatus;
                const matchSearch = row.textContent.toLowerCase().includes(q);
                row.style.display = matchStatus && matchSearch ? '' : 'none';
            });
        }
    }

    // ============================================================================
    // INIT
    // ============================================================================

    document.getElementById('mobile-menu-btn').addEventListener('click', () => {
        const menu = document.getElementById('mobile-menu');
        menu.style.maxHeight = menu.style.maxHeight ? '' : '200px';
    });

    // Global search keyboard shortcut
    document.addEventListener('keydown', (e) => {
        // Ctrl+K or Cmd+K to open search
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            openSearchModal();
        }
        // ESC to close modals and exit print mode
        if (e.key === 'Escape') {
            closeSearchModal();
            closeShareModal();
            if (document.body.classList.contains('print-mode')) setPrintMode(false);
        }
        // Ctrl/Cmd+P to trigger print mode gracefully
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'p') {
            e.preventDefault();
            setPrintMode(true);
            setTimeout(() => window.print(), 100);
        }
    });

    // Global search input handler
    document.getElementById('global-search-input')?.addEventListener('input', (e) => {
        const results = document.getElementById('search-results');
        results.innerHTML = performGlobalSearch(e.target.value);
    });

    // Close modals when clicking backdrop
    document.getElementById('search-modal')?.addEventListener('click', (e) => {
        if (e.target.id === 'search-modal') closeSearchModal();
    });
    document.getElementById('share-modal')?.addEventListener('click', (e) => {
        if (e.target.id === 'share-modal') closeShareModal();
    });

    window.addEventListener('hashchange', router);
    router();
    </script>
</body>
</html>
